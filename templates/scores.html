<!DOCTYPE html>
<html lang="fr">
<head>
  <link rel="manifest" href="/static/manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="BabyFoot">
  <link rel="apple-touch-icon" href="/static/images/logo.svg">
  <meta charset="UTF-8">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scores ‚Äî Baby-Foot Club</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='responsive-mobile.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='style-extended.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='global-animations.css') }}">
  <script src="{{ url_for('static', filename='global-animations.js') }}" defer></script>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
</head>
<body style="font-family: 'DM Sans', sans-serif;">

<nav class="nav nav-glass">
  <div class="nav-inner">
    <a href="/dashboard" class="nav-brand">
      <div class="logo-wrapper">
        <img src="{{ url_for('static', filename='images/logo.svg') }}" alt="">
        <div class="logo-pulse"></div>
      </div>
      <span class="brand-text">Baby-Foot Club</span>
    </a>
    <div class="nav-sep"></div>
    <div class="nav-links">
      <a href="/dashboard" class="nav-link"><span class="nav-link-icon" data-bficon="home" data-size="18" style="color:currentColor"></span><span>Dashboard</span></a>
      <a href="/reservation" class="nav-link"><span class="nav-link-icon" data-bficon="calendar" data-size="18" style="color:currentColor"></span><span>R√©server</span></a>
      <a href="/live-score" class="nav-link"><span class="nav-link-icon" data-bficon="gamepad" data-size="18" style="color:currentColor"></span><span>Partie Live</span></a>
      <a href="/stats" class="nav-link"><span class="nav-link-icon" data-bficon="stats" data-size="18" style="color:currentColor"></span><span>Stats</span></a>
      <a href="/top" class="nav-link"><span class="nav-link-icon" data-bficon="trophy" data-size="18" style="color:currentColor"></span><span>Classement</span></a>
    </div>
    <button class="burger" id="burger" onclick="toggleMenu()" aria-label="Menu">
      <span></span><span></span><span></span>
    </button>
    <div class="nav-right">
      <div class="user-profile-mini">
        <div class="nav-avatar" id="navAv">?</div>
        <span class="nav-username" id="navUsername"></span>
      </div>
      <button class="btn btn-ghost" style="margin-left:1rem" onclick="logout()"><span data-bficon="logout" data-size="16" style="color:currentColor"></span> D√©connexion</button>
    </div>
  </div>
</nav>

<div class="mobile-menu" id="mobileMenu">
  <button class="mobile-menu-close" onclick="toggleMenu()">‚úï</button>
  <a href="/dashboard"><span data-bficon="home" data-size="16"></span> Dashboard</a>
  <a href="/reservation"><span data-bficon="calendar" data-size="16"></span> R√©server</a>
  <a href="/live-score"><span data-bficon="gamepad" data-size="16"></span> Partie Live</a>
  <a href="/stats"><span data-bficon="stats" data-size="16"></span> Stats</a>
  <a href="/top"><span data-bficon="trophy" data-size="16"></span> Classement</a>
  <a href="#" onclick="logout()"><span data-bficon="logout" data-size="16" style="color:currentColor"></span> D√©connexion</a>
  <button id="pwa-install-trigger" onclick="triggerPwaInstall()" style="display:none;width:100%;text-align:left;background:linear-gradient(135deg,rgba(205,127,50,0.15),rgba(205,127,50,0.05));border:1px solid rgba(205,127,50,0.4);color:#cd7f32;font-weight:700;font-size:1rem;padding:0.9rem 1.25rem;border-radius:10px;cursor:pointer;margin-top:0.5rem;font-family:inherit;">üì≤ Installer l'app</button>
</div>

<div class="page">
  <div class="container" style="max-width:1000px">
    <div class="page-header fade-up">
      <h1><i class="fas fa-chart-bar"></i> Historique des scores</h1>
      <p>Toutes les parties jou√©es</p>
    </div>

    <div class="scores-grid fade-up" style="animation-delay:.05s" id="scoresGrid">
      <div style="padding:3rem;text-align:center">
        <div class="loading-spinner" style="margin:0 auto 1rem"></div>
        <p style="color:var(--text-tertiary)">Chargement des scores...</p>
      </div>
    </div>

    <div style="text-align:center;margin-top:1.5rem">
      <a href="/dashboard" class="btn btn-ghost">‚Üê Dashboard</a>
    </div>
  </div>
</div>

<script>
function toggleMenu() {
  document.getElementById('burger').classList.toggle('open');
  document.getElementById('mobileMenu').classList.toggle('open');
  document.body.style.overflow = document.getElementById('mobileMenu').classList.contains('open') ? 'hidden' : '';
}

function logout() {
  fetch('/api/logout', {method:'POST'}).then(() => location.href = '/');
}

// Parse les players qui peuvent √™tre string JSON (SQLite) ou tableau (PostgreSQL)
function parsePlayers(players) {
  if (!players) return [];
  if (Array.isArray(players)) return players;
  try {
    const parsed = JSON.parse(players);
    return Array.isArray(parsed) ? parsed : [players];
  } catch {
    return [players];
  }
}

fetch('/current_user').then(r => r.json()).then(d => {
  if (d && d.username) {
    document.getElementById('navAv').textContent = d.username[0].toUpperCase();
    document.getElementById('navUsername').textContent = d.username;
  }
});

async function loadScores() {
  const container = document.getElementById('scoresGrid');
  try {
    const res = await fetch('/scores_all');
    if (res.status === 401) {
      window.location.href = '/login';
      return;
    }
    const payload = await res.json();

    // Support ancien format (tableau direct) et nouveau ({games, total})
    const scores = Array.isArray(payload) ? payload : (payload.games || []);
    const total  = Array.isArray(payload) ? payload.length : (payload.total || scores.length);

    if (!scores || scores.length === 0) {
      container.innerHTML = `
        <div style="padding:3rem;text-align:center">
          <div style="margin-bottom:1rem;opacity:0.3;display:flex;justify-content:center"><span data-bficon="gamepad" data-size="64" style="color:var(--text-tertiary)"></span></div>
          <p style="color:var(--text-tertiary);margin-bottom:1.5rem">Aucune partie jou√©e pour le moment</p>
          <a href="/live-score" class="btn btn-primary">D√©marrer une partie</a>
        </div>
      `;
      return;
    }

    // scores est tri√© DESC (plus r√©cent en premier)
    // La partie la plus r√©cente = num√©ro `total`, la plus ancienne = #1
    container.innerHTML = scores.map((entry, index) => {
      const matchNum = total - index;

      let dateStr = '‚Äî', timeStr = '';
      if (entry.date) {
        try {
          const date = new Date(entry.date);
          if (!isNaN(date.getTime())) {
            dateStr = date.toLocaleDateString('fr-FR', {day:'2-digit', month:'short', year:'numeric'});
            timeStr = date.toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'});
          }
        } catch(e) { dateStr = entry.date; }
      }

      const t1 = parsePlayers(entry.team1_players);
      const t2 = parsePlayers(entry.team2_players);
      const winnerTeam = entry.winner === 'team1' ? t1 : t2;
      const loserTeam  = entry.winner === 'team1' ? t2 : t1;
      const winScore   = entry.winner === 'team1' ? entry.team1_score : entry.team2_score;
      const loseScore  = entry.winner === 'team1' ? entry.team2_score : entry.team1_score;

      return `
        <div class="score-card">
          <div class="score-header" style="display:flex;align-items:center;justify-content:space-between;gap:0.5rem;flex-wrap:nowrap">
            <div style="display:flex;align-items:center;gap:0.5rem;min-width:0">
              <span style="font-family:'Space Mono',monospace;font-size:0.7rem;font-weight:700;color:var(--bronze);background:rgba(205,127,50,0.12);padding:2px 7px;border-radius:20px;white-space:nowrap;flex-shrink:0">#${matchNum}</span>
              <span class="score-date" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:0.78rem">${dateStr}${timeStr ? ' ¬∑ ' + timeStr : ''}</span>
            </div>
            <span style="font-size:0.72rem;color:var(--text-tertiary);flex-shrink:0">${entry.mode || '2v2'}</span>
          </div>
          <div style="display:flex;align-items:center;gap:0.75rem;padding:0.5rem 0">
            <div style="flex:1;min-width:0">
              <div style="font-size:0.75rem;font-weight:700;color:#22c55e;margin-bottom:2px;white-space:nowrap">üèÜ Vainqueurs</div>
              <div style="font-weight:600;color:var(--text-primary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${winnerTeam.join(' & ')}</div>
            </div>
            <div style="font-family:'Space Mono',monospace;font-size:1.375rem;font-weight:900;color:var(--bronze);white-space:nowrap;flex-shrink:0">${winScore}‚Äì${loseScore}</div>
            <div style="flex:1;min-width:0;text-align:right">
              <div style="font-size:0.75rem;font-weight:700;color:#e74c3c;margin-bottom:2px;white-space:nowrap">Perdants</div>
              <div style="font-weight:600;color:var(--text-primary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${loserTeam.join(' & ')}</div>
            </div>
          </div>
        </div>
      `;
    }).join('');

    // R√©init ic√¥nes SVG pour le contenu inject√© dynamiquement
    if (window.initBFIcons) initBFIcons(container);

  } catch(e) {
    console.error(e);
    container.innerHTML = `
      <div style="padding:3rem;text-align:center">
        <div style="font-size:3rem;margin-bottom:1rem;opacity:0.3">‚ö†Ô∏è</div>
        <p style="color:var(--text-tertiary)">Erreur de chargement des scores ‚Äî ${e.message}</p>
      </div>
    `;
  }
}

loadScores();
</script>

<script src="{{ url_for('static', filename='icons.js') }}"></script>
  <script src="/static/pwa.js" defer></script>
</body>
</html>
