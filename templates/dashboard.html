<!DOCTYPE html>
<html lang="fr">
<head>
  <link rel="manifest" href="/static/manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="BabyFoot">
  <link rel="apple-touch-icon" href="/static/images/logo.svg">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard â€” Baby-Foot Club</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='responsive-mobile.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='dashboard-styles.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="/socket.io/socket.io.js"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='global-animations.css') }}">
  <script src="{{ url_for('static', filename='global-animations.js') }}" defer></script>
  <style>
    /* â”€â”€ Carte Lobby â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .lobby-card {
      border-radius: 16px;
      padding: 1.75rem;
      border: 2px solid;
      position: relative;
      overflow: hidden;
      transition: all 0.25s;
    }
    .lobby-card-active {
      background: linear-gradient(135deg, rgba(205,127,50,0.18) 0%, rgba(255,215,0,0.08) 100%);
      border-color: rgba(205,127,50,0.5);
    }
    .lobby-card-active::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; height: 3px;
      background: linear-gradient(90deg, #cd7f32, #ffd700, #cd7f32);
    }
    .lobby-card-disabled {
      background: var(--bg-secondary);
      border-color: var(--border-subtle);
      opacity: 0.7;
    }
    .lobby-card-waiting {
      background: linear-gradient(135deg, rgba(52,152,219,0.12) 0%, rgba(52,152,219,0.04) 100%);
      border-color: rgba(52,152,219,0.4);
    }
    .lobby-card-waiting::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; height: 3px;
      background: linear-gradient(90deg, #2980b9, #3498db, #2980b9);
    }

    .lobby-title {
      font-size: 1.15rem;
      font-weight: 800;
      display: flex;
      align-items: center;
      gap: 0.6rem;
      margin-bottom: 0.5rem;
    }
    .lobby-title-icon {
      width: 38px; height: 38px;
      border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.1rem;
      flex-shrink: 0;
    }
    .lobby-desc {
      color: var(--text-tertiary);
      font-size: 0.875rem;
      line-height: 1.5;
      margin-bottom: 1.25rem;
    }
    .lobby-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.3rem 0.75rem;
      border-radius: 99px;
      font-size: 0.75rem;
      font-weight: 700;
      margin-bottom: 1rem;
    }
    .badge-available { background: rgba(39,174,96,0.15); color: #2ecc71; border: 1px solid rgba(39,174,96,0.3); }
    .badge-unavailable { background: rgba(231,76,60,0.12); color: #e74c3c; border: 1px solid rgba(231,76,60,0.25); }
    .badge-inlobby { background: rgba(205,127,50,0.15); color: #cd7f32; border: 1px solid rgba(205,127,50,0.3); }
    .badge-waiting { background: rgba(52,152,219,0.15); color: #3498db; border: 1px solid rgba(52,152,219,0.3); }

    .lobby-main-btn {
      width: 100%;
      padding: 0.9rem 1.25rem;
      border-radius: 10px;
      border: none;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.6rem;
      font-family: inherit;
    }
    .lobby-main-btn:disabled { opacity: 0.45; cursor: not-allowed; transform: none !important; }
    .lobby-main-btn:not(:disabled):hover { transform: translateY(-2px); }
    .btn-gold {
      background: linear-gradient(135deg, #cd7f32 0%, #ffd700 100%);
      color: white;
      box-shadow: 0 4px 20px rgba(205,127,50,0.35);
    }
    .btn-gold:not(:disabled):hover { box-shadow: 0 6px 28px rgba(205,127,50,0.5); }
    .btn-blue {
      background: linear-gradient(135deg, #2980b9 0%, #3498db 100%);
      color: white;
      box-shadow: 0 4px 20px rgba(52,152,219,0.3);
    }
    .btn-blue:not(:disabled):hover { box-shadow: 0 6px 28px rgba(52,152,219,0.45); }
    .btn-ghost-grey {
      background: rgba(255,255,255,0.05);
      color: var(--text-muted);
      border: 1px solid var(--border-subtle);
    }
    .btn-ghost-grey:not(:disabled):hover { background: rgba(255,255,255,0.09); color: var(--text-primary); }

    /* â”€â”€ Responsive mobile â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @media (max-width: 640px) {
      #main-action-grid {
        grid-template-columns: 1fr !important;
      }
      .lobby-card, .resa-card {
        padding: 1.25rem !important;
      }
      .lobby-main-btn {
        font-size: 0.9rem !important;
        padding: 0.8rem 1rem !important;
      }
    }

    /* â”€â”€ Carte RÃ©servation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .resa-card {
      border-radius: 16px;
      padding: 1.75rem;
      border: 2px solid;
      position: relative;
      overflow: hidden;
      transition: all 0.25s;
    }
    .resa-card-has {
      background: linear-gradient(135deg, rgba(39,174,96,0.15) 0%, rgba(39,174,96,0.05) 100%);
      border-color: rgba(39,174,96,0.4);
    }
    .resa-card-has::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; height: 3px;
      background: linear-gradient(90deg, #27ae60, #2ecc71, #27ae60);
    }
    .resa-card-empty {
      background: linear-gradient(135deg, rgba(205,127,50,0.12) 0%, rgba(205,127,50,0.04) 100%);
      border-color: rgba(205,127,50,0.4);
      animation: resa-pulse 3s ease-in-out infinite;
    }
    .resa-card-empty::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; height: 3px;
      background: linear-gradient(90deg, #cd7f32, #ffd700, #cd7f32);
      background-size: 200% auto;
      animation: gradient-slide 3s linear infinite;
    }
    @keyframes gradient-slide { 0% { background-position: 0% center; } 100% { background-position: 200% center; } }
    @keyframes resa-pulse { 0%,100% { border-color: rgba(205,127,50,0.4); } 50% { border-color: rgba(205,127,50,0.7); } }

    .resa-title {
      font-size: 1.15rem;
      font-weight: 800;
      display: flex;
      align-items: center;
      gap: 0.6rem;
      margin-bottom: 0.5rem;
    }
    .resa-icon-wrap {
      width: 38px; height: 38px;
      border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.1rem;
      flex-shrink: 0;
    }
    .resa-slot-display {
      background: rgba(39,174,96,0.1);
      border: 1px solid rgba(39,174,96,0.25);
      border-radius: 10px;
      padding: 0.875rem 1rem;
      margin: 1rem 0;
      display: flex;
      align-items: center;
      gap: 0.875rem;
    }
    .resa-slot-time {
      font-size: 1.35rem;
      font-weight: 800;
      color: #2ecc71;
      line-height: 1;
    }
    .resa-slot-label { font-size: 0.78rem; color: var(--text-muted); margin-top: 2px; }

    /* â”€â”€ Notif bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .notification-bar {
      position: fixed;
      top: 70px;
      right: 20px;
      max-width: 400px;
      z-index: 9999;
    }
    .notification {
      background: var(--bg-elevated);
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 1rem;
      animation: slideIn 0.3s ease;
      border: 1px solid var(--border-normal);
      color: var(--text-primary);
    }
    @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    .notification-buttons { display: flex; gap: 0.5rem; }
    .notification-buttons button { padding: 0.5rem 1rem; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: all 0.2s; }
    .btn-accept { background: linear-gradient(135deg, #cd7f32 0%, #ffd700 100%); color: white; }
    .btn-accept:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(205,127,50,0.4); }
    .btn-decline { background: #e74c3c; color: white; }
    .btn-decline:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(231,76,60,0.4); }

    /* â”€â”€ Servo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #servo-controls {
      margin-top: 1.5rem;
      padding: 1.5rem;
      background: var(--bg-secondary);
      border: 1px solid var(--border-accent);
      border-radius: 12px;
      display: none;
    }
  </style>
</head>
<body style="font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">
<nav class="nav nav-glass">
  <div class="nav-inner">
    <a href="/dashboard" class="nav-brand">
      <div class="logo-wrapper">
        <img src="{{ url_for('static', filename='images/logo.svg') }}" alt="">
        <div class="logo-pulse"></div>
      </div>
      <span class="brand-text">Baby-Foot Club</span>
    </a>
    <div class="nav-sep"></div>
    <div class="nav-links">
      <a href="/dashboard" class="nav-link active"><span class="nav-link-icon" data-bficon="home" data-size="18" style="color:currentColor"></span><span>Dashboard</span></a>
      <a href="/reservation" class="nav-link"><span class="nav-link-icon" data-bficon="calendar" data-size="18" style="color:currentColor"></span><span>RÃ©server</span></a>
      <a href="/live-score" class="nav-link"><span class="nav-link-icon" data-bficon="gamepad" data-size="18" style="color:currentColor"></span><span>Partie Live</span></a>
      <a href="/stats" class="nav-link"><span class="nav-link-icon" data-bficon="stats" data-size="18" style="color:currentColor"></span><span>Stats</span></a>
      <a href="/top" class="nav-link"><span class="nav-link-icon" data-bficon="trophy" data-size="18" style="color:currentColor"></span><span>Classement</span></a>
    </div>
    <button class="burger" id="burger" onclick="toggleMenu()" aria-label="Menu"><span></span><span></span><span></span></button>
    <div class="nav-right">
      <div class="user-profile-mini">
        <div class="nav-avatar" id="navAv">?</div>
        <span class="nav-username" id="navUsername"></span>
      </div>
      <a href="/admin" id="adminBtn" class="btn" style="margin-left:1rem;background:linear-gradient(135deg,#e74c3c 0%,#c0392b 100%);color:white;display:none"><i class="fas fa-cog"></i> Admin</a>
      <a href="/settings" class="btn btn-ghost" style="margin-left:0.5rem" title="ParamÃ¨tres">âš™ï¸</a>
      <button class="btn btn-ghost" style="margin-left:0.5rem" onclick="logout()"><span data-bficon="logout" data-size="16" style="color:currentColor"></span> DÃ©connexion</button>
    </div>
  </div>
</nav>

<div class="mobile-menu" id="mobileMenu">
  <button class="mobile-menu-close" onclick="toggleMenu()">âœ•</button>
  <a href="/dashboard" class="active">ğŸ  Dashboard</a>
  <a href="/reservation">ğŸ“… RÃ©server</a>
  <a href="/live-score">ğŸ® Partie Live</a>
  <a href="/lobby">ğŸ‘¥ Lobby</a>
  <a href="/stats">ğŸ“Š Stats</a>
  <a href="/top">ğŸ† Classement</a>
  <a href="/scores">ğŸ“‹ Historique</a>
  <a href="/settings">âš™ï¸ ParamÃ¨tres</a>
  <a href="/admin" id="adminBtnMobile" style="display:none;background:rgba(205,127,50,0.12);color:#cd7f32;font-weight:bold">âš™ï¸ Admin</a>
  <a href="#" onclick="logout()">ğŸšª DÃ©connexion</a>
  <button id="pwa-install-trigger" onclick="triggerPwaInstall()" style="display:none;width:100%;text-align:left;background:linear-gradient(135deg,rgba(205,127,50,0.15),rgba(205,127,50,0.05));border:1px solid rgba(205,127,50,0.4);color:#cd7f32;font-weight:700;font-size:1rem;padding:0.9rem 1.25rem;border-radius:10px;cursor:pointer;margin-top:0.5rem;font-family:inherit;">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:middle;margin-right:6px"><rect x="5" y="2" width="14" height="20" rx="2"/><path d="M9 13h6M12 10v6"/></svg>Installer l'app
  </button>
</div>

<div class="notification-bar" id="notificationBar"></div>

<script src="{{ url_for('static', filename='profile-utils.js') }}"></script>
<script>
function toggleMenu() {
  document.getElementById("burger").classList.toggle("open");
  document.getElementById("mobileMenu").classList.toggle("open");
  document.body.style.overflow = document.getElementById("mobileMenu").classList.contains("open") ? "hidden" : "";
}
function logout() {
  fetch('/api/logout', {method: 'POST'}).then(() => location.href = '/');
}
</script>

<div class="page">
  <div class="container" style="max-width:1200px">
    <div class="page-header fade-up">
      <h1><span data-bficon="home" data-size="16"></span> Mon espace</h1>
      <p>Tout ce qu'il vous faut pour jouer au baby-foot est ici</p>
    </div>

<!-- â”€â”€ Grille principale : RÃ©servation + Lobby â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="main-action-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin-bottom:1.5rem" class="fade-up">

  <!-- CARTE RÃ‰SERVATION -->
  <div id="resaCardWrapper">
    <div class="resa-card resa-card-empty" id="resaCard">
      <div class="resa-title">
        <div class="resa-icon-wrap" style="background:linear-gradient(135deg,rgba(205,127,50,0.25),rgba(205,127,50,0.1))">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#cd7f32" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>
        </div>
        <span id="resaTitle">RÃ©server un crÃ©neau</span>
      </div>
      <div class="lobby-desc" id="resaDesc">Bloquez votre heure Ã  l'avance pour garantir l'accÃ¨s au baby-foot â€” les rÃ©servations sont confirmÃ©es immÃ©diatement</div>
      <div id="resaSlotDisplay" style="display:none" class="resa-slot-display">
        <div>
          <div class="resa-slot-time" id="resaSlotTime">â€”</div>
          <div class="resa-slot-label">votre crÃ©neau</div>
        </div>
        <div style="flex:1;font-size:0.82rem;color:var(--text-tertiary)" id="resaSlotDetail"></div>
      </div>
      <a href="/reservation" class="lobby-main-btn btn-gold" id="resaBtn" style="text-decoration:none;margin-top:0.25rem">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>
        RÃ©server maintenant
      </a>
    </div>
  </div>

  <!-- CARTE LOBBY -->
  <div id="lobbyCardWrapper">
    <div class="lobby-card lobby-card-disabled" id="lobbyCard">
      <div class="lobby-title">
        <div class="lobby-title-icon" id="lobbyTitleIcon" style="background:rgba(255,255,255,0.05)">
          <i class="fas fa-gamepad" style="color:var(--text-muted)"></i>
        </div>
        <span id="lobbyTitle">CrÃ©er un Lobby</span>
      </div>
      <div class="lobby-badge badge-unavailable" id="lobbyBadge">
        <span>âšª</span> RÃ©servation requise
      </div>
      <div class="lobby-desc" id="lobbyDesc">RÃ©servez d'abord un crÃ©neau pour dÃ©verrouiller la crÃ©ation de lobby et inviter des adversaires</div>
      <button class="lobby-main-btn btn-ghost-grey" id="lobbyBtn" disabled onclick="handleLobbyBtn()">
        <i class="fas fa-gamepad"></i> CrÃ©er un Lobby
      </button>
    </div>
  </div>
</div>

<!-- â”€â”€ Mes stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="card fade-up" style="animation-delay:.15s;margin-top:0">
  <div class="card-header">
    <h3><span data-bficon="gamepad" data-size="18" style="color:var(--bronze);vertical-align:middle"></span> Partie Live</h3>
    <a href="/live-score" style="font-size:0.8rem;color:var(--bronze);text-decoration:none;font-weight:600">Voir â†’</a>
  </div>
  <div class="card-body">
    <p style="color:var(--text-tertiary);font-size:0.875rem;margin:0 0 1rem">Rejoignez ou suivez les parties en cours â€” les scores sont mis Ã  jour en temps rÃ©el pour tous</p>
    <a href="/live-score" class="btn btn-primary" style="text-decoration:none;display:inline-flex;align-items:center;gap:0.5rem">
      <i class="fas fa-eye"></i> Voir la partie en cours
    </a>
  </div>
</div>

<div id="servo-controls" class="fade-up" style="animation-delay:.2s">
  <h3><i class="fas fa-gamepad"></i> DÃ©verrouillage de la balle</h3>
  <p>En tant qu'admin, vous pouvez dÃ©bloquer manuellement la balle pour dÃ©marrer une partie</p>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-top:1rem">
    <button class="btn btn-primary" onclick="unlockServo1(this)" style="background:linear-gradient(135deg,#3498db 0%,#2980b9 100%)">
      <span data-bficon="unlock" data-size="20" style="vertical-align:middle"></span> Servo 1<br><small style="font-size:0.8em;opacity:0.9">(Ã‰quipe 1)</small>
    </button>
    <button class="btn btn-primary" onclick="unlockServo2(this)" style="background:linear-gradient(135deg,#e74c3c 0%,#c0392b 100%)">
      <span data-bficon="unlock" data-size="20" style="vertical-align:middle"></span> Servo 2<br><small style="font-size:0.8em;opacity:0.9">(Ã‰quipe 2)</small>
    </button>
  </div>
  <div id="servo-feedback" style="margin-top:1rem;padding:0.75rem;border-radius:8px;display:none;text-align:center"></div>
</div>

<div class="card fade-up" style="animation-delay:.25s;margin-top:1.5rem">
  <div class="card-header">
    <h3><span data-bficon="trophy" data-size="18" style="color:var(--bronze);vertical-align:middle"></span> Top 3 du club</h3>
    <a href="/top" style="font-size:0.8125rem;color:var(--bronze);text-decoration:none;font-weight:600;white-space:nowrap">Voir tout â†’</a>
  </div>
  <div class="card-body">
    <div id="leaderboard"></div>
  </div>
</div>

<div class="card fade-up" style="animation-delay:.3s;margin-top:1.5rem">
  <div class="card-header">
    <h3><span data-bficon="calendar" data-size="18" style="color:var(--bronze);vertical-align:middle"></span> Vos prochains crÃ©neaux</h3>
    <a href="/reservation" style="font-size:0.8rem;color:var(--bronze);text-decoration:none;font-weight:600">+ RÃ©server â†’</a>
  </div>
  <div class="card-body">
    <div id="reservations"><p style="color:var(--text-muted);text-align:center">Chargementâ€¦</p></div>
  </div>
</div>

<div class="card fade-up" style="animation-delay:.35s;margin-top:1.5rem">
  <div class="card-header">
    <h3><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:middle;margin-right:4px"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>Mes Statistiques</h3>
    <a href="/stats" style="font-size:0.8rem;color:var(--bronze);text-decoration:none;font-weight:600">Tout voir â†’</a>
  </div>
  <div class="card-body">
    <div id="userStats"><p style="color:var(--text-muted);text-align:center">Chargementâ€¦</p></div>
  </div>
</div>

  </div>
</div>

<script src="{{ url_for('static', filename='profile-utils.js') }}"></script>
<script>
let socket;
try {
  socket = io({
    reconnection: true, reconnectionDelay: 1000, reconnectionDelayMax: 10000,
    reconnectionAttempts: Infinity, timeout: 20000,
    transports: ['websocket', 'polling'],
  });
  if (window.initReconnectIndicator) initReconnectIndicator(socket);
} catch(e) {
  socket = { emit: () => {}, on: () => {}, connected: false };
}

let currentUsername = null;
let isAdmin = false;
let hasReservation = false;
let myResaData = null; // donnÃ©es de la rÃ©sa actuelle

// â”€â”€ Lobby state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let activeLobbyState = null; // { active, host, accepted, invited, ... }
let myJoinRequestPending = false;

async function loadCurrentUser() {
  try {
    const res = await fetch('/current_user');
    if (res.ok) {
      const user = await res.json();
      currentUsername = user.username;
      isAdmin = user.is_admin;
      hasReservation = user.has_reservation;
      window._currentUsername = user.username;
      ProfileUtils.updateNav(user);
      if (isAdmin) {
        document.getElementById('adminBtn').style.display = 'inline-block';
        document.getElementById('adminBtnMobile').style.display = 'block';
        document.getElementById('servo-controls').style.display = 'block';
      }
      await checkActiveLobby();
      await loadMyResa();
      loadUserStats(user.username);
    }
  } catch(e) { console.error(e); }
}

// â”€â”€ RÃ©servation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadMyResa() {
  try {
    const res = await fetch('/api/babyfoot_status');
    const data = await res.json();
    const now = new Date();
    const all = [...(data.all_today || []), ...(data.all_tomorrow || [])];
    const mine = all.find(r => r.reserved_by === currentUsername && new Date(r.end_time) > now);
    const resaCard = document.getElementById('resaCard');
    if (mine) {
      myResaData = mine;
      hasReservation = true;
      resaCard.className = 'resa-card resa-card-has';
      document.getElementById('resaTitle').textContent = 'CrÃ©neau rÃ©servÃ© âœ“';
      document.getElementById('resaDesc').textContent = 'Votre crÃ©neau est confirmÃ© â€” le baby-foot vous est rÃ©servÃ© Ã  cette heure';
      // Afficher le crÃ©neau
      const slotDisp = document.getElementById('resaSlotDisplay');
      slotDisp.style.display = 'flex';
      const startDate = new Date(mine.start_time);
      const endDate = new Date(mine.end_time);
      const todayStr = startDate.toDateString() === now.toDateString() ? "Aujourd'hui" : 'Demain';
      const fmt = d => `${String(d.getHours()).padStart(2,'0')}h${String(d.getMinutes()).padStart(2,'0')}`;
      document.getElementById('resaSlotTime').textContent = `${fmt(startDate)} â€“ ${fmt(endDate)}`;
      document.getElementById('resaSlotDetail').textContent = `${todayStr} Â· ${mine.duration_minutes || 15} min Â· ${mine.mode}`;
      // Bouton â†’ annuler ou aller Ã  la rÃ©servation
      const btn = document.getElementById('resaBtn');
      btn.textContent = 'GÃ©rer ma rÃ©servation';
      btn.style.background = 'rgba(39,174,96,0.15)';
      btn.style.color = '#2ecc71';
      btn.style.border = '1px solid rgba(39,174,96,0.35)';
      btn.style.boxShadow = 'none';
      btn.href = '/reservation';
    } else {
      myResaData = null;
      // Pas de rÃ©sa â†’ garder l'apparence dorÃ©e (prioritÃ© d'action)
    }
    // Mettre Ã  jour l'Ã©tat du lobby
    updateLobbyCardUI();
  } catch(e) {}
}

// â”€â”€ Lobby card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function checkActiveLobby() {
  try {
    const res = await fetch('/api/active_lobby');
    activeLobbyState = await res.json();
    updateLobbyCardUI();
  } catch(e) {}
}

function updateLobbyCardUI() {
  if (!currentUsername) return;
  const card = document.getElementById('lobbyCard');
  const badge = document.getElementById('lobbyBadge');
  const btn = document.getElementById('lobbyBtn');
  const title = document.getElementById('lobbyTitle');
  const desc = document.getElementById('lobbyDesc');
  const icon = document.getElementById('lobbyTitleIcon');
  const canCreate = isAdmin || hasReservation;

  if (activeLobbyState && activeLobbyState.active) {
    const lobby = activeLobbyState;
    const imInLobby = lobby.host === currentUsername ||
                      (lobby.accepted || []).includes(currentUsername) ||
                      (lobby.invited || []).includes(currentUsername);

    if (imInLobby) {
      // Je suis dans le lobby â†’ bouton retourner
      card.className = 'lobby-card lobby-card-active';
      icon.style.background = 'linear-gradient(135deg,rgba(205,127,50,0.3),rgba(255,215,0,0.15))';
      icon.innerHTML = '<i class="fas fa-gamepad" style="color:#cd7f32"></i>';
      title.textContent = 'Lobby en cours';
      badge.className = 'lobby-badge badge-inlobby';
      badge.innerHTML = '<span>ğŸŸ¡</span> Vous Ãªtes dans le lobby';
      desc.textContent = `HÃ´te : ${lobby.host} Â· ${(lobby.accepted||[]).length} joueur(s) prÃªt(s) â€” cliquez pour retourner dans le lobby`;
      btn.className = 'lobby-main-btn btn-gold';
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Retourner dans le Lobby';
    } else if (myJoinRequestPending) {
      // J'ai dÃ©jÃ  envoyÃ© une demande â†’ en attente
      card.className = 'lobby-card lobby-card-waiting';
      icon.style.background = 'linear-gradient(135deg,rgba(52,152,219,0.25),rgba(52,152,219,0.1))';
      icon.innerHTML = '<i class="fas fa-clock" style="color:#3498db"></i>';
      title.textContent = 'Demande envoyÃ©e';
      badge.className = 'lobby-badge badge-waiting';
      badge.innerHTML = '<span>ğŸ”µ</span> En attente de rÃ©ponse';
      desc.textContent = `Votre demande a Ã©tÃ© envoyÃ©e Ã  ${lobby.host} â€” en attente de son acceptation`;
      btn.className = 'lobby-main-btn btn-ghost-grey';
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-hourglass-half"></i> En attenteâ€¦';
    } else {
      // Lobby d'un autre â†’ demander Ã  rejoindre
      card.className = 'lobby-card lobby-card-waiting';
      icon.style.background = 'linear-gradient(135deg,rgba(52,152,219,0.25),rgba(52,152,219,0.1))';
      icon.innerHTML = '<i class="fas fa-users" style="color:#3498db"></i>';
      title.textContent = 'Lobby ouvert';
      badge.className = 'lobby-badge badge-waiting';
      badge.innerHTML = `<span>ğŸ”µ</span> HÃ´te : ${lobby.host}`;
      desc.textContent = `${lobby.host} a un lobby en cours avec ${(lobby.accepted||[]).length} joueur(s) â€” envoyez une demande pour rejoindre`;
      btn.className = 'lobby-main-btn btn-blue';
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-hand-paper"></i> Demander Ã  rejoindre';
    }

  } else {
    // Pas de lobby actif
    if (canCreate) {
      card.className = 'lobby-card lobby-card-active';
      icon.style.background = 'linear-gradient(135deg,rgba(205,127,50,0.3),rgba(255,215,0,0.15))';
      icon.innerHTML = '<i class="fas fa-plus" style="color:#cd7f32"></i>';
      title.textContent = 'CrÃ©er un Lobby';
      badge.className = 'lobby-badge badge-available';
      badge.innerHTML = '<span>ğŸŸ¢</span> Disponible';
      desc.textContent = 'CrÃ©ez un lobby et invitez vos adversaires â€” ils recevront une notification instantanÃ©e';
      btn.className = 'lobby-main-btn btn-gold';
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-gamepad"></i> CrÃ©er un Lobby';
    } else {
      card.className = 'lobby-card lobby-card-disabled';
      icon.style.background = 'rgba(255,255,255,0.05)';
      icon.innerHTML = '<i class="fas fa-lock" style="color:var(--text-muted)"></i>';
      title.textContent = 'CrÃ©er un Lobby';
      badge.className = 'lobby-badge badge-unavailable';
      badge.innerHTML = '<span>ğŸ”´</span> RÃ©servation requise';
      desc.textContent = 'RÃ©servez d\'abord un crÃ©neau pour dÃ©verrouiller la crÃ©ation de lobby';
      btn.className = 'lobby-main-btn btn-ghost-grey';
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-lock"></i> CrÃ©er un Lobby';
    }
    myJoinRequestPending = false;
  }
}

function handleLobbyBtn() {
  if (activeLobbyState && activeLobbyState.active) {
    const lobby = activeLobbyState;
    const imInLobby = lobby.host === currentUsername ||
                      (lobby.accepted || []).includes(currentUsername) ||
                      (lobby.invited || []).includes(currentUsername);
    if (imInLobby) {
      location.href = '/lobby';
    } else if (!myJoinRequestPending) {
      // Envoyer une demande
      socket.emit('request_join_lobby');
      myJoinRequestPending = true;
      updateLobbyCardUI();
      showNotification('Demande envoyÃ©e Ã  ' + lobby.host + ' â€” en attente de rÃ©ponse', 'info');
    }
  } else {
    socket.emit('create_lobby', { invited: [] });
  }
}

// â”€â”€ Notifications â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showNotification(message, type) {
  const bar = document.getElementById('notificationBar');
  const notif = document.createElement('div');
  notif.className = 'notification';
  const borderColor = type === 'error' ? '#e74c3c' : type === 'success' ? '#27ae60' : 'var(--border-accent)';
  notif.style.borderLeft = `3px solid ${borderColor}`;
  notif.innerHTML = `<div style="flex:1;color:var(--text-primary)">${message}</div>`;
  bar.appendChild(notif);
  setTimeout(() => { notif.style.animation = 'slideOut 0.3s ease'; setTimeout(() => notif.remove(), 300); }, 4000);
}

// â”€â”€ Leaderboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadLeaderboard() {
  try {
    const res = await fetch('/leaderboard');
    let data = await res.json();
    const GUEST_PAT = /^Joueur\d+$/i;
    data = data.filter(p => !GUEST_PAT.test(p.username));
    const el = document.getElementById('leaderboard');
    if (!data || data.length === 0) {
      el.innerHTML = '<p style="color:var(--text-muted);text-align:center">Personne encore classÃ© â€” jouez une partie !</p>';
      return;
    }
    const medals = [
      '<span style="display:inline-flex;align-items:center;justify-content:center;width:26px;height:26px;border-radius:50%;background:#cd7f32;color:#000;font-size:0.7rem;font-weight:900">1</span>',
      '<span style="display:inline-flex;align-items:center;justify-content:center;width:26px;height:26px;border-radius:50%;background:#888;color:#fff;font-size:0.7rem;font-weight:900">2</span>',
      '<span style="display:inline-flex;align-items:center;justify-content:center;width:26px;height:26px;border-radius:50%;background:#7a5c3a;color:#fff;font-size:0.7rem;font-weight:900">3</span>'
    ];
    el.innerHTML = data.slice(0, 3).map((p, i) => `
      <div style="display:flex;align-items:center;gap:0.75rem;padding:0.65rem 0;${i < 2 ? 'border-bottom:1px solid var(--border-subtle)' : ''}">
        ${medals[i]}
        <span style="font-weight:700;color:var(--text-primary);flex:1">${p.username}</span>
        <span style="font-weight:900;color:var(--bronze);font-size:1rem">${p.elo || 1000} <span style="font-size:0.7rem;font-weight:600;color:var(--text-tertiary)">ELO</span></span>
      </div>
    `).join('');
  } catch(e) {}
}

// â”€â”€ Reservations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadReservations() {
  try {
    const res = await fetch('/reservations_today');
    const data = await res.json();
    const el = document.getElementById('reservations');
    if (!data || data.length === 0) {
      el.innerHTML = '<p style="color:var(--text-muted);text-align:center;padding:0.5rem 0">Aucune rÃ©servation â€” <a href="/reservation" style="color:var(--bronze)">prenez un crÃ©neau</a> pour jouer !</p>';
      return;
    }
    const now = new Date();
    const todayFr = ['Dimanche','Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi'][now.getDay()];
    function isPast(r) {
      if (r.day !== todayFr) return false;
      if (r.end_time) return now > new Date(r.end_time);
      return false;
    }
    data.sort((a, b) => {
      const dayOrder = d => d.day === todayFr ? 0 : 1;
      if (dayOrder(a) !== dayOrder(b)) return dayOrder(a) - dayOrder(b);
      return a.time.localeCompare(b.time);
    });
    el.innerHTML = data.map((r, i) => {
      const isMine = r.reserved_by === currentUsername;
      const past = isPast(r);
      const isNext = !past && i === 0;
      return `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:0.75rem 0;${i < data.length-1 ? 'border-bottom:1px solid var(--border-subtle);' : ''}opacity:${past ? '0.38' : '1'}">
          <div style="display:flex;align-items:center;gap:0.6rem">
            ${isNext ? '<span style="width:8px;height:8px;border-radius:50%;background:#cd7f32;box-shadow:0 0 6px #cd7f32;flex-shrink:0;display:inline-block"></span>' : '<span style="width:8px;height:8px;border-radius:50%;background:rgba(205,127,50,0.35);flex-shrink:0;display:inline-block"></span>'}
            <div>
              <div style="font-weight:600;color:${past?'var(--text-tertiary)':'var(--text-primary)'}">
                ${r.day === todayFr ? "Aujourd'hui" : 'Demain'} Â· ${r.time}
                ${past ? '<span style="font-size:0.7rem;color:var(--text-muted);margin-left:4px">passÃ©</span>' : ''}
              </div>
              <div style="color:var(--text-tertiary);font-size:0.82rem">${r.mode} â€” ${r.reserved_by}</div>
            </div>
          </div>
          ${isMine ? '<span style="font-size:0.75rem;padding:3px 10px;border-radius:20px;background:rgba(205,127,50,0.15);color:var(--bronze);font-weight:600">Vous</span>' : ''}
        </div>
      `;
    }).join('');
  } catch(e) {}
}

async function loadUserStats(username) {
  try {
    const res = await fetch(`/user_stats/${username}`);
    if (!res.ok) throw new Error();
    const data = await res.json();
    document.getElementById('userStats').innerHTML = `
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:1rem;text-align:center">
        <div><div style="font-size:2rem;font-weight:700;color:var(--bronze)">${data.total_goals ?? 0}</div><div style="color:var(--text-tertiary);font-size:0.85rem">Buts marquÃ©s</div></div>
        <div><div style="font-size:2rem;font-weight:700;color:var(--bronze)">${data.total_games ?? 0}</div><div style="color:var(--text-tertiary);font-size:0.85rem">Parties jouÃ©es</div></div>
        <div><div style="font-size:2rem;font-weight:700;color:var(--bronze)">${data.ratio ?? 0}</div><div style="color:var(--text-tertiary);font-size:0.85rem">Buts / partie</div></div>
      </div>
      <div style="margin-top:1rem;padding-top:1rem;border-top:1px solid var(--border-subtle);display:flex;justify-content:space-between;align-items:center;font-size:0.85rem;color:var(--text-tertiary)">
        <span>Meilleur score : <strong style="color:var(--text-primary)">${data.best_score || 'â€”'}</strong></span>
        <a href="/stats" style="color:var(--bronze);font-weight:600;text-decoration:none">DÃ©tails â†’</a>
      </div>
    `;
  } catch(e) {
    document.getElementById('userStats').innerHTML = '<p style="color:var(--text-muted);text-align:center">Stats indisponibles</p>';
  }
}

// Servo admin
function unlockServo1(btn) {
  const feedback = document.getElementById('servo-feedback');
  btn.disabled = true; btn.style.opacity = '0.5';
  feedback.style.display = 'block'; feedback.style.background = 'rgba(52,152,219,0.1)'; feedback.style.border = '1px solid #3498db'; feedback.textContent = 'DÃ©verrouillage Servo 1 en coursâ€¦ (5 secondes)';
  socket.emit('unlock_servo1');
  setTimeout(() => { btn.disabled = false; btn.style.opacity = '1'; feedback.style.background = 'rgba(39,174,96,0.1)'; feedback.style.border = '1px solid #27ae60'; feedback.textContent = 'âœ“ Servo 1 reverrouillÃ©'; setTimeout(() => { feedback.style.display = 'none'; }, 3000); }, 5000);
}
function unlockServo2(btn) {
  const feedback = document.getElementById('servo-feedback');
  btn.disabled = true; btn.style.opacity = '0.5';
  feedback.style.display = 'block'; feedback.style.background = 'rgba(231,76,60,0.1)'; feedback.style.border = '1px solid #e74c3c'; feedback.textContent = 'DÃ©verrouillage Servo 2 en coursâ€¦ (5 secondes)';
  socket.emit('unlock_servo2');
  setTimeout(() => { btn.disabled = false; btn.style.opacity = '1'; feedback.style.background = 'rgba(39,174,96,0.1)'; feedback.style.border = '1px solid #27ae60'; feedback.textContent = 'âœ“ Servo 2 reverrouillÃ©'; setTimeout(() => { feedback.style.display = 'none'; }, 3000); }, 5000);
}

// â”€â”€ Socket events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
socket.on('lobby_created', (data) => {
  if (data.host === currentUsername) {
    showNotification('Lobby crÃ©Ã© ! Redirectionâ€¦', 'success');
    setTimeout(() => location.href = '/lobby', 500);
  } else if (data.invited && data.invited.includes(currentUsername)) {
    showNotification('Lobby crÃ©Ã© ! Redirectionâ€¦', 'success');
    setTimeout(() => location.href = '/lobby', 500);
  } else {
    checkActiveLobby();
  }
});

socket.on('lobby_cancelled', () => { activeLobbyState = null; myJoinRequestPending = false; updateLobbyCardUI(); });
socket.on('lobby_update', (data) => { activeLobbyState = data; updateLobbyCardUI(); });
socket.on('game_started', () => { checkActiveLobby(); });
socket.on('game_stopped', () => { checkActiveLobby(); });

// RÃ©sultat de ma demande Ã  rejoindre
socket.on('join_request_result', (data) => {
  myJoinRequestPending = false;
  if (data.accepted) {
    showNotification('âœ“ Demande acceptÃ©e par ' + data.host + ' â€” redirectionâ€¦', 'success');
    setTimeout(() => location.href = '/lobby', 800);
  } else {
    showNotification('âœ• ' + data.host + ' a refusÃ© votre demande', 'error');
    checkActiveLobby();
  }
});

// Invitation reÃ§ue
socket.on('lobby_invitation', (data) => {
  // currentUsername peut ne pas encore Ãªtre chargÃ© â†’ vÃ©rifier aussi via /current_user
  if (!currentUsername) return; // skip si pas encore initialisÃ©
  if (data.to === currentUsername) {
    const bar = document.getElementById('notificationBar');
    const notif = document.createElement('div');
    notif.className = 'notification';
    notif.innerHTML = `
      <div style="flex:1;color:var(--text-primary)"><strong style="color:var(--bronze)">${data.from}</strong> vous invite Ã  jouer</div>
      <div class="notification-buttons">
        <button class="btn-accept" onclick="acceptLobby(this.closest('.notification'))">âœ“</button>
        <button class="btn-decline" onclick="declineLobby(this.closest('.notification'))">âœ•</button>
      </div>
    `;
    bar.appendChild(notif);
    setTimeout(() => notif.remove && notif.remove(), 15000);
  }
});

// Demandes Ã  rejoindre (cÃ´tÃ© hÃ´te â€” sur dashboard)
socket.on('join_request', (data) => {
  if (data.host === currentUsername || isAdmin) {
    if (window._globalShowJoinRequest) window._globalShowJoinRequest(data, socket);
    else {
      const bar = document.getElementById('notificationBar');
      const notif = document.createElement('div');
      notif.className = 'notification';
      notif.style.borderLeft = '3px solid #3498db';
      notif.innerHTML = `
        <div style="flex:1;color:var(--text-primary)"><strong style="color:#3498db">${data.from}</strong> veut rejoindre votre lobby</div>
        <div class="notification-buttons">
          <button class="btn-accept" style="background:linear-gradient(135deg,#2980b9,#3498db)" onclick="socket.emit('accept_join_request',{from:'${data.from}',request_id:'${data.request_id}'});this.closest('.notification').remove()">âœ“</button>
          <button class="btn-decline" onclick="socket.emit('decline_join_request',{from:'${data.from}',request_id:'${data.request_id}'});this.closest('.notification').remove()">âœ•</button>
        </div>
      `;
      bar.appendChild(notif);
      setTimeout(() => notif.remove && notif.remove(), 20000);
    }
  }
});

socket.on('error', (data) => { showNotification('âœ• ' + (data.message || 'Erreur'), 'error'); });

// â”€â”€ FÃ©licitations ELO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
socket.on('elo_updated', (data) => {
  if (!data || !data.changes) return;
  const me = data.changes.find(c => c.player === currentUsername);
  if (!me) return;
  const delta = me.delta;
  const sign = delta >= 0 ? '+' : '';
  const color = delta >= 0 ? '#2ecc71' : '#e74c3c';

  let msg = '', isBig = false;
  if (me.tier_up) {
    msg = `ğŸ‰ Niveau supÃ©rieur ! Tu es maintenant ${me.new_tier} !`;
    isBig = true;
  } else if (delta >= 20) {
    msg = `ğŸ”¥ Belle victoire ! ${sign}${delta} pts ELO`;
  } else if (delta > 0) {
    msg = `âœ… ${sign}${delta} pts ELO`;
  } else if (me.tier_down) {
    msg = `ğŸ“‰ Niveau perdu... ${sign}${delta} pts ELO`;
  } else {
    msg = `${sign}${delta} pts ELO`;
  }
  const t = document.createElement('div');
  t.style.cssText = `position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(0.8);z-index:10000;
    background:var(--bg-elevated);border:2px solid ${color};border-radius:20px;
    padding:${isBig ? '2rem 2.5rem' : '1.25rem 2rem'};text-align:center;
    box-shadow:0 8px 40px rgba(0,0,0,0.6);backdrop-filter:blur(12px);
    font-size:${isBig ? '1.3rem' : '1rem'};font-weight:700;color:var(--text-primary);
    opacity:0;transition:all 0.3s ease;max-width:90vw`;
  t.textContent = msg;
  document.body.appendChild(t);
  requestAnimationFrame(() => { t.style.opacity = '1'; t.style.transform = 'translate(-50%,-50%) scale(1)'; });
  setTimeout(() => {
    t.style.opacity = '0'; t.style.transform = 'translate(-50%,-50%) scale(0.9)';
    setTimeout(() => t.remove(), 400);
  }, isBig ? 4500 : 3000);
});

function acceptLobby(notifEl) {
  socket.emit('accept_lobby');
  if (notifEl) notifEl.remove();
  setTimeout(() => location.href = '/lobby', 500);
}
function declineLobby(notifEl) {
  socket.emit('decline_lobby');
  if (notifEl) notifEl.remove();
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
loadCurrentUser();
loadLeaderboard();
loadReservations();
</script>

<script src="{{ url_for('static', filename='icons.js') }}"></script>
<script src="/static/pwa.js" defer></script>
</body>
</html>
