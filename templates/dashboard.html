<!DOCTYPE html>

<html lang="fr">
<head>
  <link rel="manifest" href="/static/manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="BabyFoot">
  <link rel="apple-touch-icon" href="/static/images/logo.svg">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard — Baby-Foot Club</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='responsive-mobile.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='dashboard-styles.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='global-animations.css') }}">
  <script src="{{ url_for('static', filename='global-animations.js') }}" defer></script>
  <style>
    .notification-bar {
      position: fixed;
      top: 70px;
      right: 20px;
      max-width: 400px;
      z-index: 9999;
    }
    .notification {
      background: var(--bg-elevated);
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 1rem;
      animation: slideIn 0.3s ease;
      border: 1px solid var(--border-normal);
      color: var(--text-primary);
    }
    @keyframes slideIn {
      from { transform: translateX(400px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    .notification-buttons { display: flex; gap: 0.5rem; }
    .notification-buttons button {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      transition: all 0.2s;
    }
    .btn-accept { background: linear-gradient(135deg, #cd7f32 0%, #ffd700 100%); color: white; }
    .btn-accept:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(205,127,50,0.4); }
    .btn-decline { background: #e74c3c; color: white; }
    .btn-decline:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(231,76,60,0.4); }
    #invitation-section {
      margin-top: 1.5rem;
      padding: 1.5rem;
      background: linear-gradient(135deg, rgba(205,127,50,0.2) 0%, rgba(255,215,0,0.2) 100%);
      border: 1px solid var(--border-accent);
      border-radius: 12px;
      color: var(--text-primary);
      display: block;
    }
    #invitation-section h3 { color: var(--bronze); margin-top: 0; }
    #servo-controls {
      margin-top: 1.5rem;
      padding: 1.5rem;
      background: var(--bg-secondary);
      border: 1px solid var(--border-accent);
      border-radius: 12px;
      display: none;
    }
  </style>
</head>
<body style="font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">
<nav class="nav nav-glass">
  <div class="nav-inner">
    <a href="/dashboard" class="nav-brand">
      <div class="logo-wrapper">
        <img src="{{ url_for('static', filename='images/logo.svg') }}" alt="">
        <div class="logo-pulse"></div>
      </div>
      <span class="brand-text">Baby-Foot Club</span>
    </a>
    <div class="nav-sep"></div>
    <div class="nav-links">
      <a href="/dashboard" class="nav-link active"><span class="nav-link-icon" data-bficon="home" data-size="18" style="color:currentColor"></span><span>Dashboard</span></a>
      <a href="/reservation" class="nav-link"><span class="nav-link-icon" data-bficon="calendar" data-size="18" style="color:currentColor"></span><span>Réserver</span></a>
      <a href="/live-score" class="nav-link"><span class="nav-link-icon" data-bficon="gamepad" data-size="18" style="color:currentColor"></span><span>Partie Live</span></a>
      <a href="/stats" class="nav-link"><span class="nav-link-icon" data-bficon="stats" data-size="18" style="color:currentColor"></span><span>Stats</span></a>
      <a href="/top" class="nav-link"><span class="nav-link-icon" data-bficon="trophy" data-size="18" style="color:currentColor"></span><span>Classement</span></a>
    </div>
    <button class="burger" id="burger" onclick="toggleMenu()" aria-label="Menu">
      <span></span><span></span><span></span>
    </button>
    <div class="nav-right">
      <div class="user-profile-mini">
        <div class="nav-avatar" id="navAv">?</div>
        <span class="nav-username" id="navUsername"></span>
      </div>
      <a href="/admin" id="adminBtn" class="btn" style="margin-left:1rem;background:linear-gradient(135deg,#e74c3c 0%,#c0392b 100%);color:white;display:none"><i class="fas fa-cog"></i> Admin</a>
      <a href="/settings" class="btn btn-ghost" style="margin-left:0.5rem" title="Paramètres">⚙️</a>
      <button class="btn btn-ghost" style="margin-left:0.5rem" onclick="logout()"><span data-bficon="logout" data-size="16" style="color:currentColor"></span> Déconnexion</button>
    </div>
  </div>
</nav>

<div class="mobile-menu" id="mobileMenu">
  <button class="mobile-menu-close" onclick="toggleMenu()">✕</button>
  <a href="/dashboard"><span data-bficon="home" data-size="16"></span> Dashboard</a>
  <a href="/reservation"><span data-bficon="calendar" data-size="16"></span> Réserver</a>
  <a href="/live-score"><span data-bficon="gamepad" data-size="16"></span> Partie Live</a>
  <a href="/stats"><span data-bficon="stats" data-size="16"></span> Stats</a>
  <a href="/top"><span data-bficon="trophy" data-size="16"></span> Classement</a>
  <a href="/admin" id="adminBtnMobile" style="display:none;background:rgba(231,76,60,0.2);color:#e74c3c;font-weight:bold"><i class="fas fa-cog"></i> Admin</a>
  <a href="#" onclick="logout()"><span data-bficon="logout" data-size="16" style="color:currentColor"></span> Déconnexion</a>
  <button id="pwa-install-trigger" onclick="triggerPwaInstall()" style="display:none;width:100%;text-align:left;background:linear-gradient(135deg,rgba(205,127,50,0.15),rgba(205,127,50,0.05));border:1px solid rgba(205,127,50,0.4);color:#cd7f32;font-weight:700;font-size:1rem;padding:0.9rem 1.25rem;border-radius:10px;cursor:pointer;margin-top:0.5rem;font-family:inherit;"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;display:inline-block;flex-shrink:0"><rect x="5" y="2" width="14" height="20" rx="2"/><path d="M9 13h6M12 10v6"/></svg> Installer l'app</button>
</div>

<div class="notification-bar" id="notificationBar"></div>

<script>
function toggleMenu() {
  document.getElementById("burger").classList.toggle("open");
  document.getElementById("mobileMenu").classList.toggle("open");
  document.body.style.overflow = document.getElementById("mobileMenu").classList.contains("open") ? "hidden" : "";
}
function logout() {
  fetch('/api/logout', {method: 'POST'}).then(() => location.href = '/');
}
</script>

<div class="page">
  <div class="container" style="max-width:1200px">
    <div class="page-header fade-up">
      <h1><span data-bficon="home" data-size="16"></span> Mon espace</h1>
      <p>Voici votre tableau de bord — tout ce qu'il vous faut pour jouer est ici</p>
    </div>

<div class="grid-3 fade-up" style="animation-delay:.05s">
  <div class="card card-hover">
    <div class="card-header"><h3><span data-bficon="calendar" data-size="16"></span> Réserver</h3></div>
    <div class="card-body">
      <p>Bloquez votre créneau à l'avance pour être sûr d'avoir le baby-foot disponible</p>
      <a href="/reservation" class="btn btn-primary btn-full">Réserver un créneau</a>
    </div>
  </div>
  <div class="card card-hover">
    <div class="card-header"><h3><span data-bficon="gamepad" data-size="18" style="color:var(--bronze);vertical-align:middle"></span> Jouer</h3></div>
    <div class="card-body">
      <p>Créez un lobby, invitez vos adversaires et comptez les buts en temps réel</p>
      <a href="/live-score" class="btn btn-primary btn-full">Lancer une partie</a>
    </div>
  </div>
  <div class="card card-hover">
    <div class="card-header"><h3><span data-bficon="stats" data-size="16"></span> Mes stats</h3></div>
    <div class="card-body">
      <p>Suivez votre évolution, vos buts et comparez-vous aux autres joueurs du club</p>
      <a href="/stats" class="btn btn-primary btn-full">Voir mes stats</a>
    </div>
  </div>
</div>

<div id="invitation-section" class="fade-up" style="animation-delay:.1s">
  <h3><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;display:inline-block;flex-shrink:0"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/></svg> Créer un Lobby</h3>
  <p id="lobby-description">Créez un lobby, puis invitez vos adversaires directement depuis la page lobby — ils recevront une notification en temps réel</p>
  <button id="create-lobby-btn" class="btn btn-full" style="margin-top:1rem;background:linear-gradient(135deg,#cd7f32 0%,#ffd700 100%);color:white;font-weight:bold" onclick="createEmptyLobby()"><i class="fas fa-gamepad"></i> Créer un Lobby</button>
  <button id="rejoin-lobby-btn" class="btn btn-full" style="margin-top:1rem;background:linear-gradient(135deg,#cd7f32 0%,#ffd700 100%);color:white;font-weight:bold;display:none" onclick="rejoinLobby()"><span data-bficon="replay" data-size="18" style="vertical-align:middle"></span> Retourner dans le Lobby</button>
</div>

<div id="servo-controls" class="fade-up" style="animation-delay:.15s">
  <h3><i class="fas fa-gamepad"></i> Déverrouillage de la balle</h3>
  <p>En tant qu'admin, vous pouvez débloquer manuellement la balle pour démarrer une partie</p>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-top:1rem">
    <button class="btn btn-primary" onclick="unlockServo1(this)" style="background:linear-gradient(135deg,#3498db 0%,#2980b9 100%)">
      <span data-bficon="unlock" data-size="20" style="vertical-align:middle"></span> Servo 1<br><small style="font-size:0.8em;opacity:0.9">(Équipe 1)</small>
    </button>
    <button class="btn btn-primary" onclick="unlockServo2(this)" style="background:linear-gradient(135deg,#e74c3c 0%,#c0392b 100%)">
      <span data-bficon="unlock" data-size="20" style="vertical-align:middle"></span> Servo 2<br><small style="font-size:0.8em;opacity:0.9">(Équipe 2)</small>
    </button>
  </div>
  <div id="servo-feedback" style="margin-top:1rem;padding:0.75rem;border-radius:8px;display:none;text-align:center"></div>
</div>

<div class="card fade-up" style="animation-delay:.2s;margin-top:1.5rem">
  <div class="card-header"><h3><span data-bficon="trophy" data-size="18" style="color:var(--bronze);vertical-align:middle"></span> Top 3 du club</h3><a href="/top" style="font-size:0.8125rem;color:var(--bronze);text-decoration:none;font-weight:600;white-space:nowrap">Voir tout le classement →</a></div>
  <div class="card-body">
    <div id="leaderboard"></div>
  </div>
</div>

<div class="card fade-up" style="animation-delay:.25s;margin-top:1.5rem">
  <div class="card-header">
    <h3><span data-bficon="calendar" data-size="18" style="color:var(--bronze);vertical-align:middle"></span> Vos prochains créneaux</h3>
    <a href="/reservation" style="font-size:0.8rem;color:var(--bronze);text-decoration:none;font-weight:600">+ Réserver →</a>
  </div>
  <div class="card-body">
    <div id="reservations"><p style="color:var(--text-muted);text-align:center">Chargement…</p></div>
  </div>
</div>

<div class="card fade-up" style="animation-delay:.3s;margin-top:1.5rem">
  <div class="card-header">
    <h3><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;display:inline-block;flex-shrink:0"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg> Mes Statistiques</h3>
    <a href="/stats" style="font-size:0.8rem;color:var(--bronze);text-decoration:none;font-weight:600">Tout voir →</a>
  </div>
  <div class="card-body">
    <div id="userStats"><p style="color:var(--text-muted);text-align:center">Chargement…</p></div>
  </div>
</div>

  </div>
</div>

<script>
let socket;
try {
  socket = io({
    reconnection: true,
    reconnectionDelay: 1000,       // Attendre 1s avant 1ère tentative
    reconnectionDelayMax: 10000,   // Max 10s entre tentatives
    reconnectionAttempts: Infinity, // Toujours réessayer
    timeout: 20000,                // 20s avant d'abandonner une connexion
    transports: ['websocket', 'polling'],  // WebSocket d'abord, polling en fallback
  });
  if (window.initReconnectIndicator) initReconnectIndicator(socket);
  socket.on('connect', () => {
  });
  socket.on('connect_error', (err) => {
  });
  socket.on('disconnect', () => {
  });
} catch(e) {
  alert('⚠️ Connexion temps réel impossible. Rechargez la page.');
  socket = { 
    emit: (event, data) => { console.warn(`✕ Socket factice: emit(${event}) ignoré`); },
    on: () => {},
    connected: false
  };
}
let currentUsername = null;
let isAdmin = false;
let hasReservation = false;

async function loadCurrentUser() {
  try {
    const res = await fetch('/current_user');
    if (res.ok) {
      const user = await res.json();
      currentUsername = user.username;
      isAdmin = user.is_admin;
      hasReservation = user.has_reservation;
      document.getElementById('navUsername').textContent = user.username;
      document.getElementById('navAv').textContent = user.username[0].toUpperCase();
      if (isAdmin) {
        document.getElementById('adminBtn').style.display = 'inline-block';
        document.getElementById('adminBtnMobile').style.display = 'block';
      }
      document.getElementById('invitation-section').style.display = 'block';
      if (!isAdmin && !hasReservation) {
        document.getElementById('create-lobby-btn').disabled = true;
        document.getElementById('create-lobby-btn').style.opacity = '0.4';
        document.getElementById('create-lobby-btn').style.cursor = 'not-allowed';
        document.getElementById('create-lobby-btn').title = 'Réservation requise';
        document.getElementById('lobby-description').textContent = 'Réservez d\'abord un créneau pour pouvoir créer un lobby et jouer';
      }
      if (isAdmin) {
        document.getElementById('servo-controls').style.display = 'block';
      }
      await checkActiveLobby();
      loadUserStats(user.username);
    }
  } catch (e) { console.error('Erreur chargement user:', e); }
}

async function checkActiveLobby() {
  try {
    const res = await fetch('/api/active_lobby');
    const lobby = await res.json();
    if (lobby.active) {
      if (lobby.host === currentUsername || lobby.accepted.includes(currentUsername)) {
        // Je suis dans ce lobby → bouton rejoindre
        document.getElementById('create-lobby-btn').style.display = 'none';
        document.getElementById('rejoin-lobby-btn').style.display = 'block';
        document.getElementById('lobby-description').textContent = 'Vous avez déjà un lobby en cours — cliquez pour y retourner';
      } else if (isAdmin) {
        // Admin : peut toujours créer (le serveur annulera l'ancien lobby)
        document.getElementById('create-lobby-btn').style.display = 'block';
        document.getElementById('rejoin-lobby-btn').style.display = 'none';
        document.getElementById('create-lobby-btn').disabled = false;
        document.getElementById('create-lobby-btn').style.opacity = '1';
        document.getElementById('create-lobby-btn').style.cursor = 'pointer';
        document.getElementById('create-lobby-btn').title = `Lobby en cours (hôte : ${lobby.host}) — vous pouvez le remplacer`;
        document.getElementById('lobby-description').textContent = `Lobby en cours (hôte : ${lobby.host}) — cliquez pour le remplacer`;
      } else {
        // Un autre lobby est actif, je n'en fais pas partie
        document.getElementById('create-lobby-btn').style.display = 'block';
        document.getElementById('rejoin-lobby-btn').style.display = 'none';
        document.getElementById('create-lobby-btn').disabled = true;
        document.getElementById('create-lobby-btn').style.opacity = '0.4';
        document.getElementById('create-lobby-btn').style.cursor = 'not-allowed';
        document.getElementById('create-lobby-btn').title = `Un lobby est déjà en cours (hôte : ${lobby.host}) — attendez qu'il se termine`;
        document.getElementById('lobby-description').textContent = `Un lobby est déjà en cours (hôte : ${lobby.host})`;
      }
    } else {
      document.getElementById('create-lobby-btn').style.display = 'block';
      document.getElementById('rejoin-lobby-btn').style.display = 'none';
      document.getElementById('lobby-description').textContent = 'Créez un lobby, puis invitez vos adversaires — ils recevront une notification en temps réel';
    }
  } catch (e) { console.error('Erreur vérification lobby:', e); }
}

function rejoinLobby() { location.href = '/lobby'; }
function createEmptyLobby() {


  socket.emit('create_lobby', { invited: [] });
}

function unlockServo1(btn) {
  const feedback = document.getElementById('servo-feedback');
  btn.disabled = true; btn.style.opacity = '0.5';
  feedback.style.display = 'block';
  feedback.style.background = 'rgba(52,152,219,0.1)';
  feedback.style.border = '1px solid #3498db';
  feedback.textContent = 'Déverrouillage Servo 1 en cours… (5 secondes)';
  socket.emit('unlock_servo1');
  setTimeout(() => {
    btn.disabled = false; btn.style.opacity = '1';
    feedback.style.background = 'rgba(39,174,96,0.1)';
    feedback.style.border = '1px solid #27ae60';
    feedback.textContent = '✓ Servo 1 reverrouillé automatiquement';
    setTimeout(() => { feedback.style.display = 'none'; }, 3000);
  }, 5000);
}

function unlockServo2(btn) {
  const feedback = document.getElementById('servo-feedback');
  btn.disabled = true; btn.style.opacity = '0.5';
  feedback.style.display = 'block';
  feedback.style.background = 'rgba(231,76,60,0.1)';
  feedback.style.border = '1px solid #e74c3c';
  feedback.textContent = 'Déverrouillage Servo 2 en cours… (5 secondes)';
  socket.emit('unlock_servo2');
  setTimeout(() => {
    btn.disabled = false; btn.style.opacity = '1';
    feedback.style.background = 'rgba(39,174,96,0.1)';
    feedback.style.border = '1px solid #27ae60';
    feedback.textContent = '✓ Servo 2 reverrouillé automatiquement';
    setTimeout(() => { feedback.style.display = 'none'; }, 3000);
  }, 5000);
}

async function loadLeaderboard() {
  try {
    const res = await fetch('/leaderboard');
    const data = await res.json();
    const el = document.getElementById('leaderboard');
    if (!data || data.length === 0) {
      el.innerHTML = '<p style="color:var(--text-muted);text-align:center">Personne encore classé — jouez une partie pour apparaître ici !</p>';
      return;
    }
    const medals = [
      '<span style="display:inline-flex;align-items:center;justify-content:center;width:26px;height:26px;border-radius:50%;background:#cd7f32;color:#000;font-size:0.7rem;font-weight:900">1</span>',
      '<span style="display:inline-flex;align-items:center;justify-content:center;width:26px;height:26px;border-radius:50%;background:#888;color:#fff;font-size:0.7rem;font-weight:900">2</span>',
      '<span style="display:inline-flex;align-items:center;justify-content:center;width:26px;height:26px;border-radius:50%;background:#7a5c3a;color:#fff;font-size:0.7rem;font-weight:900">3</span>'
    ];
    el.innerHTML = data.slice(0, 3).map((p, i) => `
      <div style="display:flex;align-items:center;gap:0.75rem;padding:0.65rem 0;${i < 2 ? 'border-bottom:1px solid var(--border-subtle)' : ''}">
        <span style="font-size:1.375rem;width:30px;text-align:center;flex-shrink:0">${medals[i]}</span>
        <span style="font-weight:700;color:var(--text-primary);flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${p.username}</span>
        <span style="font-family:'Space Mono',monospace;font-weight:900;color:var(--bronze);font-size:1rem;white-space:nowrap;flex-shrink:0">${p.total_goals} <span style="font-size:0.7rem;font-weight:600;color:var(--text-tertiary)">buts</span></span>
      </div>
    `).join('');
  } catch (e) { console.error('Erreur leaderboard:', e); }
}

async function loadReservations() {
  try {
    const res = await fetch('/reservations_today');
    const data = await res.json();
    const el = document.getElementById('reservations');
    if (!data || data.length === 0) {
      el.innerHTML = '<p style="color:var(--text-muted);text-align:center;padding:0.5rem 0">Aucune réservation — <a href="/reservation" style="color:var(--bronze)">prenez un créneau</a> pour jouer !</p>';
      return;
    }

    // Heure actuelle pour détecter les créneaux passés
    const now = new Date();
    const todayFr = ['Dimanche','Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi'][now.getDay()];
    const tomorrowDate = new Date(now); tomorrowDate.setDate(now.getDate() + 1);
    const tomorrowFr = ['Dimanche','Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi'][tomorrowDate.getDay()];

    function isPast(r) {
      if (r.day !== todayFr) return false; // demain → pas passé
      // Utiliser end_time si disponible (précis)
      if (r.end_time) return now > new Date(r.end_time);
      // Fallback : extraire heure de début et ajouter la durée
      const match = r.time.match(/^(\d{2}):(\d{2})/);
      if (!match) return false;
      const slotH = parseInt(match[1]), slotM = parseInt(match[2]);
      const dur = r.duration_minutes || 15;
      const slotEnd = new Date(now); slotEnd.setHours(slotH, slotM + dur, 0, 0);
      return now > slotEnd;
    }

    // Trier : aujourd'hui d'abord (heure croissante), puis demain
    data.sort((a, b) => {
      const dayOrder = (d) => d.day === todayFr ? 0 : 1;
      if (dayOrder(a) !== dayOrder(b)) return dayOrder(a) - dayOrder(b);
      return a.time.localeCompare(b.time);
    });

    const upcoming = data.filter(r => !isPast(r));
    const past = data.filter(r => isPast(r));
    const sorted = [...upcoming, ...past];

    if (sorted.length === 0) {
      el.innerHTML = '<p style="color:var(--text-muted);text-align:center;padding:0.5rem 0">Aucune réservation à venir</p>';
      return;
    }

    el.innerHTML = sorted.map((r, i) => {
      const isMine = r.reserved_by === currentUsername;
      const past = isPast(r);
      const isLast = i === sorted.length - 1;
      const isNext = !past && i === 0;

      return `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:0.75rem 0;
          ${isLast ? '' : 'border-bottom:1px solid var(--border-subtle);'}
          opacity:${past ? '0.38' : '1'};
          filter:${past ? 'grayscale(0.4)' : 'none'};
          transition:opacity 0.2s;">
          <div style="display:flex;align-items:center;gap:0.6rem;">
            ${isNext ? '<span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:#cd7f32;box-shadow:0 0 6px #cd7f32;flex-shrink:0"></span>' : (past ? '<span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,0.15);flex-shrink:0"></span>' : '<span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:rgba(205,127,50,0.35);flex-shrink:0"></span>')}
            <div>
              <div style="font-weight:600;color:${past ? 'var(--text-tertiary)' : 'var(--text-primary)'}">
                ${r.day === todayFr ? "Aujourd'hui" : 'Demain'} · ${r.time}
                ${past ? '<span style="font-size:0.7rem;color:var(--text-muted);font-weight:400;margin-left:4px">passé</span>' : ''}
              </div>
              <div style="color:var(--text-tertiary);font-size:0.82rem">${r.mode} — ${r.reserved_by}</div>
            </div>
          </div>
          ${isMine ? '<span style="font-size:0.75rem;padding:3px 10px;border-radius:20px;background:rgba(205,127,50,0.15);color:var(--bronze);font-weight:600;flex-shrink:0">Vous</span>' : ''}
        </div>
      `;
    }).join('');
  } catch (e) { console.error('Erreur réservations:', e); }
}

async function loadUserStats(username) {
  try {
    const res = await fetch(`/user_stats/${username}`);
    if (!res.ok) throw new Error();
    const data = await res.json();
    document.getElementById('userStats').innerHTML = `
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:1rem;text-align:center">
        <div>
          <div style="font-size:2rem;font-weight:700;color:var(--bronze)">${data.total_goals ?? 0}</div>
          <div style="color:var(--text-tertiary);font-size:0.85rem">Buts marqués</div>
        </div>
        <div>
          <div style="font-size:2rem;font-weight:700;color:var(--bronze)">${data.total_games ?? 0}</div>
          <div style="color:var(--text-tertiary);font-size:0.85rem">Parties jouées</div>
        </div>
        <div>
          <div style="font-size:2rem;font-weight:700;color:var(--bronze)">${data.ratio ?? 0}</div>
          <div style="color:var(--text-tertiary);font-size:0.85rem">Buts / partie</div>
        </div>
      </div>
      <div style="margin-top:1rem;padding-top:1rem;border-top:1px solid var(--border-subtle);display:flex;justify-content:space-between;align-items:center;font-size:0.85rem;color:var(--text-tertiary)">
        <span>Meilleur score : <strong style="color:var(--text-primary)">${data.best_score || '—'}</strong></span>
        <a href="/stats" style="color:var(--bronze);font-weight:600;text-decoration:none">Détails →</a>
      </div>
    `;
  } catch (e) {
    document.getElementById('userStats').innerHTML =
      '<p style="color:var(--text-muted);text-align:center">Stats indisponibles</p>';
  }
}

function showNotification(message, type) {
  const bar = document.getElementById('notificationBar');
  const notif = document.createElement('div');
  notif.className = 'notification';
  const borderColor = type === 'error' ? '#e74c3c' : type === 'success' ? '#27ae60' : 'var(--border-accent)';
  notif.style.borderLeft = `3px solid ${borderColor}`;
  notif.innerHTML = `<div style="flex:1;color:var(--text-primary)">${message}</div>`;
  bar.appendChild(notif);
  setTimeout(() => {
    notif.style.animation = 'slideOut 0.3s ease';
    setTimeout(() => notif.remove(), 300);
  }, 4000);
}

socket.on('lobby_created', (data) => {
  if (data.host === currentUsername) {
    // Je suis l'hôte → aller au lobby
    showNotification('Lobby créé ! Redirection…', 'success');
    setTimeout(() => location.href = '/lobby', 500);
  } else if (data.invited && data.invited.includes(currentUsername)) {
    // J'étais dans la liste invited initiale → aller au lobby
    showNotification('Lobby créé ! Redirection…', 'success');
    setTimeout(() => location.href = '/lobby', 500);
  }
  // Sinon : un autre user a créé un lobby, on rafraîchit juste le bouton
  else {
    checkActiveLobby();
  }
});

// Lobby annulé → rafraîchir le bouton
socket.on('lobby_cancelled', () => {
  checkActiveLobby();
});

// Lobby mis à jour → rafraîchir si je suis membre
socket.on('lobby_update', (data) => {
  if (!currentUsername) return;
  const isMember = (data.accepted || []).includes(currentUsername)
                || (data.invited  || []).includes(currentUsername)
                || data.host === currentUsername;
  if (isMember) checkActiveLobby();
  else checkActiveLobby(); // refresher aussi pour les autres (bouton grisé)
});

// Partie démarrée → rafraîchir état
socket.on('game_started', () => { checkActiveLobby(); });
socket.on('game_stopped', () => { checkActiveLobby(); });

socket.on('error', (data) => {
  showNotification('✕ ' + (data.message || 'Erreur'), 'error');
});

socket.on('lobby_invitation', (data) => {
  if (data.to === currentUsername) {
    const bar = document.getElementById('notificationBar');
    const notif = document.createElement('div');
    notif.className = 'notification';
    notif.innerHTML = `
      <div style="flex:1;color:var(--text-primary)">
        <strong style="color:var(--bronze)">${data.from}</strong> vous invite à jouer
      </div>
      <div class="notification-buttons">
        <button class="btn-accept" onclick="acceptLobby(this.closest('.notification'))">✓</button>
        <button class="btn-decline" onclick="declineLobby(this.closest('.notification'))">✕</button>
      </div>
    `;
    bar.appendChild(notif);
  }
});

function acceptLobby(notifEl) {
  socket.emit('accept_lobby');
  if (notifEl) notifEl.remove();
  document.querySelectorAll('.notification').forEach(n => n.remove());
  setTimeout(() => location.href = '/lobby', 500);
}
function declineLobby(notifEl) {
  socket.emit('decline_lobby');
  if (notifEl) notifEl.remove();
  document.querySelectorAll('.notification').forEach(n => n.remove());
}

loadCurrentUser();
loadLeaderboard();
loadReservations();
</script>


<script src="{{ url_for('static', filename='icons.js') }}"></script>
  <script src="/static/pwa.js" defer></script>
</body>
</html>