<!DOCTYPE html>
<html lang="fr">
<head>
  <link rel="manifest" href="/static/manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="BabyFoot">
  <link rel="apple-touch-icon" href="/static/images/logo.svg">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#0a0a0a">
  <title>Classement ‚Äî Baby-Foot Club</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='responsive-mobile.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='style-extended.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='global-animations.css') }}">
  <script src="{{ url_for('static', filename='global-animations.js') }}" defer></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    /* ‚îÄ‚îÄ Leaderboard mobile-first ‚îÄ‚îÄ */
    .lb-list {
      overflow: hidden;
    }

    .lb-item {
      display: flex;
      align-items: center;
      gap: 0.875rem;
      padding: 0.875rem 1rem;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-subtle);
      transition: background 0.15s, transform 0.15s;
      position: relative;
    }
    .lb-item:first-child { border-radius: var(--radius-md) var(--radius-md) 0 0; }
    .lb-item:last-child  { border-bottom: none; border-radius: 0 0 var(--radius-md) var(--radius-md); }
    .lb-item.is-me {
      background: linear-gradient(90deg, rgba(205,127,50,0.18) 0%, rgba(205,127,50,0.05) 100%);
      border-left: 3px solid var(--bronze);
    }

    /* Rang */
    .lb-rank {
      font-family: 'Space Mono', monospace;
      font-weight: 800;
      font-size: 0.9rem;
      color: var(--text-tertiary);
      min-width: 28px;
      text-align: center;
      flex-shrink: 0;
    }
    .lb-rank.podium {
      font-size: 1.5rem;
      filter: drop-shadow(0 2px 6px rgba(205,127,50,0.4));
    }

    /* Avatar */
    .lb-av {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--gradient-bronze);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      font-weight: 800;
      color: white;
      flex-shrink: 0;
    }
    .lb-av.av1 { background: linear-gradient(135deg, #ffd700, #ffb300); }
    .lb-av.av2 { background: linear-gradient(135deg, #c0c0c0, #a0a0a0); }
    .lb-av.av3 { background: linear-gradient(135deg, #cd7f32, #b8732f); }

    /* Infos */
    .lb-info {
      flex: 1;
      min-width: 0;
    }
    .lb-name {
      font-size: 0.9375rem;
      font-weight: 700;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .lb-sub {
      font-size: 0.75rem;
      color: var(--text-tertiary);
      margin-top: 1px;
      white-space: nowrap;
    }

    /* Score */
    .lb-score {
      text-align: right;
      flex-shrink: 0;
    }
    .lb-score-val {
      font-family: 'Space Mono', monospace;
      font-size: 1.375rem;
      font-weight: 900;
      color: var(--bronze);
      line-height: 1;
    }
    .lb-score-label {
      font-size: 0.6875rem;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-top: 1px;
    }

    /* Podium top 3 ‚Äî l√©g√®re mise en avant */
    .lb-item:nth-child(1) .lb-score-val { color: #ffd700; }
    .lb-item:nth-child(2) .lb-score-val { color: #c0c0c0; }
    .lb-item:nth-child(3) .lb-score-val { color: #cd7f32; }

    /* Header tableau */
    .lb-header {
      display: flex;
      align-items: center;
      gap: 0.875rem;
      padding: 0.5rem 1rem;
      font-size: 0.6875rem;
      font-weight: 700;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      border-bottom: 1px solid var(--border-subtle);
    }
    .lb-header-rank { min-width: 28px; text-align: center; flex-shrink: 0; }
    .lb-header-av   { width: 40px; flex-shrink: 0; }
    .lb-header-info { flex: 1; }
    .lb-header-score{ text-align: right; flex-shrink: 0; padding-right: 2px; }

    /* Tags */
    .tag-me {
      display: inline-block;
      font-size: 0.65rem;
      padding: 1px 7px;
      border-radius: 20px;
      background: rgba(205,127,50,0.18);
      color: var(--bronze);
      font-weight: 700;
      margin-left: 5px;
      vertical-align: middle;
    }

    /* Online dot */
    .online-dot {
      display: inline-block;
      width: 9px;
      height: 9px;
      border-radius: 50%;
      background: #2ecc71;
      box-shadow: 0 0 0 2px rgba(46,204,113,0.25), 0 0 6px rgba(46,204,113,0.5);
      flex-shrink: 0;
      animation: pulse-green 2s ease-in-out infinite;
    }
    @keyframes pulse-green {
      0%,100% { box-shadow: 0 0 0 2px rgba(46,204,113,0.25), 0 0 6px rgba(46,204,113,0.5); }
      50%      { box-shadow: 0 0 0 4px rgba(46,204,113,0.15), 0 0 12px rgba(46,204,113,0.4); }
    }
    .lb-av-wrap { position: relative; flex-shrink: 0; }
    .lb-av-wrap .online-dot { position: absolute; bottom: 0; right: 0; width: 11px; height: 11px; border: 2px solid var(--bg-secondary); }

    /* √âcran large : l√©g√®re animation au hover */
    @media (hover: hover) {
      .lb-item:hover {
        background: var(--bg-hover);
        transform: translateX(6px);
      }
      .lb-item.is-me:hover {
        background: linear-gradient(90deg, rgba(205,127,50,0.22) 0%, rgba(205,127,50,0.08) 100%);
      }
    }

    /* Desktop : on peut se permettre un peu plus d'espace */
    @media (min-width: 640px) {
      .lb-item { padding: 1rem 1.5rem; gap: 1.25rem; }
      .lb-header { padding: 0.6rem 1.5rem; gap: 1.25rem; }
      .lb-av { width: 48px; height: 48px; font-size: 1.125rem; }
      .lb-header-av { width: 48px; }
      .lb-name { font-size: 1rem; }
      .lb-score-val { font-size: 1.625rem; }
    }
  </style>
</head>
<body style="font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">

<nav class="nav nav-glass">
  <div class="nav-inner">
    <a href="/dashboard" class="nav-brand">
      <div class="logo-wrapper">
        <img src="{{ url_for('static', filename='images/logo.svg') }}" alt="">
        <div class="logo-pulse"></div>
      </div>
      <span class="brand-text">Baby-Foot Club</span>
    </a>
    <div class="nav-sep"></div>
    <div class="nav-links">
      <a href="/dashboard" class="nav-link"><span class="nav-link-icon" data-bficon="home" data-size="18" style="color:currentColor"></span><span>Dashboard</span></a>
      <a href="/reservation" class="nav-link"><span class="nav-link-icon" data-bficon="calendar" data-size="18" style="color:currentColor"></span><span>R√©server</span></a>
      <a href="/live-score" class="nav-link"><span class="nav-link-icon" data-bficon="gamepad" data-size="18" style="color:currentColor"></span><span>Partie Live</span></a>
      <a href="/stats" class="nav-link"><span class="nav-link-icon" data-bficon="stats" data-size="18" style="color:currentColor"></span><span>Stats</span></a>
      <a href="/top" class="nav-link active"><span class="nav-link-icon" data-bficon="trophy" data-size="18" style="color:currentColor"></span><span>Classement</span></a>
    </div>
    <button class="burger" id="burger" onclick="toggleMenu()" aria-label="Menu">
      <span></span><span></span><span></span>
    </button>
    <div class="nav-right">
      <div class="user-profile-mini">
        <div class="nav-avatar" id="navAv">?</div>
        <span class="nav-username" id="navUsername"></span>
      </div>
      <button class="btn btn-ghost" style="margin-left:1rem" onclick="logout()"><span data-bficon="logout" data-size="16" style="color:currentColor"></span> D√©connexion</button>
      <a href="/settings" class="btn btn-ghost" style="margin-left:0.5rem" title="Param√®tres">‚öôÔ∏è</a>
    </div>
  </div>
</nav>

<div class="mobile-menu" id="mobileMenu">
  <button class="mobile-menu-close" onclick="toggleMenu()">‚úï</button>
  <a href="/dashboard">üè† Dashboard</a>
  <a href="/reservation">üìÖ R√©server</a>
  <a href="/live-score">üéÆ Partie Live</a>
  <a href="/lobby">üë• Lobby</a>
  <a href="/stats">üìä Stats</a>
  <a href="/top" class="active">üèÜ Classement</a>
  <a href="/scores">üìã Historique</a>
  <a href="/settings">‚öôÔ∏è Param√®tres</a>
  <a href="#" onclick="logout()">üö™ D√©connexion</a>
  <button id="pwa-install-trigger" onclick="triggerPwaInstall()" style="display:none;width:100%;text-align:left;background:linear-gradient(135deg,rgba(205,127,50,0.15),rgba(205,127,50,0.05));border:1px solid rgba(205,127,50,0.4);color:#cd7f32;font-weight:700;font-size:1rem;padding:0.9rem 1.25rem;border-radius:10px;cursor:pointer;margin-top:0.5rem;font-family:inherit;">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:middle;margin-right:6px"><rect x="5" y="2" width="14" height="20" rx="2"/><path d="M9 13h6M12 10v6"/></svg>Installer l'app
  </button>
</div>

<div class="page">
  <div class="container" style="max-width:700px">
    <div class="page-header fade-up">
      <h1><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;display:inline-block;flex-shrink:0"><path d="M6 9H4a2 2 0 0 1-2-2V5h4"/><path d="M18 9h2a2 2 0 0 0 2-2V5h-4"/><path d="M8 21h8"/><path d="M12 17v4"/><path d="M6 5h12v8a6 6 0 0 1-12 0z"/></svg> Classement du Club</h1>
      <p>Tous les joueurs class√©s par buts marqu√©s ‚Äî montez dans le top et montrez qui domine !</p>
    </div>

    <div class="card fade-up" style="animation-delay:.05s;padding:0;overflow:hidden">
      <!-- En-t√™te colonnes -->
      <div class="lb-header">
        <div class="lb-header-rank">#</div>
        <div class="lb-header-av"></div>
        <div class="lb-header-info">Joueur</div>
        <div class="lb-header-score">Buts</div>
      </div>
      <!-- Liste -->
      <div class="lb-list" id="leaderboard">
        <div style="padding:3rem;text-align:center">
          <div class="loading-spinner" style="margin:0 auto 1rem"></div>
          <p style="color:var(--text-tertiary)">Chargement‚Ä¶</p>
        </div>
      </div>
    </div>

    <div style="text-align:center;margin-top:1.5rem;margin-bottom:2rem">
      <a href="/dashboard" class="btn btn-ghost">‚Üê Dashboard</a>
    </div>
  </div>
</div>

<script>
const PODIUM_ICONS = ['<span style="display:inline-flex;align-items:center;justify-content:center;width:26px;height:26px;border-radius:50%;background:#cd7f32;color:#000;font-size:0.7rem;font-weight:900;flex-shrink:0">1</span>', '<span style="display:inline-flex;align-items:center;justify-content:center;width:26px;height:26px;border-radius:50%;background:#888;color:#fff;font-size:0.7rem;font-weight:900;flex-shrink:0">2</span>', '<span style="display:inline-flex;align-items:center;justify-content:center;width:26px;height:26px;border-radius:50%;background:#7a5c3a;color:#fff;font-size:0.7rem;font-weight:900;flex-shrink:0">3</span>'];

function toggleMenu() {
  document.getElementById('burger').classList.toggle('open');
  document.getElementById('mobileMenu').classList.toggle('open');
  document.body.style.overflow = document.getElementById('mobileMenu').classList.contains('open') ? 'hidden' : '';
}

function logout() {
  fetch('/api/logout', {method:'POST'}).then(() => location.href = '/');
}

function ratio(goals, games) {
  if (!games) return '0.00';
  return (goals / games).toFixed(2);
}

fetch('/current_user').then(r => r.json()).then(d => {
  if (d && d.username) {
    ProfileUtils.updateNav(d);
    loadLeaderboard(d.username);
  }
});

const ELO_TIERS = [
  { name:'D√©butant',      icon:'üéÆ', min:0    },
  { name:'D√©butant+',     icon:'üå±', min:900  },
  { name:'Interm√©diaire', icon:'‚ö°', min:1000 },
  { name:'Confirm√©',      icon:'üî•', min:1100 },
  { name:'Expert',        icon:'üíé', min:1200 },
  { name:'L√©gende',       icon:'üëë', min:1400 },
];
function eloTier(elo) {
  for (let i = ELO_TIERS.length - 1; i >= 0; i--) {
    if (elo >= ELO_TIERS[i].min) return ELO_TIERS[i];
  }
  return ELO_TIERS[0];
}

async function loadLeaderboard(me) {
  const el = document.getElementById('leaderboard');
  try {
    let [lb, onlineRes] = await Promise.all([
      fetch('/leaderboard').then(r => r.json()),
      fetch('/api/online_users').then(r => r.json())
    ]);
    const onlineSet = new Set((onlineRes.online || []));
    // Filtre guest d√©j√† fait c√¥t√© serveur, mais s√©curit√© suppl√©mentaire
    lb = (lb || []).filter(p => p && p.username);

    if (!lb.length) {
      el.innerHTML = `<div style="padding:3rem;text-align:center">
        <p style="color:var(--text-tertiary)">Personne de class√© pour l'instant ‚Äî jouez une partie pour appara√Ætre ici !</p>
      </div>`;
      return;
    }

    el.innerHTML = lb.map((p, i) => {
      const rank = i + 1;
      const isMe = p.username === me;
      const isPodium = rank <= 3;
      const avClass = rank === 1 ? 'av1' : rank === 2 ? 'av2' : rank === 3 ? 'av3' : '';
      const games = p.total_games || 0;
      const wins = p.wins || 0;
      const elo = p.elo || 1000;
      const tier = eloTier(elo);
      const isOnline = onlineSet.has(p.username);
      const name = (p.nickname && p.nickname.trim()) ? p.nickname.trim() : p.username;
      const subName = (p.nickname && p.nickname.trim()) ? `<span style="font-size:0.7rem;color:var(--text-muted)">${p.username}</span>` : '';

      // Avatar
      let avContent;
      if (p.avatar_url) {
        avContent = `<img src="${p.avatar_url}" style="width:100%;height:100%;object-fit:cover;border-radius:50%" alt="">`;
      } else if (p.avatar_preset) {
        avContent = p.avatar_preset;
      } else {
        avContent = p.username[0].toUpperCase();
      }

      return `
        <div class="lb-item${isMe ? ' is-me' : ''}">
          <div class="lb-rank${isPodium ? ' podium' : ''}">
            ${isPodium ? PODIUM_ICONS[i] : '#' + rank}
          </div>
          <div class="lb-av-wrap">
            <div class="lb-av ${avClass}" style="overflow:hidden;display:flex;align-items:center;justify-content:center">${avContent}</div>
            ${isOnline ? '<span class="online-dot" title="En ligne"></span>' : ''}
          </div>
          <div class="lb-info">
            <div class="lb-name">
              ${name}${isMe ? '<span class="tag-me">vous</span>' : ''}
            </div>
            <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;margin-top:2px">
              ${subName}
              <span style="font-size:0.72rem;color:var(--text-muted)">${games} partie${games !== 1 ? 's' : ''} ¬∑ ${wins} victoire${wins !== 1 ? 's' : ''}</span>
            </div>
          </div>
          <div class="lb-score" style="text-align:right">
            <div style="display:flex;align-items:center;gap:4px;justify-content:flex-end">
              <span style="font-size:1rem">${tier.icon}</span>
              <div class="lb-score-val">${elo}</div>
            </div>
            <div class="lb-score-label">${tier.name}</div>
          </div>
        </div>
      `;
    }).join('');

  } catch(e) {
    el.innerHTML = `<div style="padding:3rem;text-align:center">
      <p style="color:var(--text-tertiary)">Impossible de charger le classement ‚Äî r√©essayez dans quelques instants</p>
    </div>`;
  }
}
</script>

<script src="{{ url_for('static', filename='icons.js') }}"></script>
<script src="{{ url_for('static', filename='profile-utils.js') }}"></script>
  <script src="/static/pwa.js" defer></script>
</body>
</html>
