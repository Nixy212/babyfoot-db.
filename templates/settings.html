<!DOCTYPE html>
<html lang="fr">
<head>
  <link rel="manifest" href="/static/manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="BabyFoot">
  <link rel="apple-touch-icon" href="/static/images/logo.svg">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Param√®tres ‚Äî Baby-Foot Club</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='responsive-mobile.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='style-extended.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='global-animations.css') }}">
  <script src="{{ url_for('static', filename='global-animations.js') }}" defer></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    .settings-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-normal);
      border-radius: 16px;
      overflow: hidden;
      margin-bottom: 1.5rem;
    }
    .settings-section-title {
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-tertiary);
      padding: 1.25rem 1.5rem 0.75rem;
      border-bottom: 1px solid var(--border-subtle);
    }
    .settings-row {
      padding: 1.25rem 1.5rem;
    }
    .pw-group {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      margin-bottom: 1.25rem;
    }
    .pw-input-wrap {
      position: relative;
    }
    .pw-input-wrap input {
      width: 100%;
      padding: 0.75rem 1rem;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-normal);
      border-radius: 10px;
      color: var(--text-primary);
      font-size: 0.9375rem;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
      box-sizing: border-box;
    }
    .pw-input-wrap input:focus {
      border-color: var(--bronze);
      box-shadow: 0 0 0 3px rgba(205,127,50,0.12);
    }
    .pw-label {
      font-size: 0.8125rem;
      font-weight: 600;
      color: var(--text-tertiary);
      margin-bottom: 0.3rem;
    }
    .pw-strength {
      height: 3px;
      border-radius: 99px;
      background: var(--border-subtle);
      overflow: hidden;
      margin-top: 0.35rem;
    }
    .pw-strength-bar {
      height: 100%;
      border-radius: 99px;
      transition: width 0.3s, background 0.3s;
      width: 0%;
    }
    .pw-strength-text {
      font-size: 0.7rem;
      margin-top: 0.2rem;
      height: 0.85rem;
      color: var(--text-muted);
    }
    .info-box {
      padding: 0.75rem 1rem;
      border-radius: 10px;
      background: rgba(205,127,50,0.07);
      border: 1px solid rgba(205,127,50,0.2);
      color: var(--text-secondary);
      font-size: 0.85rem;
      line-height: 1.5;
    }
    .info-box.blue {
      background: rgba(52,152,219,0.07);
      border-color: rgba(52,152,219,0.2);
    }
    .toast-settings {
      position: fixed;
      bottom: 1.5rem;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      align-items: center;
      pointer-events: none;
    }
    .toast-s {
      background: var(--bg-elevated);
      border: 1px solid var(--border-normal);
      border-radius: 10px;
      padding: 0.65rem 1.4rem;
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-primary);
      box-shadow: 0 4px 24px rgba(0,0,0,0.4);
      animation: tsIn 0.25s ease;
      white-space: nowrap;
    }
    .toast-s.ok  { border-color: rgba(39,174,96,.45); color: #2ecc71; }
    .toast-s.err { border-color: rgba(231,76,60,.45); color: #e74c3c; }
    @keyframes tsIn { from { opacity:0; transform:translateY(8px) } to { opacity:1; transform:translateY(0) } }

    .avatar-big {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      background: var(--gradient-bronze);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      font-weight: 800;
      color: white;
      margin-bottom: 1rem;
      box-shadow: 0 0 0 4px rgba(205,127,50,0.15);
    }
    .profile-header {
      display: flex;
      align-items: center;
      gap: 1.25rem;
      padding: 1.5rem;
      border-bottom: 1px solid var(--border-subtle);
    }
    .profile-name { font-size: 1.25rem; font-weight: 800; color: var(--text-primary); }
    .profile-role { font-size: 0.8rem; color: var(--text-tertiary); margin-top: 2px; }

    /* Avatar picker */
    .avatar-section { display:flex; align-items:center; gap:1.5rem; margin-bottom:1.5rem; flex-wrap:wrap; }
    .avatar-preview-wrap { position:relative; cursor:pointer; }
    .avatar-preview-big {
      width:80px; height:80px; border-radius:50%;
      background:linear-gradient(135deg,#cd7f32,#b8732f);
      display:flex; align-items:center; justify-content:center;
      font-size:2rem; border:3px solid var(--border-accent);
      overflow:hidden; position:relative;
    }
    .avatar-preview-big img { width:100%; height:100%; object-fit:cover; }
    .avatar-preview-big .avatar-edit-overlay {
      position:absolute; inset:0; background:rgba(0,0,0,0.5);
      display:flex; align-items:center; justify-content:center;
      opacity:0; transition:opacity .2s; font-size:1.2rem;
    }
    .avatar-preview-wrap:hover .avatar-edit-overlay { opacity:1; }
    .avatar-presets { display:flex; gap:0.6rem; flex-wrap:wrap; }
    .avatar-preset-btn {
      width:44px; height:44px; border-radius:50%; border:2px solid transparent;
      background:var(--bg-tertiary); font-size:1.3rem; cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      transition:all .15s; flex-shrink:0;
    }
    .avatar-preset-btn:hover { border-color:var(--border-accent); transform:scale(1.1); }
    .avatar-preset-btn.selected { border-color:#cd7f32; background:rgba(205,127,50,0.15); }
    /* ELO badge */
    .elo-badge {
      display:inline-flex; align-items:center; gap:0.5rem;
      padding:0.6rem 1.2rem; border-radius:12px;
      background:linear-gradient(135deg,rgba(205,127,50,0.15),rgba(205,127,50,0.05));
      border:1px solid rgba(205,127,50,0.3);
    }
    .elo-value { font-size:1.8rem; font-weight:800; color:#cd7f32; line-height:1; }
    .elo-info { display:flex; flex-direction:column; }
    .elo-tier { font-size:0.9rem; font-weight:700; color:var(--text-primary); }
    .elo-label { font-size:0.72rem; color:var(--text-muted); }
    /* Input perso */
    .perso-input {
      width:100%; padding:0.75rem 1rem; border-radius:10px;
      border:1px solid var(--border-normal); background:var(--bg-tertiary);
      color:var(--text-primary); font-size:0.9rem; font-family:inherit;
      transition:border-color .15s; box-sizing:border-box;
    }
    .perso-input:focus { outline:none; border-color:#cd7f32; }
    .perso-label { font-size:0.8rem; font-weight:600; color:var(--text-secondary); margin-bottom:0.4rem; }
    .char-count { font-size:0.72rem; color:var(--text-muted); text-align:right; margin-top:0.3rem; }
  </style>
</head>
<body style="font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">

<nav class="nav nav-glass">
  <div class="nav-inner">
    <a href="/dashboard" class="nav-brand">
      <div class="logo-wrapper">
        <img src="{{ url_for('static', filename='images/logo.svg') }}" alt="">
        <div class="logo-pulse"></div>
      </div>
      <span class="brand-text">Baby-Foot Club</span>
    </a>
    <div class="nav-sep"></div>
    <div class="nav-links">
      <a href="/dashboard" class="nav-link"><span data-bficon="home" data-size="18" style="color:currentColor"></span><span>Dashboard</span></a>
      <a href="/reservation" class="nav-link"><span data-bficon="calendar" data-size="18" style="color:currentColor"></span><span>R√©server</span></a>
      <a href="/live-score" class="nav-link"><span data-bficon="gamepad" data-size="18" style="color:currentColor"></span><span>Partie Live</span></a>
      <a href="/stats" class="nav-link"><span data-bficon="stats" data-size="18" style="color:currentColor"></span><span>Stats</span></a>
      <a href="/top" class="nav-link"><span data-bficon="trophy" data-size="18" style="color:currentColor"></span><span>Classement</span></a>
    </div>
    <button class="burger" id="burger" onclick="toggleMenu()" aria-label="Menu">
      <span></span><span></span><span></span>
    </button>
    <div class="nav-right">
      <div class="user-profile-mini">
        <div class="nav-avatar" id="navAv">?</div>
        <span class="nav-username" id="navUsername"></span>
      </div>
      <button class="btn btn-ghost" style="margin-left:1rem" onclick="logout()">D√©connexion</button>
    </div>
  </div>
</nav>

<div class="mobile-menu" id="mobileMenu">
  <button class="mobile-menu-close" onclick="toggleMenu()">‚úï</button>
  <a href="/dashboard">üè† Dashboard</a>
  <a href="/reservation">üìÖ R√©server</a>
  <a href="/live-score">üéÆ Partie Live</a>
  <a href="/lobby">üë• Lobby</a>
  <a href="/stats">üìä Stats</a>
  <a href="/top">üèÜ Classement</a>
  <a href="/scores">üìã Historique</a>
  <a href="/settings" class="active">‚öôÔ∏è Param√®tres</a>
  <a href="#" onclick="logout()">üö™ D√©connexion</a>
</div>

<div class="page">
  <div class="container" style="max-width:600px">
    <div class="page-header fade-up">
      <h1>‚öôÔ∏è Param√®tres</h1>
      <p>G√©rez votre compte et vos pr√©f√©rences</p>
    </div>

    <!-- Profil -->
    <div class="settings-card fade-up" style="animation-delay:.03s">
      <div class="profile-header">
        <div class="avatar-big" id="profileAv">?</div>
        <div>
          <div class="profile-name" id="profileName">‚Äî</div>
          <div class="profile-role" id="profileRole" style="display:none">Joueur</div>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ PERSONNALISATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div class="settings-card fade-up" style="animation-delay:.06s">
      <div class="settings-section-title">üé® Personnaliser mon profil</div>
      <div class="settings-row">

        <!-- Avatar -->
        <div class="perso-label" style="margin-bottom:0.75rem">Photo de profil</div>
        <div class="avatar-section">
          <div class="avatar-preview-wrap" onclick="document.getElementById('avatarFileInput').click()">
            <div class="avatar-preview-big" id="avatarPreviewBig">
              <span id="avatarPreviewEmoji">?</span>
              <img id="avatarPreviewImg" src="" style="display:none">
              <div class="avatar-edit-overlay">‚úèÔ∏è</div>
            </div>
          </div>
          <div>
            <div style="font-size:0.8rem;color:var(--text-muted);margin-bottom:0.6rem">Choisir un avatar</div>
            <div class="avatar-presets" id="avatarPresets">
              <button class="avatar-preset-btn" data-preset="‚öΩ" onclick="selectPreset('‚öΩ')">‚öΩ</button>
              <button class="avatar-preset-btn" data-preset="üèÜ" onclick="selectPreset('üèÜ')">üèÜ</button>
              <button class="avatar-preset-btn" data-preset="üî•" onclick="selectPreset('üî•')">üî•</button>
              <button class="avatar-preset-btn" data-preset="‚ö°" onclick="selectPreset('‚ö°')">‚ö°</button>
              <button class="avatar-preset-btn" data-preset="üëë" onclick="selectPreset('üëë')">üëë</button>
              <button class="avatar-preset-btn" data-preset="üíé" onclick="selectPreset('üíé')">üíé</button>
              <button class="avatar-preset-btn" data-preset="üéØ" onclick="selectPreset('üéØ')">üéØ</button>
              <button class="avatar-preset-btn" data-preset="ü¶Å" onclick="selectPreset('ü¶Å')">ü¶Å</button>
            </div>
            <div style="margin-top:0.6rem">
              <button class="btn btn-ghost" style="font-size:0.8rem;padding:0.4rem 0.8rem" onclick="document.getElementById('avatarFileInput').click()">
                üì∑ Uploader une photo
              </button>
            </div>
          </div>
        </div>
        <input type="file" id="avatarFileInput" accept="image/*,.heic,.heif" style="display:none" onchange="handleAvatarUpload(this)">

        <!-- Surnom -->
        <div style="margin-bottom:1rem">
          <div class="perso-label">Surnom affich√© en jeu</div>
          <input type="text" class="perso-input" id="nicknameInput" maxlength="30"
                 placeholder="Ton surnom (laisser vide = username)"
                 oninput="document.getElementById('nicknameCount').textContent=this.value.length+'/30'">
          <div class="char-count" id="nicknameCount">0/30</div>
        </div>

        <!-- Citation -->
        <div style="margin-bottom:1.5rem">
          <div class="perso-label">Citation / statut</div>
          <textarea class="perso-input" id="bioInput" maxlength="120" rows="2"
                    placeholder="Ta devise de joueur..."
                    oninput="document.getElementById('bioCount').textContent=this.value.length+'/120'"
                    style="resize:none"></textarea>
          <div class="char-count" id="bioCount">0/120</div>
        </div>

        <button class="btn btn-primary btn-full" onclick="saveProfile()" id="btnSaveProfile">
          Sauvegarder le profil
        </button>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ ELO / NIVEAU ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div class="settings-card fade-up" style="animation-delay:.09s">
      <div class="settings-section-title">üìä Mon niveau</div>
      <div class="settings-row">
        <!-- Badge niveau actuel -->
        <div style="display:flex;align-items:center;gap:1.5rem;flex-wrap:wrap;margin-bottom:1.25rem">
          <div class="elo-badge">
            <span id="eloIcon" style="font-size:2rem">üéÆ</span>
            <div class="elo-info">
              <span class="elo-value" id="eloValue">1000</span>
              <span class="elo-tier" id="eloTier">D√©butant+</span>
              <span class="elo-label">Points ELO</span>
            </div>
          </div>
          <div style="flex:1;min-width:180px">
            <div id="eloDesc" style="font-size:0.82rem;color:var(--text-muted);margin-bottom:0.6rem;font-style:italic"></div>
            <div style="background:var(--bg-tertiary);border-radius:8px;height:8px;overflow:hidden">
              <div id="eloProgressBar" style="height:100%;border-radius:8px;background:linear-gradient(90deg,#cd7f32,#ffd700);transition:width .5s"></div>
            </div>
            <div style="display:flex;justify-content:space-between;font-size:0.72rem;color:var(--text-muted);margin-top:0.4rem">
              <span id="eloMin"></span><span id="eloMax"></span>
            </div>
          </div>
        </div>

        <!-- Explication syst√®me ELO babyfoot -->
        <div style="background:var(--bg-tertiary);border-radius:12px;padding:1rem 1.25rem;margin-bottom:1.25rem;font-size:0.82rem;color:var(--text-muted);line-height:1.6">
          <div style="font-weight:700;color:var(--text-primary);margin-bottom:0.5rem">üí° Comment fonctionne l'ELO ?</div>
          <div>Chaque joueur commence √† <strong style="color:#cd7f32">1000 points</strong>. Apr√®s chaque partie :</div>
          <ul style="margin:0.5rem 0 0.5rem 1rem;padding:0">
            <li>Tu <strong style="color:#2ecc71">gagnes des points</strong> si tu bats quelqu'un de fort</li>
            <li>Tu <strong style="color:#e74c3c">perds des points</strong> si tu perds contre quelqu'un de moins bon</li>
            <li>Battre un expert vaut plus que battre un d√©butant</li>
          </ul>
          <div>Un gain typique est de <strong style="color:#cd7f32">¬±5 √† ¬±10 pts</strong> par partie selon le niveau des adversaires.</div>
        </div>

        <!-- Tableau de tous les niveaux -->
        <div style="font-weight:700;color:var(--text-primary);font-size:0.875rem;margin-bottom:0.75rem">üèÖ Tous les niveaux</div>
        <div id="eloTiersGrid" style="display:flex;flex-direction:column;gap:0.5rem"></div>
      </div>
    </div>

    <!-- Changement de mot de passe -->
    <div class="settings-card fade-up" style="animation-delay:.12s">
      <div class="settings-section-title">üîí Changer le mot de passe</div>
      <div class="settings-row">
        <div class="pw-group">
          <div>
            <div class="pw-label">Mot de passe actuel</div>
            <div class="pw-input-wrap">
              <input type="password" id="curPw" placeholder="Votre mot de passe actuel" autocomplete="current-password">
            </div>
          </div>
          <div>
            <div class="pw-label">Nouveau mot de passe</div>
            <div class="pw-input-wrap">
              <input type="password" id="newPw" placeholder="Min. 6 caract√®res" autocomplete="new-password" oninput="checkStrength(this.value)">
            </div>
            <div class="pw-strength"><div class="pw-strength-bar" id="strengthBar"></div></div>
            <div class="pw-strength-text" id="strengthText"></div>
          </div>
          <div>
            <div class="pw-label">Confirmer le nouveau mot de passe</div>
            <div class="pw-input-wrap">
              <input type="password" id="confirmPw" placeholder="R√©p√©tez le nouveau mot de passe" autocomplete="new-password">
            </div>
          </div>
        </div>
        <button class="btn btn-primary btn-full" onclick="changePassword()" id="btnChangePw">
          Mettre √† jour le mot de passe
        </button>
      </div>
    </div>

    <!-- Google / Email (info) -->
    <div class="settings-card fade-up" style="animation-delay:.09s">
      <div class="settings-section-title">üìß Mot de passe oubli√© ?</div>
      <div class="settings-row">
        <div class="info-box blue">
          Contactez un membre du club pour r√©initialiser votre mot de passe.
        </div>
      </div>
    </div>

    <div style="text-align:center;margin-top:1rem;margin-bottom:2rem">
      <a href="/dashboard" class="btn btn-ghost">‚Üê Dashboard</a>
    </div>
  </div>
</div>

<div class="toast-settings" id="toastWrap"></div>

<script src="{{ url_for('static', filename='profile-utils.js') }}"></script>
<script>
function toggleMenu() {
  document.getElementById('burger').classList.toggle('open');
  document.getElementById('mobileMenu').classList.toggle('open');
  document.body.style.overflow = document.getElementById('mobileMenu').classList.contains('open') ? 'hidden' : '';
}
function logout() {
  fetch('/api/logout', {method:'POST'}).then(() => location.href = '/');
}

function toast(msg, type = 'ok') {
  const wrap = document.getElementById('toastWrap');
  const t = document.createElement('div');
  t.className = `toast-s ${type}`;
  t.textContent = msg;
  wrap.appendChild(t);
  setTimeout(() => t.remove(), 4000);
}

function checkStrength(v) {
  const bar = document.getElementById('strengthBar');
  const txt = document.getElementById('strengthText');
  if (!v) { bar.style.width = '0%'; txt.textContent = ''; return; }
  let score = 0;
  if (v.length >= 6) score++;
  if (v.length >= 10) score++;
  if (/[A-Z]/.test(v)) score++;
  if (/[0-9]/.test(v)) score++;
  if (/[^A-Za-z0-9]/.test(v)) score++;
  const levels = [
    { w: '20%', bg: '#e74c3c', label: 'Tr√®s faible' },
    { w: '40%', bg: '#e67e22', label: 'Faible' },
    { w: '60%', bg: '#f1c40f', label: 'Moyen' },
    { w: '80%', bg: '#27ae60', label: 'Fort' },
    { w: '100%', bg: '#2ecc71', label: 'Tr√®s fort' },
  ];
  const l = levels[Math.min(score - 1, 4)] || levels[0];
  bar.style.width = l.w;
  bar.style.background = l.bg;
  txt.textContent = l.label;
  txt.style.color = l.bg;
}

async function changePassword() {
  const cur = document.getElementById('curPw').value;
  const nw  = document.getElementById('newPw').value;
  const cnf = document.getElementById('confirmPw').value;

  if (!cur || !nw || !cnf) { toast('Tous les champs sont requis', 'err'); return; }
  if (nw !== cnf) { toast('Les deux nouveaux mots de passe ne correspondent pas', 'err'); return; }
  if (nw.length < 6) { toast('Nouveau mot de passe trop court (min. 6 caract√®res)', 'err'); return; }

  const btn = document.getElementById('btnChangePw');
  btn.disabled = true;
  btn.textContent = 'Mise √† jour‚Ä¶';

  try {
    const res = await fetch('/api/change_password', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ current_password: cur, new_password: nw })
    });
    const data = await res.json();
    if (data.success) {
      toast('‚úì ' + data.message, 'ok');
      document.getElementById('curPw').value = '';
      document.getElementById('newPw').value = '';
      document.getElementById('confirmPw').value = '';
      document.getElementById('strengthBar').style.width = '0%';
      document.getElementById('strengthText').textContent = '';
    } else {
      toast('‚úï ' + data.message, 'err');
    }
  } catch(e) {
    toast('Erreur r√©seau', 'err');
  } finally {
    btn.disabled = false;
    btn.textContent = 'Mettre √† jour le mot de passe';
  }
}

// ‚îÄ‚îÄ ELO tiers (synchronis√© avec le backend) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const ELO_TIERS = [
  { name:'D√©butant üéÆ',       icon:'üéÆ', min:800,  max:949,  desc:'Tu apprends les bases, chaque partie compte !' },
  { name:'D√©butant+ üå±',      icon:'üå±', min:950,  max:1049, desc:'La technique commence √† se voir, continue !' },
  { name:'Interm√©diaire üî•',  icon:'üî•', min:1050, max:1199, desc:'Tu contr√¥les le jeu et tu gagnes r√©guli√®rement.' },
  { name:'Confirm√© ‚ö°',        icon:'‚ö°', min:1200, max:1349, desc:'Adversaire redoutable ‚Äî tout le monde le sait.' },
  { name:'Expert üíé',          icon:'üíé', min:1350, max:1499, desc:'Top 5 du club, s√©rieusement.' },
  { name:'Ma√Ætre üèÜ',          icon:'üèÜ', min:1500, max:9999, desc:'Imbattable. La table te appartient.' },
];
function getEloTier(elo) {
  for (let i = ELO_TIERS.length - 1; i >= 0; i--) {
    if (elo >= ELO_TIERS[i].min) return ELO_TIERS[i];
  }
  return ELO_TIERS[0];
}

// ‚îÄ‚îÄ Avatar state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let currentPreset = '';
let currentAvatarUrl = '';

function renderAvatarPreview() {
  const emoji = document.getElementById('avatarPreviewEmoji');
  const img   = document.getElementById('avatarPreviewImg');
  if (currentAvatarUrl) {
    img.src = currentAvatarUrl; img.style.display = 'block'; emoji.style.display = 'none';
  } else if (currentPreset) {
    emoji.textContent = currentPreset; emoji.style.display = 'block'; img.style.display = 'none';
  } else {
    emoji.textContent = (window._me || '?')[0].toUpperCase(); emoji.style.display = 'block'; img.style.display = 'none';
  }
  // Mettre √† jour la nav via ProfileUtils
  if (window._me) {
    ProfileUtils.updateNav({
      username: window._me,
      nickname: document.getElementById('nicknameInput')?.value || '',
      avatar_url: currentAvatarUrl,
      avatar_preset: currentPreset,
    });
  }
}

function selectPreset(emoji) {
  currentPreset = emoji; currentAvatarUrl = '';
  document.querySelectorAll('.avatar-preset-btn').forEach(b => b.classList.toggle('selected', b.dataset.preset === emoji));
  renderAvatarPreview();
}

async function handleAvatarUpload(input) {
  const file = input.files[0];
  if (!file) return;

  // V√©rif taille brute (avant compression)
  if (file.size > 50 * 1024 * 1024) { toast('Fichier trop volumineux (max 50 Mo)', 'err'); return; }

  toast('‚è≥ Compression en cours‚Ä¶', 'info');

  try {
    // Compresser via canvas : redimensionner √† max 400x400px, qualit√© 85% JPEG
    const compressed = await compressImage(file, 400, 0.85);

    const res = await fetch('/api/upload_avatar', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ image: compressed })
    });
    const data = await res.json();
    if (data.success) {
      currentAvatarUrl = data.avatar_url;
      currentPreset = '';
      document.querySelectorAll('.avatar-preset-btn').forEach(b => b.classList.remove('selected'));
      renderAvatarPreview();
      toast('‚úì Photo enregistr√©e !', 'ok');
    } else {
      toast('Erreur : ' + (data.error || 'Impossible d\'uploader'), 'err');
    }
  } catch(e) {
    console.error(e);
    toast('Erreur lors de la compression ‚Äî r√©essayez', 'err');
  }
  // R√©initialiser l'input pour permettre de re-s√©lectionner le m√™me fichier
  input.value = '';
}

function compressImage(file, maxSize, quality) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onerror = reject;
    reader.onload = (e) => {
      const img = new Image();
      img.onerror = reject;
      img.onload = () => {
        const canvas = document.createElement('canvas');
        let w = img.width, h = img.height;

        // Redimensionner si n√©cessaire (max maxSize px dans la plus grande dimension)
        if (w > maxSize || h > maxSize) {
          if (w > h) { h = Math.round(h * maxSize / w); w = maxSize; }
          else       { w = Math.round(w * maxSize / h); h = maxSize; }
        }
        canvas.width  = w;
        canvas.height = h;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, w, h);
        resolve(canvas.toDataURL('image/jpeg', quality));
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  });
}

async function saveProfile() {
  const nickname = document.getElementById('nicknameInput').value.trim();
  const bio = document.getElementById('bioInput').value.trim();
  const btn = document.getElementById('btnSaveProfile');
  btn.disabled = true; btn.textContent = 'Sauvegarde‚Ä¶';
  try {
    const res = await fetch('/api/profile', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ nickname, bio, avatar_preset: currentPreset })
    });
    const data = await res.json();
    if (data.success) {
      toast('‚úì Profil sauvegard√©', 'ok');
      // Mettre √† jour la nav imm√©diatement
      renderAvatarPreview();
      // Mettre √† jour profileName si surnom renseign√©
      const profName = document.getElementById('profileName');
      if (profName) profName.textContent = nickname || window._me;
    } else {
      toast('Erreur: ' + (data.error || '?'), 'err');
    }
  } catch(e) { toast('Erreur r√©seau', 'err'); }
  finally { btn.disabled = false; btn.textContent = 'Sauvegarder le profil'; }
}

function renderElo(elo) {
  const tier = getEloTier(elo);
  document.getElementById('eloValue').textContent = elo;
  document.getElementById('eloTier').textContent = tier.name;
  document.getElementById('eloIcon').textContent = tier.icon;
  if (document.getElementById('eloDesc')) document.getElementById('eloDesc').textContent = tier.desc;
  const pct = tier.max >= 9999 ? 100 : Math.round((elo - tier.min) / (tier.max - tier.min + 1) * 100);
  document.getElementById('eloProgressBar').style.width = pct + '%';
  document.getElementById('eloMin').textContent = tier.min + ' pts';
  document.getElementById('eloMax').textContent = tier.max >= 9999 ? 'MAX üèÜ' : tier.max + ' pts';

  // Grille de tous les niveaux
  const grid = document.getElementById('eloTiersGrid');
  if (grid) {
    grid.innerHTML = ELO_TIERS.map(t => {
      const isCurrent = (elo >= t.min && elo <= t.max);
      return `<div style="display:flex;align-items:center;gap:0.75rem;padding:0.6rem 0.875rem;border-radius:10px;
        background:${isCurrent ? 'rgba(205,127,50,0.15)' : 'var(--bg-tertiary)'};
        border:1px solid ${isCurrent ? 'rgba(205,127,50,0.5)' : 'var(--border-subtle)'};
        transition:all 0.2s">
        <span style="font-size:1.5rem;flex-shrink:0">${t.icon}</span>
        <div style="flex:1">
          <div style="font-weight:700;font-size:0.875rem;color:${isCurrent ? '#cd7f32' : 'var(--text-primary)'}">
            ${t.name}${isCurrent ? ' <span style="font-size:0.7rem;padding:1px 6px;background:rgba(205,127,50,0.25);border-radius:4px;margin-left:4px">MON NIVEAU</span>' : ''}
          </div>
          <div style="font-size:0.75rem;color:var(--text-muted)">${t.desc}</div>
        </div>
        <div style="text-align:right;font-size:0.75rem;color:var(--text-muted);flex-shrink:0;white-space:nowrap">
          ${t.min}${t.max >= 9999 ? '+' : '‚Äì' + t.max} pts
        </div>
      </div>`;
    }).join('');
  }
}

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function init() {
  const userRes = await fetch('/current_user');
  const user = await userRes.json();
  if (!user || !user.username) { location.href = '/login'; return; }
  window._me = user.username;
  document.getElementById('navUsername').textContent = user.username;
  document.getElementById('profileName').textContent = user.username;

  // Charger le profil
  const profRes = await fetch('/api/profile');
  const prof = await profRes.json();
  currentPreset = prof.avatar_preset || '';
  currentAvatarUrl = prof.avatar_url || '';
  document.getElementById('nicknameInput').value = prof.nickname || '';
  document.getElementById('nicknameCount').textContent = (prof.nickname || '').length + '/30';
  document.getElementById('bioInput').value = prof.bio || '';
  document.getElementById('bioCount').textContent = (prof.bio || '').length + '/120';

  // Preset s√©lectionn√©
  if (currentPreset) {
    document.querySelectorAll('.avatar-preset-btn').forEach(b => {
      if (b.dataset.preset === currentPreset) b.classList.add('selected');
    });
  }
  renderAvatarPreview();
  renderElo(prof.elo || 1000);

  // Profil header
  // Update profile header avatar + nav after load
  renderAvatarPreview();
  // Also update profile header card
  const profAv = document.getElementById('profileAv');
  if (profAv) {
    if (currentAvatarUrl) {
      profAv.innerHTML = `<img src="${currentAvatarUrl}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`;
    } else {
      profAv.textContent = currentPreset || user.username[0].toUpperCase();
    }
  }
}
init();
</script>

<script src="{{ url_for('static', filename='icons.js') }}"></script>
<script src="/static/pwa.js" defer></script>
</body>
</html>
