<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin â€” Baby-Foot Club</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>
<nav class="nav nav-glass">
  <div class="nav-inner">
    <a href="/dashboard" class="nav-brand">
      <span class="brand-text">Baby-Foot Club - ADMIN</span>
    </a>
    <div class="nav-right">
      <button class="btn btn-ghost" onclick="logout()">ğŸšª</button>
    </div>
  </div>
</nav>

<div class="page">
  <div class="container" style="max-width:600px">
    <div class="page-header">
      <h1>âš™ï¸ Administration</h1>
      <p>Outils de gestion</p>
    </div>

    <!-- NOUVELLE SECTION : CONTRÃ”LE DES SERVOS -->
    <div class="card" style="margin-top:2rem">
      <div class="card-header" style="background:#e8f4fd;border-bottom:2px solid #3498db">
        <h3 style="color:#3498db;margin:0">ğŸ”§ ContrÃ´le des Servos</h3>
      </div>
      <div class="card-body">
        <p style="color:var(--text-tertiary);margin-bottom:1.5rem">
          DÃ©verrouiller manuellement les servomoteurs pour libÃ©rer les balles bloquÃ©es.
          Les servos se reverrouillent automatiquement aprÃ¨s 5 secondes.
        </p>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1rem">
          <button 
            class="btn" 
            style="background:#3498db;color:white;width:100%;padding:1rem" 
            onclick="unlockServo1()"
            id="btnServo1">
            ğŸ”“ Servo 1<br><small>(Ã‰quipe 1)</small>
          </button>
          
          <button 
            class="btn" 
            style="background:#3498db;color:white;width:100%;padding:1rem" 
            onclick="unlockServo2()"
            id="btnServo2">
            ğŸ”“ Servo 2<br><small>(Ã‰quipe 2)</small>
          </button>
        </div>
        
        <div id="servo-result" style="margin-top:1rem;padding:1rem;border-radius:8px;display:none"></div>
      </div>
    </div>

    <div class="card" style="margin-top:2rem">
      <div class="card-header" style="background:#fee;border-bottom:2px solid #e74c3c">
        <h3 style="color:#e74c3c;margin:0">ğŸ”¥ ZONE DANGER</h3>
      </div>
      <div class="card-body">
        <h4 style="margin-top:0">Reset de la base de donnÃ©es</h4>
        <p style="color:var(--text-tertiary);margin-bottom:1.5rem">
          âš ï¸ Cette action va supprimer TOUTES les donnÃ©es (utilisateurs, scores, rÃ©servations) 
          et recrÃ©er uniquement les comptes de base (admins, test, invitÃ©s).
        </p>
        <p style="color:var(--text-tertiary);margin-bottom:1.5rem">
          <strong>Cette action est IRRÃ‰VERSIBLE !</strong>
        </p>
        <button class="btn" style="background:#e74c3c;color:white;width:100%" onclick="resetDatabase()">
          ğŸ—‘ï¸ RESET COMPLET DE LA BASE
        </button>
        <div id="result" style="margin-top:1rem;padding:1rem;border-radius:8px;display:none"></div>
      </div>
    </div>

    <div style="text-align:center;margin-top:2rem">
      <a href="/dashboard" class="btn btn-ghost">â† Retour</a>
    </div>
  </div>
</div>

<script>
// Initialiser Socket.IO pour les commandes servos
const socket = io();

socket.on('connect', () => {
  console.log('âœ… Socket.IO connectÃ©');
});

socket.on('disconnect', () => {
  console.log('âŒ Socket.IO dÃ©connectÃ©');
});

// Fonction de dÃ©verrouillage Servo 1
function unlockServo1() {
  const btn = document.getElementById('btnServo1');
  const result = document.getElementById('servo-result');
  
  btn.disabled = true;
  btn.style.opacity = '0.5';
  btn.innerHTML = 'â³ En cours...<br><small>(Ã‰quipe 1)</small>';
  
  result.style.display = 'block';
  result.style.background = 'rgba(52, 152, 219, 0.1)';
  result.style.border = '1px solid #3498db';
  result.style.color = 'var(--text-primary)';
  result.textContent = 'ğŸ”“ DÃ©verrouillage du Servo 1 en cours... (5 secondes)';
  
  socket.emit('unlock_servo1');
  
  setTimeout(() => {
    btn.disabled = false;
    btn.style.opacity = '1';
    btn.innerHTML = 'ğŸ”“ Servo 1<br><small>(Ã‰quipe 1)</small>';
    
    result.style.background = 'rgba(39, 174, 96, 0.1)';
    result.style.border = '1px solid #27ae60';
    result.textContent = 'âœ… Servo 1 reverrouillÃ© automatiquement';
    
    setTimeout(() => {
      result.style.display = 'none';
    }, 3000);
  }, 5000);
}

// Fonction de dÃ©verrouillage Servo 2
function unlockServo2() {
  const btn = document.getElementById('btnServo2');
  const result = document.getElementById('servo-result');
  
  btn.disabled = true;
  btn.style.opacity = '0.5';
  btn.innerHTML = 'â³ En cours...<br><small>(Ã‰quipe 2)</small>';
  
  result.style.display = 'block';
  result.style.background = 'rgba(52, 152, 219, 0.1)';
  result.style.border = '1px solid #3498db';
  result.style.color = 'var(--text-primary)';
  result.textContent = 'ğŸ”“ DÃ©verrouillage du Servo 2 en cours... (5 secondes)';
  
  socket.emit('unlock_servo2');
  
  setTimeout(() => {
    btn.disabled = false;
    btn.style.opacity = '1';
    btn.innerHTML = 'ğŸ”“ Servo 2<br><small>(Ã‰quipe 2)</small>';
    
    result.style.background = 'rgba(39, 174, 96, 0.1)';
    result.style.border = '1px solid #27ae60';
    result.textContent = 'âœ… Servo 2 reverrouillÃ© automatiquement';
    
    setTimeout(() => {
      result.style.display = 'none';
    }, 3000);
  }, 5000);
}

// Gestion des erreurs Socket.IO
socket.on('error', (data) => {
  const result = document.getElementById('servo-result');
  result.style.display = 'block';
  result.style.background = 'rgba(231, 76, 60, 0.1)';
  result.style.border = '1px solid #e74c3c';
  result.textContent = 'âŒ Erreur : ' + data.message;
  
  setTimeout(() => {
    result.style.display = 'none';
  }, 5000);
});

function logout() {
  fetch('/api/logout', {method: 'POST'}).then(() => location.href = '/');
}

async function resetDatabase() {
  const confirmed = confirm(
    'âš ï¸ ATTENTION âš ï¸\n\n' +
    'Vous allez SUPPRIMER TOUTES LES DONNÃ‰ES :\n' +
    '- Tous les utilisateurs (sauf admins/test/invitÃ©s)\n' +
    '- Tous les scores et statistiques\n' +
    '- Toutes les rÃ©servations\n\n' +
    'Cette action est IRRÃ‰VERSIBLE !\n\n' +
    'ÃŠtes-vous ABSOLUMENT SÃ›R ?'
  );
  
  if (!confirmed) return;
  
  const doubleCheck = confirm(
    'DerniÃ¨re confirmation :\n\n' +
    'Tapez OK pour VRAIMENT supprimer toutes les donnÃ©es.'
  );
  
  if (!doubleCheck) return;
  
  const result = document.getElementById('result');
  result.style.display = 'block';
  result.style.background = 'rgba(255,191,0,0.1)';
  result.style.border = '1px solid #ffbf00';
  result.style.color = 'var(--text-primary)';
  result.textContent = 'â³ Reset en cours...';
  
  try {
    const res = await fetch('/admin/reset_database', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'}
    });
    
    const data = await res.json();
    
    if (data.success) {
      result.style.background = 'rgba(39,174,96,0.1)';
      result.style.border = '1px solid #27ae60';
      result.textContent = 'âœ… Base de donnÃ©es rÃ©initialisÃ©e ! Redirection...';
      
      setTimeout(() => {
        location.href = '/dashboard';
      }, 2000);
    } else {
      result.style.background = 'rgba(231,76,60,0.1)';
      result.style.border = '1px solid #e74c3c';
      result.textContent = 'âŒ Erreur : ' + data.message;
    }
  } catch (e) {
    result.style.background = 'rgba(231,76,60,0.1)';
    result.style.border = '1px solid #e74c3c';
    result.textContent = 'âŒ Erreur rÃ©seau : ' + e.message;
  }
}
</script>
</body>
</html>
