<!DOCTYPE html>

<html lang="fr">
<head>
  <link rel="manifest" href="/static/manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="BabyFoot">
  <link rel="apple-touch-icon" href="/static/images/logo.svg">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin â€” Baby-Foot Club</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='responsive-mobile.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='style-extended.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='global-animations.css') }}">
  <script src="{{ url_for('static', filename='global-animations.js') }}" defer></script>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
</head>
<body style="font-family: 'DM Sans', sans-serif;">

<nav class="nav nav-glass">
  <div class="nav-inner">
    <a href="/dashboard" class="nav-brand">
      <div class="logo-wrapper">
        <img src="{{ url_for('static', filename='images/logo.svg') }}" alt="">
        <div class="logo-pulse"></div>
      </div>
      <span class="brand-text">Baby-Foot Club</span>
    </a>
    <div class="nav-sep"></div>
    <div class="nav-links">
      <a href="/dashboard" class="nav-link"><span class="nav-link-icon" data-bficon="home" data-size="18" style="color:currentColor"></span><span>Dashboard</span></a>
      <a href="/reservation" class="nav-link"><span class="nav-link-icon" data-bficon="calendar" data-size="18" style="color:currentColor"></span><span>RÃ©server</span></a>
      <a href="/live-score" class="nav-link"><span class="nav-link-icon" data-bficon="gamepad" data-size="18" style="color:currentColor"></span><span>Partie Live</span></a>
      <a href="/stats" class="nav-link"><span class="nav-link-icon" data-bficon="stats" data-size="18" style="color:currentColor"></span><span>Stats</span></a>
      <a href="/top" class="nav-link"><span class="nav-link-icon" data-bficon="trophy" data-size="18" style="color:currentColor"></span><span>Classement</span></a>
      <a href="/admin" class="nav-link active"><span class="nav-link-icon"><i class="fas fa-cog"></i></span><span>Admin</span></a>
    </div>
    <button class="burger" id="burger" onclick="toggleMenu()" aria-label="Menu">
      <span></span><span></span><span></span>
    </button>
    <div class="nav-right">
      <div class="user-profile-mini">
        <div class="nav-avatar" id="navAv">?</div>
        <span class="nav-username" id="navUsername"></span>
      </div>
      <button class="btn btn-ghost" style="margin-left:1rem" onclick="logout()"><span data-bficon="logout" data-size="16" style="color:currentColor"></span> DÃ©connexion</button>
    </div>
  </div>
</nav>

<div class="mobile-menu" id="mobileMenu">
  <button class="mobile-menu-close" onclick="toggleMenu()">âœ•</button>
  <a href="/dashboard"><span data-bficon="home" data-size="16"></span> Dashboard</a>
  <a href="/reservation"><span data-bficon="calendar" data-size="16"></span> RÃ©server</a>
  <a href="/live-score"><span data-bficon="gamepad" data-size="16"></span> Partie Live</a>
  <a href="/stats"><span data-bficon="stats" data-size="16"></span> Stats</a>
  <a href="/top"><span data-bficon="trophy" data-size="16"></span> Classement</a>
  <a href="/admin" class="active"><i class="fas fa-cog"></i> Admin</a>
  <a href="#" onclick="logout()"><span data-bficon="logout" data-size="16" style="color:currentColor"></span> DÃ©connexion</a>
</div>

<div class="page">
  <div class="container" style="max-width:900px">

<div class="page-header fade-up">
  <h1><i class="fas fa-cog"></i> Administration</h1>
  <p>Outils de gestion du Baby-Foot Club</p>
</div>

<!-- CONTRÃ”LE DES SERVOS -->
<div class="card fade-up" style="animation-delay:.05s;margin-bottom:1.5rem">
  <div class="card-header">
    <h3>ğŸ”§ ContrÃ´le des Servos</h3>
    <div id="servoStatus" style="font-size:0.8rem;color:var(--text-tertiary)">PrÃªt</div>
  </div>
  <div class="card-body">
    <p style="color:var(--text-tertiary);margin-bottom:1.5rem;font-size:0.9375rem">
      DÃ©verrouillez manuellement les servomoteurs pour libÃ©rer les balles bloquÃ©es.
      Les servos se reverrouillent automatiquement aprÃ¨s 5 secondes.
    </p>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1rem">
      <button
        class="btn btn-primary"
        style="padding:1rem;display:flex;flex-direction:column;align-items:center;gap:0.5rem"
        onclick="unlockServo(1)"
        id="btnServo1">
        ğŸ”“ Servo 1
        <small style="font-size:0.75rem;opacity:0.8;font-weight:400">(Ã‰quipe 1)</small>
      </button>
      <button
        class="btn btn-primary"
        style="padding:1rem;display:flex;flex-direction:column;align-items:center;gap:0.5rem"
        onclick="unlockServo(2)"
        id="btnServo2">
        ğŸ”“ Servo 2
        <small style="font-size:0.75rem;opacity:0.8;font-weight:400">(Ã‰quipe 2)</small>
      </button>
    </div>
    <div id="servoResult" style="display:none;padding:1rem;border-radius:10px;font-size:0.9375rem;text-align:center"></div>
  </div>
</div>

<!-- GESTION DES UTILISATEURS -->
<div class="card fade-up" style="animation-delay:.1s;margin-bottom:1.5rem">
  <div class="card-header">
    <h3>ğŸ‘¥ Utilisateurs inscrits</h3>
    <div id="userCount" style="font-size:0.8rem;color:var(--text-tertiary)"></div>
  </div>
  <div class="card-body">
    <div id="usersList" style="display:flex;flex-direction:column;gap:0.75rem">
      <div style="text-align:center;padding:1rem">
        <div class="loading-spinner" style="margin:0 auto 0.5rem"></div>
        <p style="color:var(--text-tertiary);font-size:0.875rem">Chargement...</p>
      </div>
    </div>
  </div>
</div>

<!-- Ã‰TAT DU JEU -->
<div class="card fade-up" style="animation-delay:.15s;margin-bottom:1.5rem">
  <div class="card-header">
    <h3><i class="fas fa-gamepad"></i> Ã‰tat du jeu en cours</h3>
    <button class="btn btn-secondary" style="padding:0.4rem 0.8rem;font-size:0.8rem" onclick="loadGameState()">
      ğŸ”„ Actualiser
    </button>
  </div>
  <div class="card-body">
    <div id="gameState" style="font-family:'Space Mono',monospace;font-size:0.8rem;color:var(--text-tertiary);line-height:1.8">
      Chargement...
    </div>
    <div style="margin-top:1rem">
      <button class="btn" style="background:rgba(231,76,60,0.1);color:#e74c3c;border:1px solid rgba(231,76,60,0.3);width:100%" onclick="forceStopGame()">
        ğŸ›‘ Forcer l'arrÃªt de la partie
      </button>
    </div>
  </div>
</div>

<!-- ZONE DANGER â€” Classe 1 uniquement (Imran) -->
<div id="dangerZone" class="card fade-up" style="animation-delay:.2s;margin-bottom:1.5rem;border-color:rgba(231,76,60,0.3);display:none">
  <div class="card-header" style="border-bottom-color:rgba(231,76,60,0.2)">
    <h3 style="color:#e74c3c">ğŸ”¥ Zone Danger</h3>
  </div>
  <div class="card-body">
    <h4 style="color:var(--text-primary);margin-top:0;margin-bottom:0.5rem">Reset de la base de donnÃ©es</h4>
    <p style="color:var(--text-tertiary);margin-bottom:0.75rem;font-size:0.9375rem">
      âš ï¸ Supprime TOUTES les donnÃ©es (utilisateurs, scores, rÃ©servations) et recrÃ©e uniquement les comptes de base.
    </p>
    <p style="color:#e74c3c;font-weight:700;margin-bottom:1.5rem;font-size:0.9375rem">
      Cette action est IRRÃ‰VERSIBLE !
    </p>
    <button
      class="btn btn-full"
      style="background:rgba(231,76,60,0.15);color:#e74c3c;border:1px solid rgba(231,76,60,0.4);font-weight:700"
      onclick="resetDatabase()">
      ğŸ—‘ï¸ RESET COMPLET DE LA BASE
    </button>
    <div id="resetResult" style="display:none;margin-top:1rem;padding:1rem;border-radius:10px;text-align:center"></div>
  </div>
</div>

<div style="text-align:center;margin-top:1rem;margin-bottom:2rem">
  <a href="/dashboard" class="btn btn-ghost">â† Retour au Dashboard</a>
</div>

  </div>
</div>

<!-- Toast container pour notifications -->

<div class="toast-wrap" id="toast-wrap"></div>

<script>
let socket;
try { socket = io({
    reconnection: true,
    reconnectionDelay: 1000,       // Attendre 1s avant 1Ã¨re tentative
    reconnectionDelayMax: 10000,   // Max 10s entre tentatives
    reconnectionAttempts: Infinity, // Toujours rÃ©essayer
    timeout: 20000,                // 20s avant d'abandonner une connexion
    transports: ['websocket', 'polling'],  // WebSocket d'abord, polling en fallback
  }); } catch(e) { console.warn("Socket.IO non disponible:", e); socket = { emit: () => {}, on: () => {} }; }

function toggleMenu() {
  document.getElementById('burger').classList.toggle('open');
  document.getElementById('mobileMenu').classList.toggle('open');
  document.body.style.overflow = document.getElementById('mobileMenu').classList.contains('open') ? 'hidden' : '';
}

function logout() {
  fetch('/api/logout', {method:'POST'}).then(() => location.href = '/');
}

function showToast(message, type = 'inf') {
  const toastWrap = document.getElementById('toast-wrap');
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = message;
  toastWrap.appendChild(toast);
  setTimeout(() => {
    toast.style.animation = 'slideOut 0.3s ease';
    setTimeout(() => toast.remove(), 300);
  }, 3200);
}

// â”€â”€ Init nav â”€â”€
let isSuperAdmin = false;
fetch('/current_user').then(r => r.json()).then(d => {
  if (d && d.username) {
    document.getElementById('navAv').textContent = d.username[0].toUpperCase();
    document.getElementById('navUsername').textContent = d.username;
    if (!d.is_admin) {
      location.href = '/dashboard';
      return;
    }
    isSuperAdmin = d.is_super_admin || false;
    // Classe 1 uniquement : afficher la zone danger
    const dangerZone = document.getElementById('dangerZone');
    if (dangerZone) {
      dangerZone.style.display = isSuperAdmin ? 'block' : 'none';
    }
    // Badge classe visible dans la nav
    const badge = document.createElement('span');
    badge.style.cssText = 'font-size:0.7rem;padding:2px 8px;border-radius:20px;font-weight:700;margin-left:0.5rem;vertical-align:middle;';
    if (isSuperAdmin) {
      badge.textContent = 'CLASSE 1';
      badge.style.background = 'rgba(255,215,0,0.2)';
      badge.style.color = '#ffd700';
      badge.style.border = '1px solid rgba(255,215,0,0.4)';
    } else {
      badge.textContent = 'CLASSE 2';
      badge.style.background = 'rgba(205,127,50,0.2)';
      badge.style.color = '#cd7f32';
      badge.style.border = '1px solid rgba(205,127,50,0.4)';
    }
    document.getElementById('navUsername').appendChild(badge);
  } else {
    location.href = '/login';
  }
});

// â”€â”€ Servos â”€â”€
function unlockServo(num) {
  const btnId = `btnServo${num}`;
  const btn = document.getElementById(btnId);
  const result = document.getElementById('servoResult');
  const status = document.getElementById('servoStatus');

  btn.disabled = true;
  btn.style.opacity = '0.5';
  status.textContent = `Servo ${num} en cours...`;

  result.style.display = 'block';
  result.style.background = 'rgba(52,152,219,0.1)';
  result.style.border = '1px solid rgba(52,152,219,0.4)';
  result.style.color = 'var(--text-primary)';
  result.textContent = `ğŸ”“ DÃ©verrouillage Servo ${num} en cours... (5 secondes)`;

  socket.emit(`unlock_servo${num}`);

  setTimeout(() => {
    btn.disabled = false;
    btn.style.opacity = '1';
    status.textContent = 'PrÃªt';

    result.style.background = 'rgba(39,174,96,0.1)';
    result.style.border = '1px solid rgba(39,174,96,0.4)';
    result.textContent = `âœ“ Servo ${num} reverrouillÃ© automatiquement`;

    setTimeout(() => { result.style.display = 'none'; }, 3000);
  }, 5000);
}

// â”€â”€ Erreurs socket â”€â”€
socket.on('error', (data) => {
  const result = document.getElementById('servoResult');
  result.style.display = 'block';
  result.style.background = 'rgba(231,76,60,0.1)';
  result.style.border = '1px solid rgba(231,76,60,0.4)';
  result.style.color = '#e74c3c';
  result.textContent = 'âœ• Erreur : ' + data.message;
  setTimeout(() => { result.style.display = 'none'; }, 5000);
});

socket.on('servo1_unlock', () => {
  document.getElementById('servoStatus').textContent = 'Servo 1 ouvert âœ“';
});
socket.on('servo1_lock', () => {
  document.getElementById('servoStatus').textContent = 'Servo 1 reverrouillÃ©';
  setTimeout(() => { document.getElementById('servoStatus').textContent = 'PrÃªt'; }, 2000);
});
socket.on('servo2_unlock', () => {
  document.getElementById('servoStatus').textContent = 'Servo 2 ouvert âœ“';
});
socket.on('servo2_lock', () => {
  document.getElementById('servoStatus').textContent = 'Servo 2 reverrouillÃ©';
  setTimeout(() => { document.getElementById('servoStatus').textContent = 'PrÃªt'; }, 2000);
});

// â”€â”€ Liste utilisateurs AVEC BOUTON SUPPRESSION â”€â”€
async function loadUsers() {
  try {
    const users = await fetch('/users_list').then(r => r.json());
    const container = document.getElementById('usersList');
    document.getElementById('userCount').textContent = `${users.length} comptes`;

    if (!users.length) {
      container.innerHTML = '<p style="color:var(--text-tertiary);text-align:center">Aucun utilisateur</p>';
      return;
    }

    container.innerHTML = users.map(u => `
      <div style="display:flex;align-items:center;justify-content:space-between;padding:0.875rem 1rem;background:var(--bg-tertiary);border-radius:10px;border:1px solid var(--border-subtle);transition:all 0.2s">
        <div style="display:flex;align-items:center;gap:0.875rem">
          <div style="width:36px;height:36px;border-radius:50%;background:var(--gradient-bronze);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:0.875rem;color:white;box-shadow:var(--shadow-sm)">
            ${u[0].toUpperCase()}
          </div>
          <span style="font-weight:600;color:var(--text-primary);font-size:1rem">${u}</span>
        </div>
        <div style="display:flex;align-items:center;gap:0.75rem">
          <a href="/user_stats/${u}" class="btn btn-secondary" style="padding:0.5rem 1rem;font-size:0.8125rem;text-decoration:none">
            <i class="fas fa-chart-bar"></i> Stats
          </a>
          <button 
            onclick="deleteUser('${u}')" 
            class="btn" 
            style="padding:0.5rem 1rem;font-size:0.8125rem;background:rgba(231,76,60,0.1);color:#e74c3c;border:1px solid rgba(231,76,60,0.3);font-weight:600"
            title="Supprimer ce compte">
            ğŸ—‘ï¸ Supprimer
          </button>
        </div>
      </div>
    `).join('');
  } catch(e) {
    console.error('Erreur chargement users:', e);
  }
}

// â”€â”€ SUPPRESSION D'UTILISATEUR â”€â”€
async function deleteUser(username) {
  // Comptes protÃ©gÃ©s
  const protectedAccounts = ['alice', 'bob', 'charlie', 'diana'];
  if (protectedAccounts.includes(username)) {
    showToast(`âš ï¸ Le compte "${username}" est protÃ©gÃ© et ne peut pas Ãªtre supprimÃ©`, 'err');
    return;
  }

  // Confirmation
  const confirmed = confirm(
    `âš ï¸ ATTENTION âš ï¸\n\n` +
    `Voulez-vous vraiment supprimer le compte "${username}" ?\n\n` +
    `Cette action supprimera :\n` +
    `- Le compte utilisateur\n` +
    `- Tous ses scores\n` +
    `- Toutes ses rÃ©servations\n\n` +
    `Cette action est IRRÃ‰VERSIBLE !`
  );

  if (!confirmed) return;

  try {
    const res = await fetch('/api/delete_user', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ username })
    });

    const data = await res.json();

    if (data.success) {
      showToast(`âœ“ Compte "${username}" supprimÃ© avec succÃ¨s`, 'ok');
      // Recharger la liste
      setTimeout(() => loadUsers(), 500);
    } else {
      showToast(`âœ• Erreur : ${data.message}`, 'err');
    }
  } catch (e) {
    showToast('âœ• Erreur de connexion au serveur', 'err');
    console.error('Erreur suppression:', e);
  }
}

// â”€â”€ Ã‰tat du jeu â”€â”€
async function loadGameState() {
  try {
    const data = await fetch('/debug/game').then(r => r.json());
    const game = data.current_game;
    const el = document.getElementById('gameState');

    if (game.active) {
      el.innerHTML = `
        <div style="color:#22c55e;font-weight:700;margin-bottom:0.5rem">â— Partie en cours</div>
        <div>Ã‰quipe 1 : ${game.team1_players?.join(', ') || 'â€”'} â†’ <strong style="color:var(--bronze)">${game.team1_score} buts</strong></div>
        <div>Ã‰quipe 2 : ${game.team2_players?.join(', ') || 'â€”'} â†’ <strong style="color:var(--bronze)">${game.team2_score} buts</strong></div>
        <div style="margin-top:0.5rem;color:var(--text-muted)">LancÃ©e par : ${game.started_by || 'â€”'}</div>
        <div style="color:var(--text-muted)">Depuis : ${game.started_at ? new Date(game.started_at).toLocaleTimeString('fr-FR') : 'â€”'}</div>
      `;
    } else {
      el.innerHTML = '<div style="color:var(--text-tertiary)">â­• Aucune partie en cours</div>';
    }
  } catch(e) {
    document.getElementById('gameState').textContent = 'Erreur de chargement';
  }
}

function forceStopGame() {
  if (confirm('Forcer l\'arrÃªt de la partie en cours ?')) {
    socket.emit('stop_game');
    setTimeout(loadGameState, 500);
  }
}

// â”€â”€ Reset DB â”€â”€
async function resetDatabase() {
  const confirmed = confirm(
    'âš ï¸ ATTENTION âš ï¸\n\n' +
    'Vous allez SUPPRIMER TOUTES LES DONNÃ‰ES :\n' +
    '- Tous les utilisateurs\n' +
    '- Tous les scores\n' +
    '- Toutes les rÃ©servations\n\n' +
    'Cette action est IRRÃ‰VERSIBLE !\n\nÃŠtes-vous sÃ»r ?'
  );
  if (!confirmed) return;

  const doubleCheck = confirm('DerniÃ¨re confirmation : voulez-vous VRAIMENT tout supprimer ?');
  if (!doubleCheck) return;

  const result = document.getElementById('resetResult');
  result.style.display = 'block';
  result.style.background = 'rgba(255,191,0,0.1)';
  result.style.border = '1px solid rgba(255,191,0,0.3)';
  result.style.color = 'var(--text-primary)';
  result.textContent = 'â³ Reset en cours...';

  try {
    const res = await fetch('/admin/reset_database', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'}
    });
    const data = await res.json();

    if (data.success) {
      result.style.background = 'rgba(39,174,96,0.1)';
      result.style.border = '1px solid rgba(39,174,96,0.4)';
      result.textContent = 'âœ“ Base rÃ©initialisÃ©e ! Redirection...';
      setTimeout(() => location.href = '/dashboard', 2000);
    } else {
      result.style.background = 'rgba(231,76,60,0.1)';
      result.style.border = '1px solid rgba(231,76,60,0.4)';
      result.style.color = '#e74c3c';
      result.textContent = 'âœ• Erreur : ' + data.message;
    }
  } catch(e) {
    result.style.background = 'rgba(231,76,60,0.1)';
    result.style.border = '1px solid rgba(231,76,60,0.4)';
    result.style.color = '#e74c3c';
    result.textContent = 'âœ• Erreur rÃ©seau : ' + e.message;
  }
}

// â”€â”€ Init â”€â”€
loadUsers();
loadGameState();
</script>


<script src="{{ url_for('static', filename='icons.js') }}"></script>
  <script src="/static/pwa.js" defer></script>
</body>
</html>