<!DOCTYPE html>
<html lang="fr">
<head>
  <link rel="manifest" href="/static/manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="BabyFoot">
  <link rel="apple-touch-icon" href="/static/images/logo.svg">
  <meta charset="UTF-8">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>R√©servation ‚Äî Baby-Foot Club</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='responsive-mobile.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='style-extended.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='global-animations.css') }}">
  <script src="{{ url_for('static', filename='global-animations.js') }}" defer></script>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
</head>
<body style="font-family: 'DM Sans', sans-serif;">

<nav class="nav nav-glass">
  <div class="nav-inner">
    <a href="/dashboard" class="nav-brand">
      <div class="logo-wrapper">
        <img src="{{ url_for('static', filename='images/logo.svg') }}" alt="">
        <div class="logo-pulse"></div>
      </div>
      <span class="brand-text">Baby-Foot Club</span>
    </a>
    <div class="nav-sep"></div>
    <div class="nav-links">
      <a href="/dashboard" class="nav-link"><span class="nav-link-icon" data-bficon="home" data-size="18" style="color:currentColor"></span><span>Dashboard</span></a>
      <a href="/reservation" class="nav-link active"><span class="nav-link-icon" data-bficon="calendar" data-size="18" style="color:currentColor"></span><span>R√©server</span></a>
      <a href="/live-score" class="nav-link"><span class="nav-link-icon" data-bficon="gamepad" data-size="18" style="color:currentColor"></span><span>Partie Live</span></a>
      <a href="/stats" class="nav-link"><span class="nav-link-icon" data-bficon="stats" data-size="18" style="color:currentColor"></span><span>Stats</span></a>
      <a href="/top" class="nav-link"><span class="nav-link-icon" data-bficon="trophy" data-size="18" style="color:currentColor"></span><span>Classement</span></a>
    </div>
    <button class="burger" id="burger" onclick="toggleMenu()" aria-label="Menu">
      <span></span><span></span><span></span>
    </button>
    <div class="nav-right">
      <div class="user-profile-mini">
        <div class="nav-avatar" id="navAv">?</div>
        <span class="nav-username" id="navUsername"></span>
      </div>
      <button class="btn btn-ghost" style="margin-left:1rem" onclick="logout()"><span data-bficon="logout" data-size="16" style="color:currentColor"></span> D√©connexion</button>
    </div>
  </div>
</nav>

<div class="mobile-menu" id="mobileMenu">
  <button class="mobile-menu-close" onclick="toggleMenu()">‚úï</button>
  <a href="/dashboard"><span data-bficon="home" data-size="16"></span> Dashboard</a>
  <a href="/reservation" class="active"><span data-bficon="calendar" data-size="16"></span> R√©server</a>
  <a href="/live-score"><span data-bficon="gamepad" data-size="16"></span> Partie Live</a>
  <a href="/stats"><span data-bficon="stats" data-size="16"></span> Stats</a>
  <a href="/top"><span data-bficon="trophy" data-size="16"></span> Classement</a>
  <a href="#" onclick="logout()"><span data-bficon="logout" data-size="16" style="color:currentColor"></span> D√©connexion</a>
  <button id="pwa-install-trigger" onclick="triggerPwaInstall()" style="display:none;width:100%;text-align:left;background:linear-gradient(135deg,rgba(205,127,50,0.15),rgba(205,127,50,0.05));border:1px solid rgba(205,127,50,0.4);color:#cd7f32;font-weight:700;font-size:1rem;padding:0.9rem 1.25rem;border-radius:10px;cursor:pointer;margin-top:0.5rem;font-family:inherit;">üì≤ Installer l'app</button>
</div>

<div class="page">
  <div class="container" style="max-width:900px">
    <div class="page-header fade-up">
      <h1><span data-bficon="calendar" data-size="20" style="color:var(--bronze);vertical-align:middle"></span> R√©server un cr√©neau</h1>
      <p>Cr√©neaux de 25 minutes ‚Äî Aujourd'hui et demain uniquement</p>
    </div>

    <!-- √âtape 1 : Jour -->
    <div class="card fade-up" style="animation-delay:.05s;margin-bottom:1.5rem">
      <div class="card-header"><h3>01 ‚Äî Choisir le jour</h3></div>
      <div class="card-body" style="display:flex;gap:0.75rem;align-items:center;flex-wrap:wrap">
        <button id="btnToday" class="btn btn-primary" onclick="selectDay(0)">Aujourd'hui</button>
        <button id="btnTomorrow" class="btn btn-secondary" onclick="selectDay(1)">Demain</button>
        <span id="dayLabel" style="font-size:0.9375rem;color:var(--text-secondary);margin-left:0.5rem;font-weight:600"></span>
      </div>
    </div>

    <!-- √âtape 2 : Cr√©neau -->
    <div class="card fade-up" style="animation-delay:.08s;margin-bottom:1.5rem">
      <div class="card-header">
        <h3>02 ‚Äî Choisir l'horaire <small style="font-weight:400;color:var(--text-tertiary);font-size:0.8125rem">(cr√©neaux 25 min)</small></h3>
        <span id="selectedBadge" style="display:none" class="tag tag-brn"></span>
      </div>
      <div class="card-body">
        <div class="slot-grid" id="slotsGrid"></div>
        <div style="margin-top:1rem;font-size:0.8125rem;color:var(--text-tertiary);display:flex;flex-wrap:wrap;gap:1rem">
          <span style="display:inline-flex;align-items:center;gap:0.375rem">
            <span style="width:12px;height:12px;background:var(--bg-tertiary);border:1px solid var(--border-normal);border-radius:4px"></span>
            Disponible
          </span>
          <span style="display:inline-flex;align-items:center;gap:0.375rem">
            <span style="width:12px;height:12px;background:linear-gradient(135deg,rgba(205,127,50,0.2),rgba(255,191,0,0.1));border:1px solid var(--bronze);border-radius:4px"></span>
            S√©lectionn√©
          </span>
          <span style="display:inline-flex;align-items:center;gap:0.375rem">
            <span style="width:12px;height:12px;background:linear-gradient(135deg,rgba(205,127,50,0.15),rgba(255,191,0,0.08));border:2px solid rgba(205,127,50,0.4);border-radius:4px"></span>
            Mon cr√©neau
          </span>
          <span style="display:inline-flex;align-items:center;gap:0.375rem">
            <span style="width:12px;height:12px;background:var(--bg-secondary);border:1px solid var(--border-subtle);border-radius:4px;opacity:0.5"></span>
            Occup√©
          </span>
        </div>
      </div>
    </div>

    <!-- √âtape 3 : Mode -->
    <div class="card fade-up" style="animation-delay:.1s;margin-bottom:1.5rem">
      <div class="card-header"><h3>03 ‚Äî Mode de jeu</h3></div>
      <div class="card-body">
        <p style="font-size:0.875rem;color:var(--text-tertiary);margin-bottom:1rem">
          Les √©quipes seront d√©finies lors du lancement de la partie
        </p>
        <div style="display:flex;gap:0.75rem">
          <button id="m1v1" class="btn btn-primary" onclick="setMode('1v1')">1 vs 1</button>
          <button id="m2v2" class="btn btn-secondary" onclick="setMode('2v2')">2 vs 2</button>
        </div>
      </div>
    </div>

    <!-- Bouton confirmer -->
    <button id="confirmBtn" class="btn btn-primary btn-full btn-lg fade-up" style="animation-delay:.12s">
      Confirmer la r√©servation
    </button>
    <div style="text-align:center;margin-top:1rem">
      <a href="/dashboard" class="btn btn-ghost">‚Üê Dashboard</a>
    </div>
  </div>
</div>

<div class="toast-wrap" id="tw"></div>

<script>
let currentUser = '';
let currentUserIsAdmin = false;
let reservations = {};
let selectedDayOffset = 0;
let selectedSlot = null;
let mode = '1v1';

const DAYS = ['Dimanche','Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi'];
const MONTHS = ['jan','f√©v','mar','avr','mai','jun','jul','ao√ª','sep','oct','nov','d√©c'];

function toggleMenu() {
  document.getElementById('burger').classList.toggle('open');
  document.getElementById('mobileMenu').classList.toggle('open');
  document.body.style.overflow = document.getElementById('mobileMenu').classList.contains('open') ? 'hidden' : '';
}

function logout() {
  fetch('/api/logout', {method:'POST'}).then(() => location.href = '/');
}

function toast(msg, type='inf') {
  const c = document.getElementById('tw');
  const t = document.createElement('div');
  t.className = `toast ${type}`;
  t.textContent = msg;
  c.appendChild(t);
  setTimeout(() => t.remove(), 3200);
}

function getDate(offset) {
  const d = new Date();
  d.setDate(d.getDate() + offset);
  return d;
}

function getDayName(offset) {
  const d = getDate(offset);
  return `${DAYS[d.getDay()]} ${d.getDate()} ${MONTHS[d.getMonth()]}`;
}

function getDayKey(offset) {
  return DAYS[getDate(offset).getDay()];
}

function selectDay(offset) {
  selectedDayOffset = offset;
  selectedSlot = null;
  document.getElementById('selectedBadge').style.display = 'none';
  document.getElementById('btnToday').className = offset === 0 ? 'btn btn-primary' : 'btn btn-secondary';
  document.getElementById('btnTomorrow').className = offset === 1 ? 'btn btn-primary' : 'btn btn-secondary';
  document.getElementById('dayLabel').textContent = getDayName(offset);
  renderSlots();
}

function genSlots() {
  const slots = [];
  let t = 8 * 60;
  while (t < 21 * 60) {
    const h = Math.floor(t / 60), m = t % 60;
    slots.push(String(h).padStart(2,'0') + ':' + String(m).padStart(2,'0'));
    t += 25;
  }
  return slots;
}

function renderSlots() {
  const dayKey = getDayKey(selectedDayOffset);
  const dayRes = reservations[dayKey] || {};
  const slots = genSlots();
  const grid = document.getElementById('slotsGrid');

  grid.innerHTML = slots.map(s => {
    const taken = dayRes[s];
    const isMine = taken && taken.reserved_by === currentUser;
    const isSelected = selectedSlot === s;

    if (isMine) {
      return `<div class="slot-pill mine" title="Votre r√©servation ‚Äî cliquez pour annuler" onclick="cancelMySlot('${dayKey}','${s}',this)" style="cursor:pointer">${s}<br><span style="font-size:0.7rem;opacity:0.8">√† vous ¬∑ ‚úï annuler</span></div>`;
    }
    if (taken) {
      if (currentUserIsAdmin) {
        // Admin : peut annuler n'importe quel cr√©neau ou le s√©lectionner pour r√©server √† sa place
        return `<div class="slot-pill" style="border:2px solid #e74c3c;background:rgba(231,76,60,0.1);cursor:pointer" title="R√©serv√© par ${taken.reserved_by} ‚Äî admin: cliquer pour annuler" onclick="adminCancelSlot('${dayKey}','${s}',this)">${s}<br><span style="font-size:0.7rem;color:#e74c3c">‚ö† ${taken.reserved_by} ¬∑ ‚úï</span></div>`;
      }
      return `<div class="slot-pill taken" title="R√©serv√© par ${taken.reserved_by}" style="cursor:not-allowed">${s}<br><span style="font-size:0.7rem;opacity:0.6">${taken.reserved_by}</span></div>`;
    }
    return `<div class="slot-pill ${isSelected ? 'selected' : ''}" onclick="pickSlot('${s}')">${s}</div>`;
  }).join('');
}

function pickSlot(s) {
  selectedSlot = s;
  const badge = document.getElementById('selectedBadge');
  badge.textContent = `${getDayName(selectedDayOffset)} ¬∑ ${s}`;
  badge.style.display = 'inline-flex';
  renderSlots();
}

function setMode(m) {
  mode = m;
  document.getElementById('m1v1').className = m === '1v1' ? 'btn btn-primary' : 'btn btn-secondary';
  document.getElementById('m2v2').className = m === '2v2' ? 'btn btn-primary' : 'btn btn-secondary';
}

// Convertit la liste plate en dict {jour: {heure: {reserved_by}}}
function buildReservationsDict(rows) {
  const dict = {};
  rows.forEach(r => {
    if (!dict[r.day]) dict[r.day] = {};
    dict[r.day][r.time] = { reserved_by: r.reserved_by, mode: r.mode };
  });
  return dict;
}

async function adminCancelSlot(dayKey, time, el) {
  const taken = (reservations[dayKey] || {})[time];
  const owner = taken ? taken.reserved_by : '?';
  if (!confirm(`Annuler la r√©servation de ${owner} (${getDayName(selectedDayOffset)} √† ${time}) ?`)) return;
  el.style.opacity = '0.5';
  try {
    const r = await fetch('/cancel_reservation', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({day: dayKey, time})
    }).then(x => x.json());
    if (r.success) {
      toast(`‚úì R√©servation de ${owner} annul√©e`, 'ok');
      if (reservations[dayKey]) delete reservations[dayKey][time];
      renderSlots();
    } else {
      toast(r.message || 'Erreur', 'err');
      el.style.opacity = '1';
    }
  } catch {
    toast('Erreur serveur', 'err');
    el.style.opacity = '1';
  }
}

async function cancelMySlot(dayKey, time, el) {
  if (!confirm(`Annuler votre r√©servation du ${getDayName(selectedDayOffset)} √† ${time} ?`)) return;
  el.style.opacity = '0.5';
  try {
    const r = await fetch('/cancel_reservation', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({day: dayKey, time})
    }).then(x => x.json());
    if (r.success) {
      toast('‚úì R√©servation annul√©e', 'ok');
      if (reservations[dayKey]) delete reservations[dayKey][time];
      renderSlots();
    } else {
      toast(r.message || 'Erreur', 'err');
      el.style.opacity = '1';
    }
  } catch {
    toast('Erreur serveur', 'err');
    el.style.opacity = '1';
  }
}



async function init() {
  try {
    const [ud, rows] = await Promise.all([
      fetch('/current_user').then(r => r.json()),
      fetch('/reservations_all').then(r => r.json())
    ]);

    currentUser = ud.username || '';
    currentUserIsAdmin = ud.is_admin || false;
    // /reservations_all retourne d√©j√† {jour: {heure: {reserved_by, mode}}}
    reservations = rows;

    if (currentUser) {
      document.getElementById('navAv').textContent = currentUser[0].toUpperCase();
      document.getElementById('navUsername').textContent = currentUser;
    }

    selectDay(0);

    // Attacher le bouton confirmer ici (apr√®s chargement des donn√©es)
    document.getElementById('confirmBtn').addEventListener('click', async () => {
      if (!selectedSlot) { toast('S√©lectionnez un cr√©neau', 'err'); return; }
      const dayKey = getDayKey(selectedDayOffset);
      const takenBy = (reservations[dayKey] || {})[selectedSlot];
      if (takenBy && takenBy.reserved_by !== currentUser && !currentUserIsAdmin) {
        toast(`Ce cr√©neau est d√©j√† pris par ${takenBy.reserved_by}`, 'err');
        return;
      }
      const btn = document.getElementById('confirmBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spin"></span> R√©servation‚Ä¶';
      try {
        const r = await fetch('/save_reservation', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({day: dayKey, time: selectedSlot, team1: [], team2: [], mode})
        }).then(x => x.json());
        if (r.success) {
          toast(`‚úì R√©serv√© : ${getDayName(selectedDayOffset)} √† ${selectedSlot}`, 'ok');
          if (!reservations[dayKey]) reservations[dayKey] = {};
          reservations[dayKey][selectedSlot] = { reserved_by: currentUser, mode };
          selectedSlot = null;
          renderSlots();
          setTimeout(() => window.location.href = '/dashboard', 1200);
        } else {
          toast(r.message || 'Erreur', 'err');
          btn.disabled = false;
          btn.textContent = 'Confirmer la r√©servation';
        }
      } catch {
        toast('Erreur serveur', 'err');
        btn.disabled = false;
        btn.textContent = 'Confirmer la r√©servation';
      }
    });

  } catch(e) {
    console.error('Erreur init r√©servation:', e);
    toast('Erreur de chargement', 'err');
  }
}

init();
</script>

<script src="{{ url_for('static', filename='icons.js') }}"></script>
  <script src="/static/pwa.js" defer></script>
</body>
</html>
let durPlan=10, modePlan='1v1';
let planDayOffset=0;
let statusData=null, myResaId=null;

function toggleMenu(){document.getElementById('burger').classList.toggle('open');document.getElementById('mobileMenu').classList.toggle('open');document.body.style.overflow=document.getElementById('mobileMenu').classList.contains('open')?'hidden':'';}
function logout(){fetch('/api/logout',{method:'POST'}).then(()=>location.href='/');}

function toast(msg,type='inf'){const c=document.getElementById('tw');const t=document.createElement('div');t.className='toast '+type;t.textContent=msg;c.appendChild(t);setTimeout(()=>t.remove(),3000);}

function fmt(iso){if(!iso)return'‚Äî';const d=new Date(iso);return d.getHours().toString().padStart(2,'0')+'h'+d.getMinutes().toString().padStart(2,'0');}
function fmtTime(iso){if(!iso)return'‚Äî';const d=new Date(iso);return d.getHours().toString().padStart(2,'0')+':'+d.getMinutes().toString().padStart(2,'0');}

function selectDur(ctx,val,el){
  if(ctx==='now'){durNow=val;document.querySelectorAll('#durPillsNow .dur-pill').forEach(p=>p.classList.remove('active'));}
  else{durPlan=val;document.querySelectorAll('#durPillsPlan .dur-pill').forEach(p=>p.classList.remove('active'));}
  el.classList.add('active');
  if(ctx==='now')updateNowPreview();else{onTimeChange();checkConflict();}
}

function selectMode(ctx,val){
  if(ctx==='now'){modeNow=val;document.getElementById('modeNow1v1').classList.toggle('active',val==='1v1');document.getElementById('modeNow2v2').classList.toggle('active',val==='2v2');}
  else{modePlan=val;document.getElementById('modePlan1v1').classList.toggle('active',val==='1v1');document.getElementById('modePlan2v2').classList.toggle('active',val==='2v2');}
}

function selectPlanDay(offset){
  planDayOffset=offset;
  document.getElementById('tabToday').classList.toggle('active',offset===0);
  document.getElementById('tabTomorrow').classList.toggle('active',offset===1);
  onTimeChange();checkConflict();renderTimeline();
}

function updateNowPreview(){
  const now=new Date();const end=new Date(now.getTime()+durNow*60000);
  document.getElementById('nowEndPreview').textContent='De maintenant ('+fmtTime(now.toISOString())+') √† '+fmtTime(end.toISOString());
}

function onTimeChange(){
  const t=document.getElementById('planTime').value;
  if(!t){document.getElementById('planEndLabel').textContent='‚Üí fin : ‚Äî';return;}
  const[h,m]=t.split(':').map(Number);
  const endM=m+durPlan,endH=h+Math.floor(endM/60),endMin=endM%60;
  document.getElementById('planEndLabel').textContent='‚Üí fin : '+String(endH).padStart(2,'0')+'h'+String(endMin).padStart(2,'0');
  checkConflict();
}

function checkConflict(){
  const t=document.getElementById('planTime').value;const el=document.getElementById('planConflict');
  if(!t||!statusData){el.style.display='none';return;}
  const[h,m]=t.split(':').map(Number);
  const base=new Date();if(planDayOffset===1)base.setDate(base.getDate()+1);
  base.setHours(h,m,0,0);
  const startMs=base.getTime(),endMs=startMs+durPlan*60000;
  const dayKey=planDayOffset===0?'all_today':'all_tomorrow';
  for(const r of(statusData[dayKey]||[])){
    if(r.reserved_by===currentUser)continue;
    const rS=new Date(r.start_time).getTime(),rE=new Date(r.end_time).getTime();
    if(startMs<rE&&endMs>rS){el.textContent='‚ö† Conflit avec '+r.reserved_by+' ('+fmt(r.start_time)+'‚Äì'+fmt(r.end_time)+')';el.style.display='block';return;}
  }
  if(planDayOffset===0&&base<new Date()){el.textContent='‚ö† Cette heure est d√©j√† pass√©e';el.style.display='block';return;}
  el.style.display='none';
}

async function refreshStatus(){
  try{
    const data=await fetch('/api/babyfoot_status').then(r=>r.json());
    statusData=data;updateStatusUI(data);findMyResa(data);renderTimeline();renderNextFree(data);updateNowPreview();
  }catch(e){console.error(e);}
}

function updateStatusUI(data){
  const card=document.getElementById('statusCard'),txt=document.getElementById('statusText'),sub=document.getElementById('statusSub');
  document.getElementById('statusTime').textContent=fmtTime(data.server_time);
  if(data.is_free){
    card.className='status-card status-free';txt.textContent='‚úÖ Babyfoot libre';
    const nx=data.upcoming[0];
    sub.textContent=nx?'Prochain : '+fmt(nx.start_time)+' ('+nx.reserved_by+')':'Aucune r√©servation pr√©vue';
    document.getElementById('playNowSection').style.display=myResaId?'none':'block';
  }else{
    card.className='status-card status-busy';
    const cur=data.current,now=new Date();
    txt.textContent='üî¥ Occup√© jusqu\'√† '+fmt(cur.end_time);
    sub.textContent='Par '+cur.reserved_by+' ¬∑ encore '+Math.max(1,Math.ceil((new Date(cur.end_time)-now)/60000))+' min';
    document.getElementById('playNowSection').style.display='none';
  }
}

function findMyResa(data){
  const all=[...(data.all_today||[]),...(data.all_tomorrow||[])];
  const now=new Date();
  const mine=all.find(r=>r.reserved_by===currentUser&&new Date(r.end_time)>now);
  const card=document.getElementById('myResaCard');
  if(mine){
    myResaId=mine.id;
    const isToday=new Date(mine.start_time).toDateString()===now.toDateString();
    document.getElementById('myResaInfo').textContent=(isToday?"Aujourd'hui":'Demain')+' ¬∑ '+fmt(mine.start_time)+' ‚Äì '+fmt(mine.end_time)+' ¬∑ '+(mine.duration_minutes||15)+' min ¬∑ '+mine.mode;
    card.style.display='block';
  }else{myResaId=null;card.style.display='none';}
}

function renderTimeline(){
  if(!statusData)return;
  const dayKey=planDayOffset===0?'all_today':'all_tomorrow';
  const reservations=statusData[dayKey]||[];
  const bar=document.getElementById('timelineBar'),nowLine=document.getElementById('nowLine');
  document.getElementById('timelineTitle').textContent=planDayOffset===0?"Aujourd'hui":'Demain';
  const START_H=8,END_H=21,TOTAL_MIN=(END_H-START_H)*60;
  function toP(iso){const d=new Date(iso);const min=(d.getHours()-START_H)*60+d.getMinutes();return Math.max(0,Math.min(100,(min/TOTAL_MIN)*100));}
  Array.from(bar.children).forEach(c=>{if(c!==nowLine)c.remove();});
  const now=new Date();
  const nowMin=(now.getHours()-START_H)*60+now.getMinutes();
  if(planDayOffset===0&&nowMin>=0&&nowMin<=TOTAL_MIN){nowLine.style.display='block';nowLine.style.left=((nowMin/TOTAL_MIN)*100)+'%';}
  else{nowLine.style.display='none';}
  reservations.forEach(r=>{
    const left=toP(r.start_time),right=toP(r.end_time),width=right-left;
    if(width<=0)return;
    const block=document.createElement('div');block.className='timeline-block';
    if(new Date(r.end_time)<now&&planDayOffset===0)block.classList.add('past');
    block.classList.add(r.reserved_by===currentUser?'mine':'others');
    block.style.left=left+'%';block.style.width=width+'%';
    block.title=r.reserved_by+' ¬∑ '+fmt(r.start_time)+'‚Äì'+fmt(r.end_time);
    block.textContent=r.reserved_by===currentUser?'Vous':r.reserved_by;
    block.onclick=()=>{
      if(r.reserved_by!==currentUser){
        const e=new Date(r.end_time);
        document.getElementById('planTime').value=String(e.getHours()).padStart(2,'0')+':'+String(e.getMinutes()).padStart(2,'0');
        onTimeChange();
      }
    };
    bar.appendChild(block);
  });
}

function renderNextFree(data){
  const container=document.getElementById('nextFreeSlots');
  const dayKey=planDayOffset===0?'all_today':'all_tomorrow';
  const now=new Date();
  let pointer=planDayOffset===0?new Date():new Date(now.getFullYear(),now.getMonth(),now.getDate()+1,8,0);
  const maxTime=new Date(pointer);maxTime.setHours(21,0,0,0);
  const sorted=[...(data[dayKey]||[])].filter(r=>new Date(r.end_time)>now).sort((a,b)=>new Date(a.start_time)-new Date(b.start_time));
  const suggestions=[];
  for(const r of sorted){
    const rS=new Date(r.start_time),rE=new Date(r.end_time);
    if(rS>pointer&&(rS-pointer)>=5*60000)suggestions.push(new Date(pointer));
    if(rE>pointer)pointer=rE;
    if(suggestions.length>=4)break;
  }
  if(suggestions.length<4&&pointer<maxTime)suggestions.push(new Date(pointer));
  container.innerHTML=suggestions.slice(0,4).map(s=>{
    const h=String(s.getHours()).padStart(2,'0'),m=String(s.getMinutes()).padStart(2,'0');
    return '<button class="next-free-pill" onclick="applyFreeSlot(\''+h+':'+m+'\')">'+h+'h'+m+'</button>';
  }).join('')||'<span style="font-size:0.82rem;color:var(--text-muted)">Aucun cr√©neau libre</span>';
}

function applyFreeSlot(t){document.getElementById('planTime').value=t;onTimeChange();document.getElementById('planTime').scrollIntoView({behavior:'smooth',block:'center'});}

async function playNow(){
  const btn=document.getElementById('btnPlayNow');btn.disabled=true;btn.innerHTML='<span class="spin"></span> R√©servation‚Ä¶';
  try{
    const r=await fetch('/api/reserve_now',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({duration:durNow,mode:modeNow})}).then(x=>x.json());
    if(r.success){toast('‚úÖ R√©serv√© jusqu\'√† '+fmt(r.end),'ok');await refreshStatus();}
    else toast(r.message||'Erreur','err');
  }catch(e){toast('Erreur r√©seau','err');}
  btn.disabled=false;btn.innerHTML='‚ö° Jouer maintenant';
}

async function planReserve(){
  const t=document.getElementById('planTime').value;
  if(!t){toast('Choisissez une heure','err');return;}
  if(document.getElementById('planConflict').style.display!=='none'){toast('R√©solvez le conflit d\'abord','err');return;}
  const dateObj=new Date();if(planDayOffset===1)dateObj.setDate(dateObj.getDate()+1);
  const dateStr=dateObj.toISOString().split('T')[0];
  const btn=document.getElementById('btnPlan');btn.disabled=true;btn.innerHTML='<span class="spin"></span> R√©servation‚Ä¶';
  try{
    const r=await fetch('/api/reserve_plan',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({start_time:t,date:dateStr,duration:durPlan,mode:modePlan})}).then(x=>x.json());
    if(r.success){toast('‚úÖ R√©serv√© : '+fmt(r.start)+' ‚Äì '+fmt(r.end),'ok');document.getElementById('planTime').value='';document.getElementById('planEndLabel').textContent='‚Üí fin : ‚Äî';await refreshStatus();}
    else toast(r.message||'Erreur','err');
  }catch(e){toast('Erreur r√©seau','err');}
  btn.disabled=false;btn.textContent='Confirmer la r√©servation';
}

async function cancelMyResa(){
  if(!myResaId)return;
  if(!confirm('Annuler votre r√©servation ?'))return;
  try{
    const r=await fetch('/api/cancel_reservation_v2',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id:myResaId})}).then(x=>x.json());
    if(r.success){toast('‚úÖ Annul√©e','ok');await refreshStatus();}
    else toast(r.message||'Erreur','err');
  }catch(e){toast('Erreur r√©seau','err');}
}

async function init(){
  try{
    const user=await fetch('/current_user').then(r=>r.json());
    if(!user){location.href='/login';return;}
    currentUser=user.username;isAdmin=user.is_admin;
    document.getElementById('navAv').textContent=user.username[0].toUpperCase();
    document.getElementById('navUsername').textContent=user.username;
  }catch(e){console.error(e);}
  const now=new Date();
  const nm=Math.ceil(now.getMinutes()/5)*5;
  const nh=now.getHours()+Math.floor(nm/60);
  document.getElementById('planTime').value=String(nh%24).padStart(2,'0')+':'+String(nm%60).padStart(2,'0');
  await refreshStatus();
  onTimeChange();
  setInterval(refreshStatus,30000);
}
init();
</script>
<script src="{{ url_for('static', filename='icons.js') }}"></script>
<script src="/static/pwa.js" defer></script>
</body>
</html>