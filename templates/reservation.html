<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>R√©servation ‚Äî Baby-Foot Club</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='responsive-mobile.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='style-extended.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
</head>
<body style="font-family: 'DM Sans', sans-serif;">
<nav class="nav nav-glass">
  <div class="nav-inner">
    <a href="/dashboard" class="nav-brand">
      <div class="logo-wrapper">
        <img src="{{ url_for('static', filename='images/logo.svg') }}" alt="">
        <div class="logo-pulse"></div>
      </div>
      <span class="brand-text">Baby-Foot Club</span>
    </a>
    <div class="nav-sep"></div>
    <div class="nav-links">
      <a href="/dashboard" class="nav-link"><span class="nav-link-icon">üè†</span><span>Dashboard</span></a>
      <a href="/reservation" class="nav-link active"><span class="nav-link-icon">üìÖ</span><span>R√©server</span></a>
      <a href="/live-score" class="nav-link"><span class="nav-link-icon">üéÆ</span><span>Partie Live</span></a>
      <a href="/stats" class="nav-link"><span class="nav-link-icon">üìä</span><span>Stats</span></a>
      <a href="/top" class="nav-link"><span class="nav-link-icon">üèÜ</span><span>Top 10</span></a>
    </div>
    <div class="nav-right">
      <div class="user-profile-mini">
        <div class="nav-avatar" id="navAv">?</div>
        <span class="nav-username" id="navUsername"></span>
      </div>
    </div>
  </div>
</nav>

<div class="page">
  <div class="container" style="max-width:900px">
    <div class="page-header fade-up">
      <h1>üìÖ R√©server un cr√©neau</h1>
      <p>Cr√©neaux de 25 minutes ‚Äî Aujourd'hui et demain uniquement</p>
    </div>

    <!-- S√©lection du jour -->
    <div class="card fade-up" style="animation-delay:.05s;margin-bottom:1.5rem">
      <div class="card-header"><h3>01 ‚Äî Choisir le jour</h3></div>
      <div class="card-body" style="display:flex;gap:0.75rem;align-items:center;flex-wrap:wrap">
        <button id="btnToday" class="btn btn-primary" onclick="selectDay(0)">Aujourd'hui</button>
        <button id="btnTomorrow" class="btn btn-secondary" onclick="selectDay(1)">Demain</button>
        <span id="dayLabel" style="display:flex;align-items:center;font-size:0.9375rem;color:var(--text-secondary);margin-left:0.5rem;font-weight:600"></span>
      </div>
    </div>

    <!-- Cr√©neaux -->
    <div class="card fade-up" style="animation-delay:.08s;margin-bottom:1.5rem">
      <div class="card-header">
        <h3>02 ‚Äî Choisir l'horaire <small style="font-weight:400;text-transform:none;letter-spacing:0;color:var(--text-tertiary);font-size:0.8125rem">(cr√©neaux 25 min)</small></h3>
        <span id="selectedBadge" style="display:none" class="tag tag-brn"></span>
      </div>
      <div class="card-body">
        <div class="slot-grid" id="slotsGrid"></div>
        <div id="slotHelp" style="margin-top:1rem;font-size:0.8125rem;color:var(--text-tertiary);display:flex;flex-wrap:wrap;gap:1rem">
          <span style="display:inline-flex;align-items:center;gap:0.375rem">
            <span style="width:12px;height:12px;background:var(--bg-tertiary);border:1px solid var(--border-normal);border-radius:4px"></span>
            Disponible
          </span>
          <span style="display:inline-flex;align-items:center;gap:0.375rem">
            <span style="width:12px;height:12px;background:linear-gradient(135deg, rgba(205, 127, 50, 0.2) 0%, rgba(255, 191, 0, 0.1) 100%);border:1px solid var(--bronze);border-radius:4px"></span>
            S√©lectionn√©
          </span>
          <span style="display:inline-flex;align-items:center;gap:0.375rem">
            <span style="width:12px;height:12px;background:linear-gradient(135deg, rgba(205, 127, 50, 0.15) 0%, rgba(255, 191, 0, 0.08) 100%);border:2px solid rgba(205, 127, 50, 0.4);border-radius:4px"></span>
            Mon cr√©neau
          </span>
          <span style="display:inline-flex;align-items:center;gap:0.375rem">
            <span style="width:12px;height:12px;background:var(--bg-secondary);border:1px solid var(--border-subtle);border-radius:4px;opacity:0.5"></span>
            Occup√©
          </span>
        </div>
      </div>
    </div>

    <!-- Config partie -->
    <div class="card fade-up" style="animation-delay:.1s;margin-bottom:1.5rem">
      <div class="card-header"><h3>03 ‚Äî Configurer l'√©quipe</h3></div>
      <div class="card-body">
        <div style="margin-bottom:1.5rem">
          <label class="label">Mode de jeu</label>
          <div style="display:flex;gap:0.75rem">
            <button id="m1v1" class="btn btn-primary" onclick="setMode('1v1')">1 vs 1</button>
            <button id="m2v2" class="btn btn-secondary" onclick="setMode('2v2')">2 vs 2</button>
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem">
          <div>
            <label class="label" style="color:var(--bronze)">üîµ √âquipe 1</label>
            <div class="drop-wrap" style="margin-bottom:0.75rem">
              <input type="text" id="t1p1" placeholder="Joueur 1" autocomplete="off">
              <div id="d-t1p1" class="player-dd"></div>
            </div>
            <div class="drop-wrap" id="t1p2w" style="display:none">
              <input type="text" id="t1p2" placeholder="Joueur 2" autocomplete="off">
              <div id="d-t1p2" class="player-dd"></div>
            </div>
          </div>
          <div>
            <label class="label" style="color:#ef4444">üî¥ √âquipe 2</label>
            <div class="drop-wrap" style="margin-bottom:0.75rem">
              <input type="text" id="t2p1" placeholder="Joueur 1" autocomplete="off">
              <div id="d-t2p1" class="player-dd"></div>
            </div>
            <div class="drop-wrap" id="t2p2w" style="display:none">
              <input type="text" id="t2p2" placeholder="Joueur 2" autocomplete="off">
              <div id="d-t2p2" class="player-dd"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bouton confirm -->
    <button id="confirmBtn" class="btn btn-primary btn-full btn-lg fade-up" style="animation-delay:.12s">
      Confirmer la r√©servation
    </button>
    <div style="text-align:center;margin-top:1rem">
      <a href="/dashboard" class="btn btn-ghost">‚Üê Dashboard</a>
    </div>
  </div>
</div>

<div class="toast-wrap" id="tw"></div>

<script>
let allUsers = [], currentUser = '', reservations = {};
let selectedDayOffset = 0, selectedSlot = null, mode = '1v1';

const DAYS = ['Dimanche','Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi'];
const MONTHS = ['jan','f√©v','mar','avr','mai','jun','jul','ao√ª','sep','oct','nov','d√©c'];

function toast(msg, type='inf') {
  const c=document.getElementById('tw'), t=document.createElement('div');
  t.className=`toast ${type}`; t.textContent=msg; c.appendChild(t);
  setTimeout(()=>t.remove(), 3200);
}

function getDate(offset) {
  const d = new Date(); d.setDate(d.getDate()+offset); return d;
}
function getDayName(offset) {
  const d = getDate(offset);
  const name = DAYS[d.getDay()];
  return `${name} ${d.getDate()} ${MONTHS[d.getMonth()]}`;
}
function getDayKey(offset) { return DAYS[getDate(offset).getDay()]; }

function selectDay(offset) {
  selectedDayOffset = offset; selectedSlot = null;
  document.getElementById('selectedBadge').style.display = 'none';
  document.getElementById('btnToday').className = offset===0?'btn btn-primary':'btn btn-secondary';
  document.getElementById('btnTomorrow').className = offset===1?'btn btn-primary':'btn btn-secondary';
  document.getElementById('dayLabel').textContent = getDayName(offset);
  renderSlots();
}

// G√©n√®re cr√©neaux de 25 min de 8h √† 21h (vrais intervalles 25min)
function genSlots() {
  const slots = [];
  let t = 8 * 60; // 8h00 en minutes
  while (t < 21 * 60) {
    const h = Math.floor(t / 60), m = t % 60;
    slots.push(String(h).padStart(2,'0') + ':' + String(m).padStart(2,'0'));
    t += 25;
  }
  return slots;
}

function renderSlots() {
  const dayKey = getDayKey(selectedDayOffset);
  const dayRes = (reservations[dayKey]) || {};
  const slots = genSlots();
  const grid = document.getElementById('slotsGrid');

  grid.innerHTML = slots.map(s => {
    const taken = dayRes[s];
    const isMine = taken && taken.reserved_by === currentUser;
    const isSelected = selectedSlot === s;
    if (isMine) {
      return `<div class="slot-pill mine" title="Votre r√©servation">${s}<br><span style="font-size:0.7rem;opacity:0.8">√† vous</span></div>`;
    }
    if (taken) {
      return `<div class="slot-pill taken">${s}<br><span style="font-size:0.7rem;opacity:0.6">occup√©</span></div>`;
    }
    return `<div class="slot-pill ${isSelected?'selected':''}" onclick="pickSlot('${s}')">${s}</div>`;
  }).join('');
}

function pickSlot(s) {
  selectedSlot = s;
  const badge = document.getElementById('selectedBadge');
  badge.textContent = `${getDayName(selectedDayOffset)} ¬∑ ${s}`;
  badge.style.display = 'inline-flex';
  renderSlots();
}

function setMode(m) {
  mode = m;
  document.getElementById('m1v1').className = m==='1v1'?'btn btn-primary':'btn btn-secondary';
  document.getElementById('m2v2').className = m==='2v2'?'btn btn-primary':'btn btn-secondary';
  document.getElementById('t1p2w').style.display = m==='2v2'?'block':'none';
  document.getElementById('t2p2w').style.display = m==='2v2'?'block':'none';
}

function setupDropdown(id) {
  const input = document.getElementById(id);
  const drop  = document.getElementById(`d-${id}`);
  if (!input || !drop) return;
  function show(val) {
    const f = allUsers.filter(u => !val || u.toLowerCase().includes(val.toLowerCase()));
    drop.innerHTML = f.length
      ? f.map(u=>`<div class="dd-item" onmousedown="pick('${u}','${id}')">${u}</div>`).join('')
      : '<div class="dd-empty">Aucun r√©sultat</div>';
    drop.style.display = 'block';
  }
  input.addEventListener('focus', ()=>show(input.value));
  input.addEventListener('input', ()=>show(input.value));
  input.addEventListener('blur',  ()=>setTimeout(()=>drop.style.display='none', 150));
}

window.pick = (u, id) => {
  document.getElementById(id).value = u;
  document.getElementById(`d-${id}`).style.display = 'none';
};

document.getElementById('confirmBtn').addEventListener('click', async () => {
  if (!selectedSlot) { toast('S√©lectionnez un cr√©neau', 'err'); return; }
  const t1p1 = document.getElementById('t1p1').value.trim();
  const t2p1 = document.getElementById('t2p1').value.trim();
  if (!t1p1 || !t2p1) { toast('Chaque √©quipe doit avoir au moins un joueur', 'err'); return; }
  const team1 = [t1p1, mode==='2v2'?document.getElementById('t1p2').value.trim():''].filter(Boolean);
  const team2 = [t2p1, mode==='2v2'?document.getElementById('t2p2').value.trim():''].filter(Boolean);
  const dayKey = getDayKey(selectedDayOffset);
  const btn = document.getElementById('confirmBtn');
  btn.disabled = true; btn.innerHTML = '<span class="spin"></span> R√©servation‚Ä¶';
  try {
    const r = await fetch('/reserve_slot',{
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({day:dayKey, time:selectedSlot, team1, team2, mode})
    }).then(x=>x.json());
    if (r.success) {
      toast(`‚úì R√©serv√© : ${getDayName(selectedDayOffset)} √† ${selectedSlot}`, 'ok');
      setTimeout(()=>window.location.href='/dashboard', 1200);
    } else {
      toast(r.message||'Erreur', 'err');
      btn.disabled=false; btn.textContent='Confirmer la r√©servation';
    }
  } catch { toast('Erreur serveur','err'); btn.disabled=false; btn.textContent='Confirmer la r√©servation'; }
});

async function init() {
  const [ud, us, res] = await Promise.all([
    fetch('/current_user').then(r=>r.json()),
    fetch('/all_users').then(r=>r.json()),
    fetch('/reservations_all').then(r=>r.json())
  ]);
  currentUser = ud.username;
  allUsers = us;
  reservations = res;
  if (currentUser) {
    document.getElementById('navAv').textContent = currentUser[0].toUpperCase();
    document.getElementById('navUsername').textContent = currentUser;
    document.getElementById('t1p1').value = currentUser;
  }
  ['t1p1','t1p2','t2p1','t2p2'].forEach(setupDropdown);
  selectDay(0);
}
init();
</script>
</body>
</html>
