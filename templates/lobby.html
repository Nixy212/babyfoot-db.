<!DOCTYPE html>
<html lang="fr">
<head>
  <link rel="manifest" href="/static/manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="BabyFoot">
  <link rel="apple-touch-icon" href="/static/images/logo.svg">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lobby — Baby-Foot Club</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='responsive-mobile.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='lobby-styles.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
  <script src="{{ url_for('static', filename='confetti.js') }}" defer></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='global-animations.css') }}">
  <script src="{{ url_for('static', filename='global-animations.js') }}" defer></script>
  <style>
    .team-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      margin: 2rem 0;
    }
    .team-box {
      padding: 1.5rem;
      border-radius: 12px;
      min-height: 220px;
      border: 2px solid;
      background: var(--bg-secondary);
    }
    .team1-box {
      border-color: #cd7f32;
      background: linear-gradient(135deg, rgba(205,127,50,0.1) 0%, rgba(205,127,50,0.05) 100%);
    }
    .team2-box {
      border-color: #ffd700;
      background: linear-gradient(135deg, rgba(255,215,0,0.1) 0%, rgba(255,215,0,0.05) 100%);
    }
    .team-box h3 { margin-top: 0; font-size: 1.25rem; font-weight: 700; }
    .team1-box h3 { color: #cd7f32; }
    .team2-box h3 { color: #ffd700; }

    .player-item {
      background: var(--bg-elevated);
      padding: 0.875rem 1rem;
      border-radius: 8px;
      margin-bottom: 0.6rem;
      color: var(--text-primary);
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
      font-weight: 600;
      border: 1px solid var(--border-normal);
      transition: all 0.2s;
    }
    .player-item:hover { background: var(--bg-hover); border-color: var(--border-accent); }

    /* Joueur fantôme (slot libre) */
    .player-ghost {
      background: rgba(255,255,255,0.02);
      padding: 0.875rem 1rem;
      border-radius: 8px;
      margin-bottom: 0.6rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border: 1px dashed rgba(255,255,255,0.12);
      opacity: 0.55;
      transition: all 0.2s;
    }
    .player-ghost-name {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      color: var(--text-muted);
      font-size: 0.875rem;
      font-style: italic;
    }
    .player-ghost-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: rgba(255,255,255,0.06);
      border: 1px dashed rgba(255,255,255,0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .btn-add-ghost {
      padding: 0.3rem 0.75rem;
      border-radius: 6px;
      border: 1px solid rgba(205,127,50,0.4);
      background: rgba(205,127,50,0.1);
      color: #cd7f32;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }
    .btn-add-ghost:hover { background: rgba(205,127,50,0.2); transform: translateY(-1px); }

    .player-item button {
      background: linear-gradient(135deg, #cd7f32 0%, #b87333 100%);
      border: none;
      padding: 0.35rem 0.8rem;
      border-radius: 6px;
      color: white;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 600;
      transition: all 0.2s;
    }
    .player-item button:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(205,127,50,0.4); }
    .player-item button.btn-kick { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); }
    .player-item button.btn-kick:hover { box-shadow: 0 4px 12px rgba(231,76,60,0.4); }

    .online-dot-lobby {
      display: inline-block;
      width: 9px;
      height: 9px;
      border-radius: 50%;
      background: #2ecc71;
      box-shadow: 0 0 0 2px rgba(46,204,113,0.25), 0 0 6px rgba(46,204,113,0.5);
      flex-shrink: 0;
      margin-right: 6px;
      vertical-align: middle;
      animation: pulse-g 2s ease-in-out infinite;
    }
    @keyframes pulse-g {
      0%,100% { box-shadow: 0 0 0 2px rgba(46,204,113,0.25), 0 0 6px rgba(46,204,113,0.5); }
      50%      { box-shadow: 0 0 0 4px rgba(46,204,113,0.12), 0 0 12px rgba(46,204,113,0.35); }
    }

    .status-bar {
      background: var(--bg-secondary);
      padding: 1.25rem;
      border-radius: 8px;
      margin-bottom: 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border: 1px solid var(--border-normal);
    }
    .status-indicator { display: flex; gap: 0.75rem; align-items: center; font-weight: 600; color: var(--text-primary); }
    .status-dot { width: 14px; height: 14px; border-radius: 50%; background: #ffd700; animation: pulse 2s infinite; box-shadow: 0 0 10px rgba(255,215,0,0.5); }
    @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }

    #invite-section {
      background: var(--bg-secondary);
      padding: 1.5rem;
      border-radius: 12px;
      margin-bottom: 1.5rem;
      border: 1px solid var(--border-normal);
    }
    .search-box { position: relative; margin-bottom: 1rem; }
    .search-box input {
      width: 100%;
      padding: 0.75rem 1rem;
      background: var(--bg-elevated);
      border: 1px solid var(--border-normal);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 0.95rem;
      transition: all 0.2s;
      box-sizing: border-box;
    }
    .search-box input:focus { outline: none; border-color: var(--border-accent); box-shadow: 0 0 0 3px rgba(205,127,50,0.1); }
    .search-box input::placeholder { color: var(--text-muted); }
    .player-selector { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 1rem; max-height: 200px; overflow-y: auto; padding: 0.5rem; }
    .player-chip {
      padding: 0.55rem 1.1rem;
      background: var(--bg-elevated);
      border: 2px solid var(--border-normal);
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.2s;
      color: var(--text-primary);
      font-weight: 600;
      font-size: 0.875rem;
    }
    .player-chip:hover { background: var(--bg-hover); border-color: var(--border-accent); transform: translateY(-2px); }
    .player-chip.selected { background: linear-gradient(135deg, #cd7f32 0%, #ffd700 100%); color: white; border-color: #cd7f32; }

    /* Demandes en attente (côté hôte) */
    .join-request-item {
      background: rgba(52,152,219,0.1);
      border: 1px solid rgba(52,152,219,0.3);
      border-radius: 8px;
      padding: 0.75rem 1rem;
      margin-bottom: 0.6rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: var(--text-primary);
      font-weight: 600;
    }
    .join-request-item .jreq-name { color: #3498db; }
    .join-request-item .jreq-btns { display: flex; gap: 0.5rem; }
    .jreq-btn-accept { padding: 0.35rem 0.8rem; border: none; border-radius: 6px; background: linear-gradient(135deg, #2980b9, #3498db); color: white; font-weight: 700; font-size: 0.82rem; cursor: pointer; }
    .jreq-btn-decline { padding: 0.35rem 0.8rem; border: 1px solid rgba(231,76,60,0.4); border-radius: 6px; background: rgba(231,76,60,0.1); color: #e74c3c; font-weight: 700; font-size: 0.82rem; cursor: pointer; }

    @media (max-width: 600px) {
      .team-container { grid-template-columns: 1fr; gap: 1rem; }
    }
  </style>
</head>
<body style="font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">
<nav class="nav nav-glass">
  <div class="nav-inner">
    <a href="/dashboard" class="nav-brand">
      <div class="logo-wrapper">
        <img src="{{ url_for('static', filename='images/logo.svg') }}" alt="">
        <div class="logo-pulse"></div>
      </div>
      <span class="brand-text">Baby-Foot Club</span>
    </a>
    <div class="nav-sep"></div>
    <div class="nav-links">
      <a href="/dashboard" class="nav-link"><span class="nav-link-icon" data-bficon="home" data-size="18" style="color:currentColor"></span><span>Dashboard</span></a>
      <a href="/reservation" class="nav-link"><span class="nav-link-icon" data-bficon="calendar" data-size="18" style="color:currentColor"></span><span>Réserver</span></a>
      <a href="/lobby" class="nav-link active"><span class="nav-link-icon" data-bficon="gamepad" data-size="18" style="color:currentColor"></span><span>Lobby</span></a>
      <a href="/stats" class="nav-link"><span class="nav-link-icon" data-bficon="stats" data-size="18" style="color:currentColor"></span><span>Stats</span></a>
      <a href="/top" class="nav-link"><span class="nav-link-icon" data-bficon="trophy" data-size="18" style="color:currentColor"></span><span>Classement</span></a>
    </div>
    <button class="burger" id="burger" onclick="toggleMenu()"><span></span><span></span><span></span></button>
    <div class="nav-right">
      <div class="user-profile-mini">
        <div class="nav-avatar" id="navAv">?</div>
        <span class="nav-username" id="navUsername"></span>
      </div>
    </div>
  </div>
</nav>

<div class="mobile-menu" id="mobileMenu">
  <button class="mobile-menu-close" onclick="toggleMenu()">✕</button>
  <a href="/dashboard"><span data-bficon="home" data-size="16"></span> Dashboard</a>
  <a href="/reservation"><span data-bficon="calendar" data-size="16"></span> Réserver</a>
  <a href="/lobby"><i class="fas fa-gamepad"></i> Lobby</a>
  <a href="/stats"><span data-bficon="stats" data-size="16"></span> Stats</a>
  <a href="/top"><span data-bficon="trophy" data-size="16"></span> Classement</a>
  <a href="#" onclick="fetch('/api/logout',{method:'POST'}).then(()=>location.href='/')">Déconnexion</a>
</div>

<script>
function toggleMenu() {
  document.getElementById("burger").classList.toggle("open");
  document.getElementById("mobileMenu").classList.toggle("open");
  document.body.style.overflow = document.getElementById("mobileMenu").classList.contains("open") ? "hidden" : "";
}
</script>

<div class="page">
  <div class="container" style="max-width:1000px">
    <div class="page-header fade-up">
      <h1><i class="fas fa-gamepad"></i> Lobby de Partie</h1>
      <p>Configurez votre partie, invitez des adversaires — tout le monde sera notifié en temps réel</p>
    </div>

<div class="status-bar">
  <div class="status-indicator">
    <div class="status-dot"></div>
    <span><strong id="acceptedCount">0</strong> joueur<span id="acceptedPlural">s</span> prêt<span id="acceptedPlural2">s</span></span>
  </div>
  <div style="font-weight:600;color:var(--text-tertiary);font-size:0.875rem">Hôte : <span id="hostName" style="color:var(--bronze)"></span></div>
</div>

<!-- Demandes à rejoindre (visibles par l'hôte) -->
<div id="join-requests-section" style="display:none;margin-bottom:1.5rem">
  <div style="font-size:0.8rem;text-transform:uppercase;letter-spacing:0.08em;color:#3498db;font-weight:700;margin-bottom:0.75rem">
    <i class="fas fa-user-plus"></i> Demandes à rejoindre
  </div>
  <div id="joinRequestsList"></div>
</div>

<div id="invite-section">
  <h3 style="margin-top:0;color:var(--text-primary);margin-bottom:0.5rem">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:middle;margin-right:6px"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/></svg>Inviter des joueurs
  </h3>
  <p style="color:var(--text-tertiary);font-size:0.85rem;margin-bottom:0.75rem">Sélectionnez des joueurs et envoyez-leur une invitation — ils pourront l'accepter ou la refuser depuis n'importe quelle page</p>
  <div class="search-box">
    <input type="text" id="searchInput" placeholder="Rechercher un joueur..." oninput="filterPlayers()">
  </div>
  <div class="player-selector" id="playerSelector"></div>
  <button class="btn btn-primary btn-full" style="margin-top:1rem" onclick="inviteSelected()">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:middle;margin-right:6px"><path d="m22 2-7 20-4-9-9-4z"/><path d="M22 2 11 13"/></svg>Envoyer les invitations
  </button>
</div>

<div id="declinedSection" style="display:none;padding:1rem;border-radius:8px;background:rgba(231,76,60,0.1);border:2px solid #e74c3c;margin-bottom:1rem">
  <p id="declinedMessage" style="color:#e74c3c;font-weight:600;margin:0"></p>
  <div style="display:flex;gap:1rem;margin-top:0.75rem">
    <button class="btn btn-primary" onclick="continueWithCurrent()">Continuer</button>
    <button class="btn" style="background:#e74c3c;color:white" onclick="location.href='/dashboard'">Annuler</button>
  </div>
</div>

<!-- Équipes avec slots fantômes -->
<div class="team-container">
  <div class="team-box team1-box">
    <h3>
      <span style="display:inline-block;width:9px;height:9px;border-radius:50%;background:#cd7f32;margin-right:6px"></span>Équipe 1
      <span id="team1Mode" style="font-size:0.75rem;font-weight:500;color:var(--text-muted);margin-left:8px"></span>
    </h3>
    <div id="team1List"></div>
  </div>
  <div class="team-box team2-box">
    <h3>
      <span style="display:inline-block;width:9px;height:9px;border-radius:50%;background:#a0a0a0;margin-right:6px"></span>Équipe 2
      <span id="team2Mode" style="font-size:0.75rem;font-weight:500;color:var(--text-muted);margin-left:8px"></span>
    </h3>
    <div id="team2List"></div>
  </div>
</div>

<div style="text-align:center;margin-top:2rem;display:flex;justify-content:center;gap:1rem;flex-wrap:wrap">
  <button id="startButton" class="btn btn-primary btn-lg" style="display:none" onclick="startGame()">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:middle;margin-right:6px"><circle cx="14" cy="12" r="6"/><path d="M8 12H2"/><path d="M20 4 14 8"/></svg>Lancer la partie
  </button>
  <button class="btn" style="background:rgba(231,76,60,0.15);color:#e74c3c;border:1px solid rgba(231,76,60,0.3)" onclick="cancelLobby()">✕ Quitter le lobby</button>
</div>

<!-- Notif échange d'équipe -->
<div id="swapRequestNotif" style="display:none;position:fixed;top:80px;right:20px;background:var(--bg-elevated);padding:1.5rem;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.3);max-width:300px;border:2px solid var(--border-accent);z-index:9999">
  <p id="swapMessage" style="margin:0;color:var(--text-primary);font-weight:600"></p>
  <div style="display:flex;gap:0.5rem;margin-top:1rem">
    <button class="btn btn-primary" style="flex:1" onclick="acceptSwap()">✓ Accepter</button>
    <button class="btn" style="flex:1;background:#e74c3c;color:white" onclick="declineSwap()">✕ Refuser</button>
  </div>
</div>

  </div>
</div>

<div class="toast-wrap" id="toast-lobby"></div>

<script>
let socket;
try {
  socket = io({
    reconnection: true, reconnectionDelay: 1000, reconnectionDelayMax: 10000,
    reconnectionAttempts: Infinity, timeout: 20000,
    transports: ['websocket', 'polling'],
  });
  if (window.initReconnectIndicator) initReconnectIndicator(socket);
} catch(e) {
  socket = { emit: () => {}, on: () => {} };
}

let currentUsername = null;
let isAdmin = false;
let lobbyData = null;
let currentSwapRequest = null;
let allUsers = [];
let selectedPlayers = [];
let onlineUsers = new Set();

async function refreshOnlineUsers() {
  try {
    const res = await fetch('/api/online_users');
    const data = await res.json();
    onlineUsers = new Set(data.online || []);
  } catch(e) {}
}
setInterval(refreshOnlineUsers, 15000);

async function loadCurrentUser() {
  try {
    const res = await fetch('/current_user');
    if (res.ok) {
      const user = await res.json();
      currentUsername = user.username;
      isAdmin = user.is_admin;
      window._currentUsername = user.username;
      ProfileUtils.updateNav(user);
    }
  } catch(e) {}
}

async function loadPlayers() {
  try {
    const res = await fetch('/users_list');
    const rawUsers = await res.json();
    // users_list retourne maintenant des objets {username, nickname, avatar_preset, avatar_url, elo}
    const GUEST_RE = /^Joueur\d+$/i;
    allUsers = rawUsers.filter(u => {
      const name = typeof u === 'string' ? u : u.username;
      return name !== currentUsername && !GUEST_RE.test(name);
    });
    // Mettre en cache les profils
    rawUsers.forEach(u => { if (u && u.username) ProfileUtils._cache_set(u.username, u); });
    renderPlayerSelector();
  } catch(e) {}
}

function renderPlayerSelector() {
  const selector = document.getElementById('playerSelector');
  const searchTerm = document.getElementById('searchInput').value.toLowerCase();
  selector.innerHTML = '';
  const inLobby = [...(lobbyData.invited||[]), ...(lobbyData.accepted||[])];
  const filtered = allUsers.filter(u => !inLobby.includes(u) && u.toLowerCase().includes(searchTerm));
  if (filtered.length === 0) {
    selector.innerHTML = '<p style="color:var(--text-muted);text-align:center;padding:1rem;font-size:0.875rem">Tous les joueurs disponibles sont déjà dans le lobby</p>';
    return;
  }
  filtered.forEach(u => {
    const username = typeof u === 'string' ? u : u.username;
    const prof = typeof u === 'object' ? u : { username };
    const displayN = (prof.nickname && prof.nickname.trim()) ? prof.nickname.trim() : username;
    const chip = document.createElement('div');
    chip.className = 'player-chip' + (selectedPlayers.includes(username) ? ' selected' : '');
    const isOnline = onlineUsers.has(username);
    let avHtml = '';
    if (prof.avatar_url) avHtml = `<img src="${prof.avatar_url}" style="width:20px;height:20px;border-radius:50%;object-fit:cover;vertical-align:middle;margin-right:5px">`;
    else if (prof.avatar_preset) avHtml = `<span style="margin-right:5px">${prof.avatar_preset}</span>`;
    else avHtml = `<span style="display:inline-flex;align-items:center;justify-content:center;width:20px;height:20px;border-radius:50%;background:var(--bg-tertiary);font-size:0.7rem;font-weight:700;margin-right:5px">${username[0].toUpperCase()}</span>`;
    chip.innerHTML = `${isOnline ? '<span style="display:inline-block;width:7px;height:7px;border-radius:50%;background:#2ecc71;margin-right:4px;vertical-align:middle"></span>' : ''}${avHtml}<span>${displayN}</span>${displayN !== username ? `<span style="font-size:0.68rem;color:var(--text-muted);margin-left:4px">${username}</span>` : ''}`;
    chip.onclick = () => togglePlayer(username, chip);
    selector.appendChild(chip);
  });
}

function filterPlayers() { renderPlayerSelector(); }

function togglePlayer(username, chip) {
  if (selectedPlayers.includes(username)) {
    selectedPlayers = selectedPlayers.filter(u => u !== username);
    chip.classList.remove('selected');
  } else {
    selectedPlayers.push(username);
    chip.classList.add('selected');
  }
}

function inviteSelected() {
  if (!canInvite()) { toast('Seul l\'hôte peut inviter des joueurs', 'err'); return; }
  if (selectedPlayers.length === 0) { toast('Sélectionnez au moins un joueur', 'err'); return; }
  selectedPlayers.forEach(user => socket.emit('invite_to_lobby', { user }));
  selectedPlayers = [];
  setTimeout(loadPlayers, 500);
}

function canInvite() { return currentUsername === lobbyData.host || isAdmin; }

function canKick(playerUsername) {
  if (playerUsername === currentUsername) return false;
  if (playerUsername === lobbyData.host) return false;
  return currentUsername === lobbyData.host || isAdmin;
}

function kickPlayer(playerUsername) {
  if (!canKick(playerUsername)) return;
  if (confirm(`Exclure ${playerUsername} du lobby ?`)) socket.emit('kick_from_lobby', { user: playerUsername });
}

async function loadLobby() {
  try {
    const res = await fetch('/api/active_lobby');
    const data = await res.json();
    if (!data.active) { location.href = '/dashboard'; return; }
    const isInvited = data.invited.includes(currentUsername);
    const isAccepted = data.accepted.includes(currentUsername);
    if (!isInvited && !isAccepted) { location.href = '/dashboard'; return; }
    lobbyData = data;
    updateLobbyUI();
    loadPlayers();
  } catch(e) { location.href = '/dashboard'; }
}

// Pool de joueurs guests disponibles pour compléter les équipes
const GUEST_POOL = ['Joueur1', 'Joueur2', 'Joueur3'];

// Retourne les guests déjà dans les équipes (pour savoir lesquels sont libres)
function usedGuests() {
  const all = [...(lobbyData.team1 || []), ...(lobbyData.team2 || [])];
  return all.filter(p => GUEST_POOL.includes(p));
}

// Prochain guest disponible non encore dans une équipe
function nextAvailableGuest() {
  const used = usedGuests();
  return GUEST_POOL.find(g => !used.includes(g)) || null;
}

function renderTeam(containerId, players, teamColor) {
  const container = document.getElementById(containerId);
  container.innerHTML = '';
  const isHost = currentUsername === lobbyData.host || isAdmin;
  const MAX_SLOTS = 2; // toujours 2 slots par équipe (1v1 ou 2v2)

  // ── Joueurs réels (vrais comptes)
  players.forEach(player => {
    const isGuest = GUEST_POOL.includes(player);

    if (isGuest) {
      // Joueur guest : affiché comme un vrai joueur
      const item = document.createElement('div');
      item.className = 'player-item';
      let buttons = '';
      if (isHost) {
        buttons += `<button style="padding:0.3rem 0.6rem;border-radius:6px;border:1px solid rgba(231,76,60,0.4);background:rgba(231,76,60,0.1);color:#e74c3c;font-size:0.78rem;font-weight:600;cursor:pointer" onclick="removeGuest('${player}')">✕</button>`;
      }
      item.innerHTML = `
        <span style="display:flex;align-items:center;gap:6px">
          <span style="font-weight:700">${player}</span>
        </span>
        <div style="display:flex;gap:0.4rem">${buttons}</div>
      `;
      container.appendChild(item);
    } else {
      // Vrai joueur
      const item = document.createElement('div');
      item.className = 'player-item';
      let buttons = '';
      if (player !== currentUsername && canRequestSwap(player)) {
        buttons += `<button onclick="requestSwap('${player}')" style="font-size:0.8rem;padding:0.3rem 0.7rem">↔️</button>`;
      }
      if (canKick(player)) {
        buttons += `<button class="btn-kick" onclick="kickPlayer('${player}')" style="font-size:0.8rem;padding:0.3rem 0.7rem">✕</button>`;
      }
      const prof = (typeof allUsers.find === 'function' ? allUsers.find(u => (typeof u === 'object' ? u.username : u) === player) : null) || { username: player };
      const displayN = (prof.nickname && prof.nickname.trim()) ? prof.nickname.trim() : player;
      let avHtml2 = '';
      if (prof.avatar_url) avHtml2 = `<img src="${prof.avatar_url}" style="width:28px;height:28px;border-radius:50%;object-fit:cover;">`;
      else if (prof.avatar_preset) avHtml2 = `<span style="width:28px;height:28px;border-radius:50%;background:var(--bg-tertiary);display:flex;align-items:center;justify-content:center;font-size:1rem">${prof.avatar_preset}</span>`;
      else avHtml2 = `<span style="width:28px;height:28px;border-radius:50%;background:var(--bg-tertiary);display:flex;align-items:center;justify-content:center;font-size:0.75rem;font-weight:700">${player[0].toUpperCase()}</span>`;
      item.innerHTML = `
        <span style="display:flex;align-items:center;gap:8px">
          ${onlineUsers.has(player) ? '<span class="online-dot-lobby" title="En ligne"></span>' : ''}
          ${avHtml2}
          <span>
            <span style="font-weight:700;font-size:0.9rem">${displayN}${player === lobbyData.host ? ' <span style="color:var(--bronze);font-size:0.72rem">★ hôte</span>' : ''}</span>
            ${displayN !== player ? `<span style="display:block;font-size:0.68rem;color:var(--text-muted)">${player}</span>` : ''}
          </span>
        </span>
        <div style="display:flex;gap:0.4rem">${buttons}</div>
      `;
      container.appendChild(item);
    }
  });

  // ── Slots vides : afficher les guests dispo avec bouton "+ Ajouter"
  const emptySlots = MAX_SLOTS - players.length;
  // Guests pas encore dans AUCUNE équipe (team1 + team2 combinées)
  const usedAlready = usedGuests();
  const guestsForDisplay = GUEST_POOL.filter(g => !usedAlready.includes(g));
  for (let i = 0; i < emptySlots; i++) {
    const displayGuest = guestsForDisplay[i] || null;

    const ghost = document.createElement('div');
    ghost.className = 'player-ghost';
    if (displayGuest) {
      ghost.innerHTML = `
        <div class="player-ghost-name">
          <div class="player-ghost-avatar">
            <i class="fas fa-user" style="font-size:11px;color:rgba(255,255,255,0.2)"></i>
          </div>
          <div>
            <span style="font-size:0.85rem;font-style:italic">${displayGuest}</span>
            <div style="font-size:0.72rem;color:var(--text-muted)">Appuyer pour ajouter</div>
          </div>
        </div>
        ${isHost ? `<button class="btn-add-ghost" onclick="addGuest('${displayGuest}')">+ Ajouter</button>` : '<span style="font-size:0.75rem;color:var(--text-muted)">Slot libre</span>'}
      `;
    } else {
      ghost.innerHTML = `
        <div class="player-ghost-name">
          <div class="player-ghost-avatar">
            <i class="fas fa-user" style="font-size:11px;color:rgba(255,255,255,0.1)"></i>
          </div>
          <span style="font-size:0.82rem;color:var(--text-muted)">Slot libre</span>
        </div>
      `;
    }
    container.appendChild(ghost);
  }
}

// Ajouter un guest dans le lobby (le serveur le place dans la bonne équipe)
function addGuest(guestName) {
  if (!canInvite()) return;
  socket.emit('invite_to_lobby', { user: guestName });
}

// Retirer un guest du lobby
function removeGuest(guestName) {
  if (!canInvite()) return;
  socket.emit('kick_from_lobby', { user: guestName });
}

function focusInvite() {
  document.getElementById('searchInput').focus();
  document.getElementById('invite-section').scrollIntoView({ behavior: 'smooth', block: 'center' });
}

function updateLobbyUI() {
  if (!lobbyData) return;

  document.getElementById('hostName').textContent = lobbyData.host;

  const accepted = lobbyData.accepted || [];
  const cnt = accepted.length;
  document.getElementById('acceptedCount').textContent = cnt;
  document.getElementById('acceptedPlural').textContent = cnt > 1 ? 's' : '';
  document.getElementById('acceptedPlural2').textContent = cnt > 1 ? 's' : '';

  const inviteSection = document.getElementById('invite-section');
  inviteSection.style.display = canInvite() ? 'block' : 'none';

  // Mode affiché : 2v2 si chaque équipe a 2 vrais joueurs, sinon 1v1
  const realPlayers = (lobbyData.accepted || []).filter(p => !GUEST_POOL.includes(p));
  const mode = realPlayers.length >= 3 ? '2v2' : '1v1';
  if (document.getElementById('team1Mode')) document.getElementById('team1Mode').textContent = '(2v2)';
  if (document.getElementById('team2Mode')) document.getElementById('team2Mode').textContent = '(2v2)';

  renderTeam('team1List', lobbyData.team1 || [], '#cd7f32');
  renderTeam('team2List', lobbyData.team2 || [], '#ffd700');

  if ((lobbyData.declined || []).length > 0) {
    document.getElementById('declinedSection').style.display = 'block';
    document.getElementById('declinedMessage').textContent =
      `${lobbyData.declined.join(', ')} ${lobbyData.declined.length > 1 ? 'ont' : 'a'} refusé l'invitation`;
  }

  const isHost = currentUsername === lobbyData.host || isAdmin;
  const canStart = isHost && accepted.length >= 2;
  document.getElementById('startButton').style.display = canStart ? 'inline-flex' : 'none';

  // Demandes en attente (côté hôte)
  renderJoinRequests();
}

// ── Gestion demandes rejoindre ─────────────────────────────────────────────
let pendingJoinRequests = {};

function renderJoinRequests() {
  const section = document.getElementById('join-requests-section');
  const list = document.getElementById('joinRequestsList');
  const isHost = currentUsername === lobbyData.host || isAdmin;
  const keys = Object.keys(pendingJoinRequests);

  if (!isHost || keys.length === 0) {
    section.style.display = 'none';
    return;
  }
  section.style.display = 'block';
  list.innerHTML = '';
  keys.forEach(reqId => {
    const req = pendingJoinRequests[reqId];
    const item = document.createElement('div');
    item.className = 'join-request-item';
    item.innerHTML = `
      <span><span class="jreq-name">${req.from}</span> veut rejoindre le lobby</span>
      <div class="jreq-btns">
        <button class="jreq-btn-accept" onclick="acceptJoinReq('${reqId}','${req.from}')">✓ Accepter</button>
        <button class="jreq-btn-decline" onclick="declineJoinReq('${reqId}','${req.from}')">✕ Refuser</button>
      </div>
    `;
    list.appendChild(item);
  });
}

function acceptJoinReq(reqId, from) {
  socket.emit('accept_join_request', { from, request_id: reqId });
  delete pendingJoinRequests[reqId];
  renderJoinRequests();
}

function declineJoinReq(reqId, from) {
  socket.emit('decline_join_request', { from, request_id: reqId });
  delete pendingJoinRequests[reqId];
  renderJoinRequests();
}

// ── Swap d'équipe ──────────────────────────────────────────────────────────
function canRequestSwap(targetPlayer) {
  const myTeam = (lobbyData.team1 || []).includes(currentUsername) ? 'team1' : 'team2';
  const targetTeam = (lobbyData.team1 || []).includes(targetPlayer) ? 'team1' : 'team2';
  return myTeam !== targetTeam;
}
function requestSwap(withPlayer) { socket.emit('request_team_swap', { with: withPlayer }); }
function acceptSwap() {
  if (currentSwapRequest) {
    socket.emit('accept_team_swap', { request_id: currentSwapRequest });
    document.getElementById('swapRequestNotif').style.display = 'none';
    currentSwapRequest = null;
  }
}
function declineSwap() {
  if (currentSwapRequest) {
    socket.emit('decline_team_swap', { request_id: currentSwapRequest });
    document.getElementById('swapRequestNotif').style.display = 'none';
    currentSwapRequest = null;
  }
}

function continueWithCurrent() { document.getElementById('declinedSection').style.display = 'none'; }
function cancelLobby() { if (confirm('Quitter / annuler le lobby ?')) socket.emit('cancel_lobby'); }
function startGame() { socket.emit('start_game_from_lobby'); }

// ── Socket events ──────────────────────────────────────────────────────────
socket.on('lobby_update', (data) => {
  const isInvited = (data.invited || []).includes(currentUsername);
  const isAccepted = (data.accepted || []).includes(currentUsername);
  if (!isInvited && !isAccepted) { location.href = '/dashboard'; return; }
  lobbyData = data;
  updateLobbyUI();
  loadPlayers();
});

socket.on('team_swap_request', (data) => {
  if (data.to === currentUsername) {
    currentSwapRequest = data.request_id;
    document.getElementById('swapMessage').textContent = `${data.from} veut échanger d'équipe avec vous`;
    document.getElementById('swapRequestNotif').style.display = 'block';
  }
});

// Quelqu'un demande à rejoindre le lobby
socket.on('join_request', (data) => {
  if (data.host === currentUsername || isAdmin) {
    pendingJoinRequests[data.request_id] = { from: data.from };
    renderJoinRequests();
  }
});

socket.on('lobby_cancelled', () => { location.href = '/dashboard'; });
socket.on('game_started', () => { location.href = '/live-score'; });
socket.on('kicked_from_lobby', (data) => {
  if (data && data.kicked_user === currentUsername) {
    toast('Vous avez été exclu du lobby', 'err');
    setTimeout(() => location.href = '/dashboard', 1500);
  }
});

socket.on('error', (data) => { toast('✕ ' + (data.message || 'Erreur'), 'err'); });

function toast(msg, type='inf') {
  const c = document.getElementById('toast-lobby');
  if (!c) return;
  const t = document.createElement('div');
  t.className = 'toast ' + type;
  t.textContent = msg;
  c.appendChild(t);
  setTimeout(() => t.remove(), 3500);
}

async function initPage() {
  await loadCurrentUser();
  await refreshOnlineUsers();
  await loadLobby();
}
initPage();
</script>

<script src="{{ url_for('static', filename='icons.js') }}"></script>
<script src="/static/pwa.js" defer></script>
<script src="{{ url_for('static', filename='profile-utils.js') }}"></script>
</body>
</html>
