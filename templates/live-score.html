<!DOCTYPE html>

<html lang="fr">
<head>
  <link rel="manifest" href="/static/manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="BabyFoot">
  <link rel="apple-touch-icon" href="/static/images/logo.svg">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Partie Live ‚Äî Baby-Foot Club</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='responsive-mobile.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='style-extended.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='live-score-styles.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='global-animations.css') }}">
  <script src="{{ url_for('static', filename='global-animations.js') }}" defer></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
  <script src="{{ url_for('static', filename='animations.js') }}" defer></script>
  <script src="{{ url_for('static', filename='confetti.js') }}" defer></script>
</head>
<body style="font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">

<nav class="nav nav-glass">
  <div class="nav-inner">
    <a href="/dashboard" class="nav-brand">
      <div class="logo-wrapper">
        <img src="{{ url_for('static', filename='images/logo.svg') }}" alt="">
        <div class="logo-pulse"></div>
      </div>
      <span class="brand-text">Baby-Foot Club</span>
    </a>
    <div class="nav-sep"></div>
    <div class="nav-links">
      <a href="/dashboard" class="nav-link"><span class="nav-link-icon" data-bficon="home" data-size="18" style="color:currentColor"></span><span>Dashboard</span></a>
      <a href="/reservation" class="nav-link"><span class="nav-link-icon" data-bficon="calendar" data-size="18" style="color:currentColor"></span><span>R√©server</span></a>
      <a href="/live-score" class="nav-link active"><span class="nav-link-icon" data-bficon="gamepad" data-size="18" style="color:currentColor"></span><span>Partie Live</span></a>
      <a href="/stats" class="nav-link"><span class="nav-link-icon" data-bficon="stats" data-size="18" style="color:currentColor"></span><span>Stats</span></a>
      <a href="/top" class="nav-link"><span class="nav-link-icon" data-bficon="trophy" data-size="18" style="color:currentColor"></span><span>Classement</span></a>
    </div>
    <button class="burger" id="burger" onclick="toggleMenu()" aria-label="Menu">
      <span></span><span></span><span></span>
    </button>
    <div class="nav-right">
      <div class="user-profile-mini">
        <div class="nav-avatar" id="navAv">?</div>
        <span class="nav-username" id="navUsername"></span>
      </div>
      <button class="btn btn-ghost" style="margin-left:1rem" onclick="logout()"><span data-bficon="logout" data-size="16" style="color:currentColor"></span> D√©connexion</button>
    </div>
  </div>
</nav>

<div class="mobile-menu" id="mobileMenu">
  <button class="mobile-menu-close" onclick="toggleMenu()">‚úï</button>
  <a href="/dashboard"><span data-bficon="home" data-size="16"></span> Dashboard</a>
  <a href="/reservation"><span data-bficon="calendar" data-size="16"></span> R√©server</a>
  <a href="/live-score" class="active"><span data-bficon="gamepad" data-size="16"></span> Partie Live</a>
  <a href="/stats"><span data-bficon="stats" data-size="16"></span> Stats</a>
  <a href="/top"><span data-bficon="trophy" data-size="16"></span> Classement</a>
  <a href="#" onclick="logout()"><span data-bficon="logout" data-size="16" style="color:currentColor"></span> D√©connexion</a>
  <button id="pwa-install-trigger" onclick="triggerPwaInstall()" style="display:none;width:100%;text-align:left;background:linear-gradient(135deg,rgba(205,127,50,0.15),rgba(205,127,50,0.05));border:1px solid rgba(205,127,50,0.4);color:#cd7f32;font-weight:700;font-size:1rem;padding:0.9rem 1.25rem;border-radius:10px;cursor:pointer;margin-top:0.5rem;font-family:inherit;"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;display:inline-block;flex-shrink:0"><rect x="5" y="2" width="14" height="20" rx="2"/><path d="M9 13h6M12 10v6"/></svg> Installer l'app</button>
</div>

<div class="page">
  <div class="container" style="max-width:900px">
    <div class="page-header fade-up">
      <h1><span data-bficon="gamepad" data-size="16"></span> Partie Live</h1>
      <p id="pageSub">Suivez le match en direct</p>
    </div>

<!-- ADMIN : Configuration partie -->
<div id="setupArea" style="display:none" class="fade-up">
  <div class="card">
    <div class="card-header"><h3><i class="fas fa-cog"></i> Configuration de la partie</h3></div>
    <div class="card-body">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin-bottom:1.5rem">
        <div>
          <h4 style="color:var(--text-primary);margin-bottom:0.75rem"><span style="display:inline-block;width:9px;height:9px;border-radius:50%;background:#cd7f32;margin-right:6px"></span>√âquipe 1</h4>
          <select id="t1p1" class="input" style="width:100%;margin-bottom:0.5rem">
            <option value="">Joueur 1</option>
          </select>
          <select id="t1p2" class="input" style="width:100%">
            <option value="">Joueur 2 (optionnel)</option>
          </select>
        </div>
        <div>
          <h4 style="color:var(--text-primary);margin-bottom:0.75rem"><span style="display:inline-block;width:9px;height:9px;border-radius:50%;background:#888;margin-right:6px"></span>√âquipe 2</h4>
          <select id="t2p1" class="input" style="width:100%;margin-bottom:0.5rem">
            <option value="">Joueur 1</option>
          </select>
          <select id="t2p2" class="input" style="width:100%">
            <option value="">Joueur 2 (optionnel)</option>
          </select>
        </div>
      </div>
      <button id="btnStart" class="btn btn-primary btn-full btn-lg" onclick="startGame()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;display:inline-block;flex-shrink:0"><circle cx="14" cy="12" r="6"/><path d="M8 12H2"/><path d="M20 4 14 8"/><path d="M18 6 22 2"/></svg> Lancer la partie
      </button>
      <button id="btnUnlockServo" class="btn btn-secondary btn-full" style="margin-top:1rem;display:none" onclick="unlockServo()">
        D√©bloquer Servo (test)
      </button>
    </div>
  </div>
</div>

<!-- SPECTATEUR : Voir le match -->
<div id="spectatorArea" style="display:none" class="fade-up">
  <div class="card">
    <div class="card-header"><h3>üëÅÔ∏è Match en cours</h3></div>
    <div class="card-body">
      <div style="display:grid;grid-template-columns:1fr auto 1fr;gap:2rem;align-items:center;text-align:center;padding:1rem 0">
        <div>
          <div class="score-n" id="specScore1">0</div>
          <div style="font-weight:700;margin-top:0.5rem;color:var(--text-primary)"><span style="display:inline-block;width:9px;height:9px;border-radius:50%;background:#cd7f32;margin-right:5px"></span>√âquipe 1</div>
          <div id="specTeam1" style="font-size:0.875rem;color:var(--text-tertiary);margin-top:0.5rem"></div>
        </div>
        <div class="score-vs">VS</div>
        <div>
          <div class="score-n" id="specScore2">0</div>
          <div style="font-weight:700;margin-top:0.5rem;color:var(--text-primary)"><span style="display:inline-block;width:9px;height:9px;border-radius:50%;background:#888;margin-right:5px"></span>√âquipe 2</div>
          <div id="specTeam2" style="font-size:0.875rem;color:var(--text-tertiary);margin-top:0.5rem"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ADMIN/CR√âATEUR : Contr√¥ler le match -->
<div id="gameArea" style="display:none" class="fade-up">
  <div class="card">
    <div class="card-header">
      <h3><span data-bficon="foosball" data-size="20" style="color:var(--bronze);vertical-align:middle"></span> Partie en cours</h3>
      <div id="gameStatus" style="font-size:0.875rem;color:var(--text-tertiary)"></div>
    </div>
    <div class="card-body">
      <div style="display:grid;grid-template-columns:1fr auto 1fr;gap:2rem;align-items:center;text-align:center;padding:1rem 0">
        <div>
          <div class="score-n" id="score1">0</div>
          <div style="font-weight:700;margin-top:0.5rem;color:var(--text-primary)"><span style="display:inline-block;width:9px;height:9px;border-radius:50%;background:#cd7f32;margin-right:5px"></span>√âquipe 1</div>
          <div id="team1Players" style="font-size:0.875rem;color:var(--text-tertiary);margin-top:0.5rem;margin-bottom:1rem"></div>
          <button class="score-btn" onclick="addPoint('team1')">+1 But</button>
        </div>
        <div class="score-vs">VS</div>
        <div>
          <div class="score-n" id="score2">0</div>
          <div style="font-weight:700;margin-top:0.5rem;color:var(--text-primary)"><span style="display:inline-block;width:9px;height:9px;border-radius:50%;background:#888;margin-right:5px"></span>√âquipe 2</div>
          <div id="team2Players" style="font-size:0.875rem;color:var(--text-tertiary);margin-top:0.5rem;margin-bottom:1rem"></div>
          <button class="score-btn" onclick="addPoint('team2')">+1 But</button>
        </div>
      </div>
      <div style="margin-top:2rem;display:flex;gap:1rem;justify-content:center;flex-wrap:wrap">
        <button class="btn" style="background:rgba(231,76,60,0.15);color:#e74c3c;border:1px solid rgba(231,76,60,0.3)" onclick="stopGame()">
          üõë Arr√™ter la partie
        </button>
      </div>
    </div>
  </div>
</div>

<!-- AUCUN MATCH -->
<div id="noGameArea" style="display:none" class="fade-up">
  <div class="card">
    <div class="card-body" style="text-align:center;padding:3rem 1rem">
      <div style="margin-bottom:1rem;opacity:0.3;display:flex;justify-content:center"><span data-bficon="ball" data-size="64" style="color:var(--text-tertiary)"></span></div>
      <h2 style="color:var(--text-primary);margin-bottom:0.5rem">Aucun match en cours</h2>
      <p style="color:var(--text-tertiary);margin-bottom:2rem">Il n'y a pas de partie active pour le moment</p>
      <a href="/dashboard" class="btn btn-primary">‚Üê Retour au Dashboard</a>
    </div>
  </div>
</div>

<!-- POPUP REMATCH -->
<div id="rematchPopup" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:9999;align-items:center;justify-content:center;backdrop-filter:blur(8px)">
  <div style="background:var(--bg-elevated);padding:2.5rem;border-radius:20px;max-width:420px;width:90%;text-align:center;border:1px solid var(--border-accent)">
    <div style="display:flex;justify-content:center;margin-bottom:1rem"><span data-bficon="replay" data-size="56" style="color:var(--bronze)"></span></div>
    <h2 style="color:var(--text-primary);margin-bottom:0.5rem">Rejouer ?</h2>
    <p style="color:var(--text-tertiary);margin:1rem 0 1.5rem">M√™mes √©quipes, nouvelle partie ?</p>
    <div style="display:flex;gap:1rem">
      <button class="btn btn-primary" style="flex:1" onclick="voteRematch('yes')">‚úì OUI</button>
      <button class="btn" style="flex:1;background:rgba(231,76,60,0.15);color:#e74c3c;border:1px solid rgba(231,76,60,0.3)" onclick="voteRematch('no')">‚úï NON</button>
    </div>
  </div>
</div>

<!-- WINNER OVERLAY -->
<div id="winnerOverlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.92);z-index:9998;align-items:center;justify-content:center;backdrop-filter:blur(12px)">
  <div class="winner-box">
    <div class="winner-emoji" data-bficon="winner" data-size="120" style="color:var(--bronze);margin:0 auto 1.5rem;display:flex;justify-content:center;filter:drop-shadow(0 0 30px rgba(205,127,50,0.5))"></div>
    <div class="winner-ttl" id="winnerTitle">Victoire !</div>
    <div class="winner-sub" id="winnerSub"></div>
  </div>
</div>

  </div>
</div>

<script>
let socket;
try {
  console.log('üîå [Live-Score] Tentative connexion Socket.IO...');
  socket = io({
    reconnection: true,
    reconnectionDelay: 1000,       // Attendre 1s avant 1√®re tentative
    reconnectionDelayMax: 10000,   // Max 10s entre tentatives
    reconnectionAttempts: Infinity, // Toujours r√©essayer
    timeout: 20000,                // 20s avant d'abandonner une connexion
    transports: ['websocket', 'polling'],  // WebSocket d'abord, polling en fallback
  });
  if (window.initReconnectIndicator) initReconnectIndicator(socket);
  socket.on('connect', () => { console.log('‚úì [Live-Score] Socket connect√©'); });
  socket.on('connect_error', (err) => { console.error('‚úï [Live-Score] Erreur:', err); });
} catch(e) {
  console.error('‚úï [Live-Score] Socket.IO impossible:', e);
  alert('‚ö†Ô∏è Connexion temps r√©el impossible. Rechargez la page.');
  socket = { 
    emit: (event) => { console.warn(`‚úï Socket factice: emit(${event}) ignor√©`); },
    on: () => {},
    connected: false
  };
}
let currentUser = null;
let isAdmin = false;
let canControl = false;
let lastGame = null;

function toggleMenu() {
  document.getElementById('burger').classList.toggle('open');
  document.getElementById('mobileMenu').classList.toggle('open');
  document.body.style.overflow = document.getElementById('mobileMenu').classList.contains('open') ? 'hidden' : '';
}

function logout() {
  fetch('/api/logout', {method:'POST'}).then(() => location.href = '/');
}

function showArea(name) {
  ['setupArea','spectatorArea','gameArea','noGameArea'].forEach(id => {
    document.getElementById(id).style.display = 'none';
  });
  if (name) document.getElementById(name).style.display = 'block';
}

function parsePlayers(players) {
  if (!players) return [];
  if (Array.isArray(players)) return players;
  try { return JSON.parse(players); } catch { return [players]; }
}

async function loadUsers() {
  try {
    const users = await fetch('/users_list').then(r => r.json());
    ['t1p1','t1p2','t2p1','t2p2'].forEach(id => {
      const sel = document.getElementById(id);
      users.forEach(u => {
        const opt = document.createElement('option');
        opt.value = u; opt.textContent = u;
        sel.appendChild(opt);
      });
    });
  } catch(e) { console.error('Erreur chargement users:', e); }
}

async function checkActiveGame() {
  try {
    const res = await fetch('/api/has_active_game');
    const data = await res.json();

    const userIsAdmin = data.is_admin || isAdmin;
    const userHasReservation = data.has_reservation;
    const canSetup = userIsAdmin || userHasReservation;

    if (data.has_active_game) {
      const game = data.game_data;
      const t1 = parsePlayers(game.team1_players);
      const t2 = parsePlayers(game.team2_players);
      canControl = userIsAdmin || game.started_by === currentUser;
      // Stocker l'√©tat courant dans lastGame (utile si partie finit pendant rechargement)
      lastGame = {...game, team1_players: t1, team2_players: t2};

      if (canControl) {
        showArea('gameArea');
        updateGameUI(lastGame);
      } else {
        showArea('spectatorArea');
        updateSpectatorUI(lastGame);
      }
    } else {
      if (canSetup) {
        showArea('setupArea');
        document.getElementById('pageSub').textContent = 'Configurer une nouvelle partie';
        loadUsers();
      } else {
        showArea('noGameArea');
      }
    }
  } catch(e) {
    console.error('Erreur checkActiveGame:', e);
    showArea('noGameArea');
  }
}

function updateGameUI(game) {
  const oldScore1 = parseInt(document.getElementById('score1').textContent) || 0;
  const oldScore2 = parseInt(document.getElementById('score2').textContent) || 0;
  
  document.getElementById('score1').textContent = game.team1_score;
  document.getElementById('score2').textContent = game.team2_score;
  document.getElementById('team1Players').textContent = game.team1_players.join(', ');
  document.getElementById('team2Players').textContent = game.team2_players.join(', ');

  // Effet bump sur les scores
  ['score1','score2'].forEach(id => {
    const el = document.getElementById(id);
    el.classList.remove('bump');
    void el.offsetWidth;
    el.classList.add('bump');
  });
  
  // üéâ Lancer confettis si un but a √©t√© marqu√©
  if (game.team1_score > oldScore1 || game.team2_score > oldScore2) {
    if (typeof launchConfetti === 'function') {
      const isMobile = window.matchMedia('(max-width: 768px)').matches;
      launchConfetti(2000, isMobile ? 20 : 50);
    }
  }
}

function updateSpectatorUI(game) {
  const oldScore1 = parseInt(document.getElementById('specScore1').textContent) || 0;
  const oldScore2 = parseInt(document.getElementById('specScore2').textContent) || 0;
  document.getElementById('specScore1').textContent = game.team1_score;
  document.getElementById('specScore2').textContent = game.team2_score;
  document.getElementById('specTeam1').textContent = game.team1_players.join(', ');
  document.getElementById('specTeam2').textContent = game.team2_players.join(', ');

  // Effet bump sur les scores spectateur
  ['specScore1','specScore2'].forEach(id => {
    const el = document.getElementById(id);
    el.classList.remove('bump');
    void el.offsetWidth;
    el.classList.add('bump');
  });

  // üéâ Confettis pour les spectateurs aussi
  if (game.team1_score > oldScore1 || game.team2_score > oldScore2) {
    if (typeof launchConfetti === 'function') {
      const isMobile = window.matchMedia('(max-width: 768px)').matches;
      launchConfetti(2000, isMobile ? 20 : 50);
    }
  }
}

function startGame() {
  const t1 = [
    document.getElementById('t1p1').value,
    document.getElementById('t1p2').value
  ].filter(Boolean);
  const t2 = [
    document.getElementById('t2p1').value,
    document.getElementById('t2p2').value
  ].filter(Boolean);

  if (t1.length === 0 || t2.length === 0) {
    alert('Il faut au moins 1 joueur par √©quipe');
    return;
  }

  // V√©rifier doublons
  const all = [...t1, ...t2];
  if (new Set(all).size !== all.length) {
    alert('Un joueur ne peut pas √™tre dans les deux √©quipes');
    return;
  }

  socket.emit('start_game', {team1: t1, team2: t2});
}

function showToast(msg, type = 'info') {
  let wrap = document.getElementById('ls-toast-wrap');
  if (!wrap) {
    wrap = document.createElement('div');
    wrap.id = 'ls-toast-wrap';
    wrap.style.cssText = 'position:fixed;bottom:1rem;left:50%;transform:translateX(-50%);z-index:9999;display:flex;flex-direction:column;gap:0.5rem;align-items:center;pointer-events:none';
    document.body.appendChild(wrap);
  }
  const t = document.createElement('div');
  const bg = type === 'warn' ? 'rgba(231,152,0,0.95)' : type === 'err' ? 'rgba(231,76,60,0.95)' : 'rgba(39,174,96,0.95)';
  t.style.cssText = `background:${bg};color:white;padding:0.6rem 1.1rem;border-radius:8px;font-size:0.875rem;font-weight:600;white-space:nowrap;box-shadow:0 4px 16px rgba(0,0,0,0.4)`;
  t.textContent = msg;
  wrap.appendChild(t);
  setTimeout(() => t.remove(), 4000);
}

function addPoint(team) {
  // D√©sactiver le bouton bri√®vement pour √©viter double-clic
  const btn = document.querySelector(`[data-team="${team}"].score-btn`) ||
              document.querySelector(`button[onclick="addPoint('${team}')"]`);
  if (btn) { btn.disabled = true; setTimeout(() => btn.disabled = false, 800); }

  let ackReceived = false;
  socket.emit('update_score', {team});

  // Si pas d'acquittement en 3s, on signale visuellement (connexion lente)
  const ackTimeout = setTimeout(() => {
    if (!ackReceived) {
      showToast('‚ö†Ô∏è R√©ponse lente ‚Äî v√©rifiez la connexion', 'warn');
    }
  }, 3000);

  // √âcouter l'ack une seule fois
  socket.once('score_ack', (data) => {
    if (data.team === team) {
      ackReceived = true;
      clearTimeout(ackTimeout);
    }
  });
}

function stopGame() {
  if (confirm('Arr√™ter la partie en cours ?')) {
    socket.emit('stop_game');
  }
}

// Corriger : utilise unlock_servo1 et unlock_servo2
function unlockServo() {
  socket.emit('unlock_servo1');
  setTimeout(() => socket.emit('unlock_servo2'), 100);
}

let winnerOverlayTimer = null;

function voteRematch(vote) {
  socket.emit('vote_rematch', {vote});
  document.getElementById('rematchPopup').style.display = 'none';
}

function showWinner(game) {
  const t1 = parsePlayers(game.team1_players);
  const t2 = parsePlayers(game.team2_players);
  const winnerPlayers = game.winner === 'team1' ? t1 : t2;
  const winnerScore = game.winner === 'team1' ? game.team1_score : game.team2_score;
  const loserScore = game.winner === 'team1' ? game.team2_score : game.team1_score;

  document.getElementById('winnerTitle').textContent = `${winnerPlayers.join(' & ')} gagnent !`;
  document.getElementById('winnerSub').textContent = `Score final : ${winnerScore} - ${loserScore}`;
  document.getElementById('winnerOverlay').style.display = 'flex';
  
  // üéâ MEGA confettis de victoire (r√©duit sur mobile)
  const isMobile = window.matchMedia('(max-width: 768px)').matches;
  const bigCount = isMobile ? 80 : 300;
  const smallCount = isMobile ? 30 : 80;
  if (typeof launchConfetti === 'function') {
    launchConfetti(10000, bigCount);
    setTimeout(() => launchConfetti(1000, smallCount), 800);
    setTimeout(() => launchConfetti(1000, smallCount), 2000);
    if (!isMobile) {
      setTimeout(() => launchConfetti(1000, smallCount), 3500);
      setTimeout(() => launchConfetti(1000, smallCount), 5500);
      setTimeout(() => launchConfetti(1000, smallCount), 7000);
    }
  }

  // Fermer automatiquement apr√®s 7 secondes
  winnerOverlayTimer = setTimeout(() => {
    document.getElementById('winnerOverlay').style.display = 'none';
  }, 7000);
}

// ‚îÄ‚îÄ Socket events ‚îÄ‚îÄ
// game_recovery : √©mis par le serveur √† la reconnexion si partie active
socket.on('game_recovery', (game) => {
  const t1 = parsePlayers(game.team1_players);
  const t2 = parsePlayers(game.team2_players);
  const parsed = {...game, team1_players: t1, team2_players: t2};
  lastGame = parsed;
  canControl = isAdmin || game.started_by === currentUser;
  if (canControl) {
    showArea('gameArea');
    updateGameUI(parsed);
  } else {
    showArea('spectatorArea');
    updateSpectatorUI(parsed);
  }
});

socket.on('game_started', () => {
  // Fermer tous les overlays/popups
  document.getElementById('winnerOverlay').style.display = 'none';
  document.getElementById('rematchPopup').style.display = 'none';
  if (winnerOverlayTimer) { clearTimeout(winnerOverlayTimer); winnerOverlayTimer = null; }
  // Recharger l'√©tat du jeu
  checkActiveGame();
});

socket.on('score_updated', (game) => {
  const t1 = parsePlayers(game.team1_players);
  const t2 = parsePlayers(game.team2_players);
  const parsed = {...game, team1_players: t1, team2_players: t2};
  if (canControl) updateGameUI(parsed);
  else updateSpectatorUI(parsed);
});

socket.on('game_ended', (game) => {
  const t1 = parsePlayers(game.team1_players);
  const t2 = parsePlayers(game.team2_players);
  const parsed = {...game, team1_players: t1, team2_players: t2};
  lastGame = parsed;
  if (canControl) updateGameUI(parsed);
  else updateSpectatorUI(parsed);
  showWinner(parsed);
});

socket.on('game_stopped', () => {
  location.href = '/dashboard';
});

socket.on('game_reset', () => {
  checkActiveGame();
});

socket.on('rematch_prompt', () => {
  // Annuler le timer de fermeture automatique du popup victoire
  if (winnerOverlayTimer) { clearTimeout(winnerOverlayTimer); winnerOverlayTimer = null; }
  // Laisser le popup victoire visible encore 3 secondes avant de montrer le rematch
  setTimeout(() => {
    document.getElementById('winnerOverlay').style.display = 'none';
    const t1 = parsePlayers(lastGame ? lastGame.team1_players : []);
    const t2 = parsePlayers(lastGame ? lastGame.team2_players : []);
    const isInGame = t1.includes(currentUser) || t2.includes(currentUser) || canControl || isAdmin;
    if (isInGame) {
      document.getElementById('rematchPopup').style.display = 'flex';
    }
  }, 3000);
});

socket.on('rematch_cancelled', () => {
  setTimeout(() => location.href = '/dashboard', 500);
});

socket.on('servo1_unlock', () => {
  const btn = document.getElementById('btnUnlockServo');
  if (btn) { btn.textContent = 'Servo d√©verrouill√© (5s)'; btn.style.opacity = '0.6'; }
});
socket.on('servo1_lock', () => {
  const btn = document.getElementById('btnUnlockServo');
  if (btn) { btn.textContent = 'D√©bloquer Servo (test)'; btn.style.opacity = '1'; }
});
socket.on('servo2_unlock', () => {});
socket.on('servo2_lock', () => {});

socket.on('error', (data) => {
  alert('Erreur : ' + data.message);
});

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ
async function init() {
  try {
    const res = await fetch('/current_user');
    if (!res.ok) { location.href = '/login'; return; }
    const user = await res.json();
    if (!user) { location.href = '/login'; return; }

    currentUser = user.username;
    isAdmin = user.is_admin;

    document.getElementById('navUsername').textContent = user.username;
    document.getElementById('navAv').textContent = user.username[0].toUpperCase();

    if (isAdmin) {
      const servoBtn = document.getElementById('btnUnlockServo');
      if (servoBtn) servoBtn.style.display = 'block';
    }

    await checkActiveGame();
  } catch(e) {
    console.error('Erreur init:', e);
  }
}

init();
</script>


<script src="{{ url_for('static', filename='icons.js') }}"></script>
  <script src="/static/pwa.js" defer></script>
</body>
</html>