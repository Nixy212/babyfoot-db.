<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Partie Live ‚Äî Baby-Foot Club</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='responsive-mobile.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='style-extended.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <style>
    .unlock-btn {
      background: linear-gradient(135deg, #f59e0b, #d97706);
      color: white;
      border: none;
      padding: 14px 32px;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      width: 100%;
      margin-top: 16px;
      transition: opacity 0.2s;
    }
    .unlock-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    .unlock-btn:not(:disabled):hover { opacity: 0.85; }
    .reservation-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(16,185,129,0.12);
      border: 1px solid rgba(16,185,129,0.3);
      color: #10b981;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      margin-bottom: 16px;
    }
    .no-reservation-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(239,68,68,0.12);
      border: 1px solid rgba(239,68,68,0.3);
      color: #ef4444;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      margin-bottom: 16px;
    }
    .score-display {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 40px;
      padding: 32px;
    }
    .team-score { text-align: center; }
    .team-name { font-size: 0.8rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.06em; color: var(--text-2); margin-bottom: 8px; }
    .team-players { font-size: 0.875rem; color: var(--text-2); margin-bottom: 12px; }
    .score-big { font-size: 5rem; font-weight: 700; font-family: 'Space Mono', monospace; line-height: 1; }
    .score-vs { font-size: 1.5rem; font-weight: 700; color: var(--text-3); }
    .bump { animation: bump 0.25s ease; }
    @keyframes bump { 0%{transform:scale(1)} 50%{transform:scale(1.3)} 100%{transform:scale(1)} }
  </style>
</head>
<body style="font-family: 'DM Sans', sans-serif;">
<nav class="nav nav-glass">
  <div class="nav-inner">
    <a href="/dashboard" class="nav-brand"><div class="logo-wrapper">
      <img src="{{ url_for('static', filename='images/logo.svg') }}" alt="">Baby-Foot Club
    </a>
    <div class="nav-sep"></div>
    <div class="nav-links">
      <a href="/dashboard" class="nav-link">Dashboard</a>
      <a href="/reservation" class="nav-link">R√©server</a>
      <a href="/live-score" class="nav-link active">Partie Live</a>
      <a href="/stats" class="nav-link">Stats</a>
      <a href="/top" class="nav-link">Top 10</a>
    </div>
    <div class="nav-right">
      <span class="conn-dot off" id="cdot"></span>
      <span id="ctext" style="font-size:0.75rem;color:var(--text-3);margin-right:8px">‚Ä¶</span>
      <div class="nav-avatar" id="navAv">?</div>
    </div>
  </div>
</nav>

<div class="page">
  <div class="container" style="max-width:800px">
    <div class="page-header fade-up">
      <h1>Partie en direct</h1>
      <p>Score en temps r√©el via Arduino</p>
    </div>

    <!-- Statut r√©servation -->
    <div id="resStatus" class="fade-up" style="text-align:center;margin-bottom:8px"></div>

    <!-- Setup -->
    <div id="setup" class="card fade-up" style="animation-delay:.05s">
      <div class="card-header"><h3>Configuration</h3></div>
      <div class="card-body">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px">
          <div>
            <label class="label" style="color:var(--brn-l)">üîµ √âquipe 1</label>
            <div class="drop-wrap" style="margin-bottom:8px">
              <input type="text" id="t1p1" placeholder="Joueur 1" autocomplete="off">
              <div id="d-t1p1" class="player-dd"></div>
            </div>
            <div class="drop-wrap">
              <input type="text" id="t1p2" placeholder="Joueur 2 (optionnel)" autocomplete="off">
              <div id="d-t1p2" class="player-dd"></div>
            </div>
          </div>
          <div>
            <label class="label" style="color:var(--red)">üî¥ √âquipe 2</label>
            <div class="drop-wrap" style="margin-bottom:8px">
              <input type="text" id="t2p1" placeholder="Joueur 1" autocomplete="off">
              <div id="d-t2p1" class="player-dd"></div>
            </div>
            <div class="drop-wrap">
              <input type="text" id="t2p2" placeholder="Joueur 2 (optionnel)" autocomplete="off">
              <div id="d-t2p2" class="player-dd"></div>
            </div>
          </div>
        </div>
        <button id="startBtn" class="btn btn-primary btn-full btn-lg" disabled>üéØ D√©marrer la partie</button>
        <p id="startHint" style="text-align:center;font-size:0.8rem;color:var(--text-3);margin-top:8px">
          ‚è≥ V√©rification de votre r√©servation...
        </p>
      </div>
    </div>

    <!-- Scoreboard -->
    <div id="board" class="card fade-up" style="display:none;animation-delay:.05s">
      <div class="card-header">
        <h3>üéÆ Partie en cours</h3>
        <span style="font-size:0.8rem;color:var(--text-3)">Les buts sont d√©tect√©s automatiquement par l'Arduino</span>
      </div>
      <div class="score-display">
        <div class="team-score">
          <div class="team-name">üîµ √âquipe 1</div>
          <div class="team-players" id="n1"></div>
          <div class="score-big" id="s1">0</div>
        </div>
        <div class="score-vs">VS</div>
        <div class="team-score">
          <div class="team-name">üî¥ √âquipe 2</div>
          <div class="team-players" id="n2"></div>
          <div class="score-big" id="s2">0</div>
        </div>
      </div>
      <div style="padding:0 32px 24px;display:flex;gap:8px;justify-content:center">
        <button id="resetBtn" class="btn btn-danger">üîÑ Nouvelle partie</button>
        <a href="/dashboard" class="btn btn-ghost">‚Üê Dashboard</a>
      </div>
    </div>
  </div>
</div>

<!-- Winner + bouton d√©verrouillage -->
<div class="winner-overlay" id="win" style="display:none">
  <div class="winner-box">
    <div class="winner-emoji">üèÜ</div>
    <div class="winner-ttl" id="wname">√âquipe 1 gagne !</div>
    <p class="winner-sub">Partie termin√©e ‚Äî scores enregistr√©s</p>
    <div style="margin:16px 0">
      <button class="unlock-btn" id="unlockBtn" onclick="unlockServo()">
        üîì D√©verrouiller la balle
      </button>
      <p style="font-size:0.75rem;color:var(--text-3);margin-top:8px">
        Appuyez pour lib√©rer la balle via l'Arduino
      </p>
    </div>
    <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:8px">
      <button class="btn btn-primary btn-lg" onclick="newGame()">Nouvelle partie</button>
      <a href="/dashboard" class="btn btn-secondary btn-lg">Dashboard</a>
    </div>
  </div>
</div>

<div class="toast-wrap" id="tw"></div>

<script>
let allUsers = [];
let hasReservation = false;
const socket = io();

function toast(msg, type='inf') {
  const c=document.getElementById('tw'), t=document.createElement('div');
  t.className=`toast ${type}`; t.textContent=msg; c.appendChild(t);
  setTimeout(()=>t.remove(),3200);
}

// V√©rifier si l'utilisateur a une r√©servation active maintenant
async function checkReservation() {
  const resStatus = document.getElementById('resStatus');
  const startBtn  = document.getElementById('startBtn');
  const startHint = document.getElementById('startHint');

  try {
    const [resData, userData] = await Promise.all([
      fetch('/reservations_all').then(r=>r.json()),
      fetch('/current_user').then(r=>r.json())
    ]);

    const username = userData.username;
    const now = new Date();
    const days = ['dimanche','lundi','mardi','mercredi','jeudi','vendredi','samedi'];
    const todayName = days[now.getDay()];
    const currentTime = now.getHours() * 60 + now.getMinutes();

    let found = false;
    // Chercher une r√©servation active maintenant pour cet utilisateur
    for (const [day, slots] of Object.entries(resData)) {
      if (!day.toLowerCase().includes(todayName) && !isToday(day)) continue;
      for (const [time, slot] of Object.entries(slots)) {
        const allPlayers = [...(slot.team1||[]), ...(slot.team2||[])];
        if (!allPlayers.includes(username)) continue;

        // V√©rifier si le cr√©neau est actif maintenant (cr√©neau de 25 min)
        const [h, m] = time.split(':').map(Number);
        const slotStart = h * 60 + m;
        const slotEnd   = slotStart + 25;

        if (currentTime >= slotStart && currentTime < slotEnd) {
          found = true;
          // Pr√©-remplir les √©quipes
          if (slot.team1[0]) document.getElementById('t1p1').value = slot.team1[0];
          if (slot.team1[1]) document.getElementById('t1p2').value = slot.team1[1];
          if (slot.team2[0]) document.getElementById('t2p1').value = slot.team2[0];
          if (slot.team2[1]) document.getElementById('t2p2').value = slot.team2[1];
          break;
        }
      }
      if (found) break;
    }

    hasReservation = found;
    if (found) {
      resStatus.innerHTML = '<span class="reservation-badge">‚úÖ R√©servation active ‚Äî Partie disponible</span>';
      startBtn.disabled = false;
      startHint.style.display = 'none';
    } else {
      resStatus.innerHTML = '<span class="no-reservation-badge">‚ùå Aucune r√©servation active en ce moment</span>';
      startBtn.disabled = true;
      startHint.textContent = 'Vous devez avoir une r√©servation active pour d√©marrer une partie.';
    }
  } catch(e) {
    console.error(e);
    startHint.textContent = 'Erreur lors de la v√©rification.';
  }
}

function isToday(dayStr) {
  const now = new Date();
  const days = ['dimanche','lundi','mardi','mercredi','jeudi','vendredi','samedi'];
  return dayStr.toLowerCase().includes(days[now.getDay()]);
}

// D√©verrouiller la balle via le servo
function unlockServo() {
  const btn = document.getElementById('unlockBtn');
  btn.disabled = true;
  btn.textContent = '‚è≥ D√©verrouillage...';
  socket.emit('unlock_servo');
  setTimeout(() => {
    btn.textContent = '‚úÖ Balle lib√©r√©e !';
  }, 1500);
}

// Chargement initial
fetch('/current_user').then(r=>r.json()).then(d=>{
  if(d.username) document.getElementById('navAv').textContent=d.username[0].toUpperCase();
});
fetch('/all_users').then(r=>r.json()).then(u=>{ allUsers=u; setupDrops(); });
checkReservation();
// Rev√©rifier toutes les minutes
setInterval(checkReservation, 60000);

function setupDrops() {
  ['t1p1','t1p2','t2p1','t2p2'].forEach(id=>{
    const inp = document.getElementById(id);
    const dd  = document.getElementById(`d-${id}`);
    if(!inp||!dd) return;
    function show(v) {
      const f = allUsers.filter(u=>!v||u.toLowerCase().includes(v.toLowerCase()));
      dd.innerHTML = f.map(u=>`<div class="dd-item" onmousedown="pick('${u}','${id}')">${u}</div>`).join('')||'<div class="dd-empty">Aucun r√©sultat</div>';
      dd.style.display='block';
    }
    inp.addEventListener('focus',()=>show(inp.value));
    inp.addEventListener('input',()=>show(inp.value));
    inp.addEventListener('blur', ()=>setTimeout(()=>dd.style.display='none',150));
  });
}
window.pick=(u,id)=>{ document.getElementById(id).value=u; document.getElementById(`d-${id}`).style.display='none'; };

socket.on('connect',()=>{ document.getElementById('cdot').className='conn-dot on'; document.getElementById('ctext').textContent='Connect√©'; });
socket.on('disconnect',()=>{ document.getElementById('cdot').className='conn-dot off'; document.getElementById('ctext').textContent='D√©connect√©'; });

socket.on('game_started', d=>{
  document.getElementById('setup').style.display='none';
  document.getElementById('board').style.display='block';
  document.getElementById('n1').textContent=d.team1_players.join(' & ');
  document.getElementById('n2').textContent=d.team2_players.join(' & ');
  document.getElementById('s1').textContent='0';
  document.getElementById('s2').textContent='0';
});

socket.on('score_updated', d=>{
  const bump=(el, val)=>{
    if(parseInt(el.textContent)!==val){ el.textContent=val; el.classList.add('bump'); setTimeout(()=>el.classList.remove('bump'),250); }
  };
  bump(document.getElementById('s1'),d.team1_score);
  bump(document.getElementById('s2'),d.team2_score);
});

socket.on('game_ended', d=>{
  document.getElementById('s1').textContent=d.team1_score;
  document.getElementById('s2').textContent=d.team2_score;
  document.getElementById('wname').textContent=d.winner==='team1'?'üîµ √âquipe 1 gagne !':'üî¥ √âquipe 2 gagne !';
  // R√©activer le bouton d√©verrouillage
  const btn = document.getElementById('unlockBtn');
  btn.disabled = false;
  btn.textContent = 'üîì D√©verrouiller la balle';
  document.getElementById('win').style.display='flex';
});

socket.on('error', d=>toast(d.message||'Erreur','err'));
socket.on('game_reset', ()=>newGame());

document.getElementById('startBtn').addEventListener('click',()=>{
  if (!hasReservation) { toast('Aucune r√©servation active', 'err'); return; }
  const team1=[document.getElementById('t1p1').value.trim(),document.getElementById('t1p2').value.trim()].filter(Boolean);
  const team2=[document.getElementById('t2p1').value.trim(),document.getElementById('t2p2').value.trim()].filter(Boolean);
  if(!team1.length||!team2.length){toast('Chaque √©quipe doit avoir au moins un joueur','err');return;}
  socket.emit('start_game',{team1,team2});
});

document.getElementById('resetBtn').addEventListener('click',()=>socket.emit('reset_game'));

function newGame(){
  document.getElementById('win').style.display='none';
  document.getElementById('board').style.display='none';
  document.getElementById('setup').style.display='block';
  ['t1p1','t1p2','t2p1','t2p2'].forEach(id=>document.getElementById(id).value='');
  checkReservation();
}
</script>
</body>
</html>
