<!DOCTYPE html>
<html lang="fr">
<head>
  <link rel="manifest" href="/static/manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="BabyFoot">
  <link rel="apple-touch-icon" href="/static/images/logo.svg">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Partie Live â€” Baby-Foot Club</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='responsive-mobile.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='style-extended.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='live-score-styles.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='global-animations.css') }}">
  <script src="{{ url_for('static', filename='global-animations.js') }}" defer></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
  <script src="{{ url_for('static', filename='animations.js') }}" defer></script>
  <script src="{{ url_for('static', filename='confetti.js') }}" defer></script>
  <style>
    /* â”€â”€ Zones d'Ã©tat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .state-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.4rem 1rem;
      border-radius: 99px;
      font-size: 0.8rem;
      font-weight: 700;
      margin-bottom: 1rem;
    }
    .badge-live { background: rgba(231,76,60,0.15); color: #e74c3c; border: 1px solid rgba(231,76,60,0.3); }
    .badge-live::before { content: ''; display: inline-block; width: 7px; height: 7px; border-radius: 50%; background: #e74c3c; animation: blink 1.2s ease-in-out infinite; }
    @keyframes blink { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }
    .badge-spectating { background: rgba(52,152,219,0.12); color: #3498db; border: 1px solid rgba(52,152,219,0.25); }
    .badge-setup { background: rgba(205,127,50,0.12); color: #cd7f32; border: 1px solid rgba(205,127,50,0.25); }

    /* â”€â”€ Carte infos rÃ´le â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .role-info {
      background: var(--bg-secondary);
      border: 1px solid var(--border-subtle);
      border-radius: 10px;
      padding: 0.875rem 1.25rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 0.875rem;
      color: var(--text-tertiary);
      margin-bottom: 1.5rem;
    }
    .role-info i { color: var(--bronze); flex-shrink: 0; }

    /* â”€â”€ Page no game â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .no-game-options {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-top: 1.5rem;
    }
    .no-game-option {
      background: var(--bg-secondary);
      border: 1px solid var(--border-normal);
      border-radius: 12px;
      padding: 1.25rem;
      text-align: center;
      text-decoration: none;
      color: var(--text-primary);
      transition: all 0.2s;
    }
    .no-game-option:hover { background: var(--bg-hover); border-color: var(--border-accent); transform: translateY(-3px); }
    .no-game-option-icon { font-size: 2rem; margin-bottom: 0.5rem; }
    .no-game-option-label { font-weight: 700; font-size: 0.95rem; margin-bottom: 0.25rem; }
    .no-game-option-sub { font-size: 0.8rem; color: var(--text-muted); }
    @media (max-width: 500px) { .no-game-options { grid-template-columns: 1fr; } }
  </style>
</head>
<body style="font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">

<nav class="nav nav-glass">
  <div class="nav-inner">
    <a href="/dashboard" class="nav-brand">
      <div class="logo-wrapper">
        <img src="{{ url_for('static', filename='images/logo.svg') }}" alt="">
        <div class="logo-pulse"></div>
      </div>
      <span class="brand-text">Baby-Foot Club</span>
    </a>
    <div class="nav-sep"></div>
    <div class="nav-links">
      <a href="/dashboard" class="nav-link"><span class="nav-link-icon" data-bficon="home" data-size="18" style="color:currentColor"></span><span>Dashboard</span></a>
      <a href="/reservation" class="nav-link"><span class="nav-link-icon" data-bficon="calendar" data-size="18" style="color:currentColor"></span><span>RÃ©server</span></a>
      <a href="/live-score" class="nav-link active"><span class="nav-link-icon" data-bficon="gamepad" data-size="18" style="color:currentColor"></span><span>Partie Live</span></a>
      <a href="/stats" class="nav-link"><span class="nav-link-icon" data-bficon="stats" data-size="18" style="color:currentColor"></span><span>Stats</span></a>
      <a href="/top" class="nav-link"><span class="nav-link-icon" data-bficon="trophy" data-size="18" style="color:currentColor"></span><span>Classement</span></a>
    </div>
    <button class="burger" id="burger" onclick="toggleMenu()" aria-label="Menu"><span></span><span></span><span></span></button>
    <div class="nav-right">
      <div class="user-profile-mini">
        <div class="nav-avatar" id="navAv">?</div>
        <span class="nav-username" id="navUsername"></span>
      </div>
      <button class="btn btn-ghost" style="margin-left:1rem" onclick="logout()"><span data-bficon="logout" data-size="16" style="color:currentColor"></span> DÃ©connexion</button>
    </div>
  </div>
</nav>

<div class="mobile-menu" id="mobileMenu">
  <button class="mobile-menu-close" onclick="toggleMenu()">âœ•</button>
  <a href="/dashboard">ğŸ  Dashboard</a>
  <a href="/reservation">ğŸ“… RÃ©server</a>
  <a href="/live-score" class="active">ğŸ® Partie Live</a>
  <a href="/lobby">ğŸ‘¥ Lobby</a>
  <a href="/stats">ğŸ“Š Stats</a>
  <a href="/top">ğŸ† Classement</a>
  <a href="/scores">ğŸ“‹ Historique</a>
  <a href="/settings">âš™ï¸ ParamÃ¨tres</a>
  <a href="#" onclick="logout()">ğŸšª DÃ©connexion</a>
  <button id="pwa-install-trigger" onclick="triggerPwaInstall()" style="display:none;width:100%;text-align:left;background:linear-gradient(135deg,rgba(205,127,50,0.15),rgba(205,127,50,0.05));border:1px solid rgba(205,127,50,0.4);color:#cd7f32;font-weight:700;font-size:1rem;padding:0.9rem 1.25rem;border-radius:10px;cursor:pointer;margin-top:0.5rem;font-family:inherit;">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:middle;margin-right:6px"><rect x="5" y="2" width="14" height="20" rx="2"/><path d="M9 13h6M12 10v6"/></svg>Installer l'app
  </button>
</div>

<div class="page">
  <div class="container" style="max-width:900px">
    <div class="page-header fade-up">
      <h1><span data-bficon="gamepad" data-size="16"></span> Partie Live</h1>
      <p id="pageSub">Scores en direct â€” mis Ã  jour instantanÃ©ment pour tous les joueurs</p>
    </div>

<!-- â”€â”€ ADMIN / CRÃ‰ATEUR : Configuration â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="setupArea" style="display:none" class="fade-up">
  <div class="card">
    <div class="card-header">
      <h3><i class="fas fa-cog"></i> Configurer la partie</h3>
      <span class="state-badge badge-setup"><i class="fas fa-sliders-h"></i> Setup</span>
    </div>
    <div class="card-body">
      <p style="color:var(--text-tertiary);font-size:0.875rem;margin-bottom:1.5rem">
        Choisissez au moins 1 joueur par Ã©quipe. Les scores seront attribuÃ©s Ã  chaque joueur individuellement et comptabilisÃ©s dans leur historique.
      </p>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin-bottom:1.5rem">
        <div>
          <h4 style="color:var(--text-primary);margin-bottom:0.75rem;display:flex;align-items:center;gap:8px">
            <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#cd7f32"></span>Ã‰quipe 1
          </h4>
          <select id="t1p1" class="input" style="width:100%;margin-bottom:0.5rem"><option value="">Joueur principal</option></select>
          <select id="t1p2" class="input" style="width:100%"><option value="">2Ã¨me joueur (optionnel, mode 2v2)</option></select>
        </div>
        <div>
          <h4 style="color:var(--text-primary);margin-bottom:0.75rem;display:flex;align-items:center;gap:8px">
            <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#888"></span>Ã‰quipe 2
          </h4>
          <select id="t2p1" class="input" style="width:100%;margin-bottom:0.5rem"><option value="">Joueur principal</option></select>
          <select id="t2p2" class="input" style="width:100%"><option value="">2Ã¨me joueur (optionnel, mode 2v2)</option></select>
        </div>
      </div>
      <button id="btnStart" class="btn btn-primary btn-full btn-lg" onclick="startGame()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:middle;margin-right:8px"><polygon points="5 3 19 12 5 21 5 3"/></svg>Lancer la partie
      </button>
      <p style="text-align:center;font-size:0.8rem;color:var(--text-muted);margin-top:0.75rem">
        <i class="fas fa-info-circle"></i> Le lancement dÃ©verrouille la balle et dÃ©marre le chrono pour tous
      </p>
      <button id="btnUnlockServo" class="btn btn-secondary btn-full" style="margin-top:0.75rem;display:none" onclick="unlockServo()">
        <i class="fas fa-unlock"></i> DÃ©verrouiller la balle (test)
      </button>
    </div>
  </div>
</div>

<!-- â”€â”€ SPECTATEUR : Observer le match â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="spectatorArea" style="display:none" class="fade-up">
  <div class="card">
    <div class="card-header">
      <h3>âš¡ Match en cours</h3>
      <span class="state-badge badge-live"><span style="display:inline-block;width:7px;height:7px;border-radius:50%;background:#e74c3c;animation:blink 1.2s ease-in-out infinite;margin-right:4px"></span>LIVE</span>
    </div>
    <div class="card-body">
      <div style="display:grid;grid-template-columns:1fr auto 1fr;gap:2rem;align-items:center;text-align:center;padding:1rem 0">
        <div>
          <div class="score-n" id="specScore1">0</div>
          <div style="font-weight:700;margin-top:0.5rem;color:var(--text-primary)"><span style="display:inline-block;width:9px;height:9px;border-radius:50%;background:#cd7f32;margin-right:5px"></span>Ã‰quipe 1</div>
          <div id="specTeam1" style="font-size:0.875rem;color:var(--text-tertiary);margin-top:0.5rem"></div>
        </div>
        <div class="score-vs">VS</div>
        <div>
          <div class="score-n" id="specScore2">0</div>
          <div style="font-weight:700;margin-top:0.5rem;color:var(--text-primary)"><span style="display:inline-block;width:9px;height:9px;border-radius:50%;background:#888;margin-right:5px"></span>Ã‰quipe 2</div>
          <div id="specTeam2" style="font-size:0.875rem;color:var(--text-tertiary);margin-top:0.5rem"></div>
        </div>
      </div>
      <div style="margin-top:1rem;text-align:center;font-size:0.8rem;color:var(--text-muted)">
        <i class="fas fa-sync-alt fa-spin" style="margin-right:5px"></i>Mise Ã  jour automatique
      </div>
    </div>
  </div>
</div>

<!-- â”€â”€ ADMIN/CRÃ‰ATEUR : ContrÃ´ler le match â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="gameArea" style="display:none" class="fade-up">
  <div class="card">
    <div class="card-header">
      <h3><span data-bficon="foosball" data-size="20" style="color:var(--bronze);vertical-align:middle"></span> Partie en cours</h3>
      <span class="state-badge badge-live"><span style="display:inline-block;width:7px;height:7px;border-radius:50%;background:#e74c3c;animation:blink 1.2s ease-in-out infinite;margin-right:4px"></span>LIVE</span>
    </div>
    <div class="card-body">
      <div style="display:grid;grid-template-columns:1fr auto 1fr;gap:2rem;align-items:center;text-align:center;padding:1rem 0">
        <div>
          <div class="score-n" id="score1">0</div>
          <div style="font-weight:700;margin-top:0.5rem;color:var(--text-primary)"><span style="display:inline-block;width:9px;height:9px;border-radius:50%;background:#cd7f32;margin-right:5px"></span>Ã‰quipe 1</div>
          <div id="team1Players" style="font-size:0.875rem;color:var(--text-tertiary);margin-top:0.5rem;margin-bottom:1.25rem"></div>
          <button class="score-btn" id="btnScore1" onclick="addPoint('team1')" style="font-size:1rem;padding:0.875rem 1.5rem">
            <i class="fas fa-plus" style="margin-right:6px"></i>1 But
          </button>
        </div>
        <div class="score-vs">VS</div>
        <div>
          <div class="score-n" id="score2">0</div>
          <div style="font-weight:700;margin-top:0.5rem;color:var(--text-primary)"><span style="display:inline-block;width:9px;height:9px;border-radius:50%;background:#888;margin-right:5px"></span>Ã‰quipe 2</div>
          <div id="team2Players" style="font-size:0.875rem;color:var(--text-tertiary);margin-top:0.5rem;margin-bottom:1.25rem"></div>
          <button class="score-btn" id="btnScore2" onclick="addPoint('team2')" style="font-size:1rem;padding:0.875rem 1.5rem">
            <i class="fas fa-plus" style="margin-right:6px"></i>1 But
          </button>
        </div>
      </div>
      <div style="margin-top:2rem;display:flex;gap:1rem;justify-content:center;flex-wrap:wrap">
        <button class="btn" style="background:rgba(231,76,60,0.15);color:#e74c3c;border:1px solid rgba(231,76,60,0.3)" onclick="stopGame()">
          <i class="fas fa-stop" style="margin-right:6px"></i>ArrÃªter la partie
        </button>
      </div>
    </div>
  </div>
</div>

<!-- â”€â”€ AUCUN MATCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="noGameArea" style="display:none" class="fade-up">
  <div class="card">
    <div class="card-body" style="text-align:center;padding:3rem 1rem">
      <div style="margin-bottom:1rem;opacity:0.25;display:flex;justify-content:center">
        <span data-bficon="ball" data-size="64" style="color:var(--text-tertiary)"></span>
      </div>
      <h2 style="color:var(--text-primary);margin-bottom:0.5rem">Aucune partie en cours</h2>
      <p style="color:var(--text-tertiary);margin-bottom:0.5rem">
        Il n'y a pas de match actif pour le moment. Pour lancer une partie, il faut :
      </p>
      <ol style="text-align:left;max-width:320px;margin:1rem auto;color:var(--text-tertiary);font-size:0.875rem;line-height:1.8;list-style:none;padding:0">
        <li style="display:flex;align-items:flex-start;gap:0.6rem;margin-bottom:0.4rem"><span style="background:rgba(205,127,50,0.2);color:#cd7f32;width:22px;height:22px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-weight:700;font-size:0.78rem;flex-shrink:0;margin-top:1px">1</span> Avoir une rÃ©servation active</li>
        <li style="display:flex;align-items:flex-start;gap:0.6rem;margin-bottom:0.4rem"><span style="background:rgba(205,127,50,0.2);color:#cd7f32;width:22px;height:22px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-weight:700;font-size:0.78rem;flex-shrink:0;margin-top:1px">2</span> CrÃ©er un lobby et inviter des adversaires</li>
        <li style="display:flex;align-items:flex-start;gap:0.6rem"><span style="background:rgba(205,127,50,0.2);color:#cd7f32;width:22px;height:22px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-weight:700;font-size:0.78rem;flex-shrink:0;margin-top:1px">3</span> Lancer la partie depuis le lobby</li>
      </ol>
      <div class="no-game-options" style="max-width:400px;margin:0 auto">
        <a href="/reservation" class="no-game-option">
          <div class="no-game-option-icon">ğŸ“…</div>
          <div class="no-game-option-label">RÃ©server</div>
          <div class="no-game-option-sub">Bloquer un crÃ©neau</div>
        </a>
        <a href="/dashboard" class="no-game-option">
          <div class="no-game-option-icon">ğŸ®</div>
          <div class="no-game-option-label">CrÃ©er un Lobby</div>
          <div class="no-game-option-sub">Depuis le dashboard</div>
        </a>
      </div>
    </div>
  </div>
</div>

<!-- â”€â”€ POPUP REMATCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="rematchPopup" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:9999;align-items:center;justify-content:center;backdrop-filter:blur(8px)">
  <div style="background:var(--bg-elevated);padding:2.5rem;border-radius:20px;max-width:420px;width:90%;text-align:center;border:1px solid var(--border-accent)">
    <div style="display:flex;justify-content:center;margin-bottom:1rem"><span data-bficon="replay" data-size="56" style="color:var(--bronze)"></span></div>
    <h2 style="color:var(--text-primary);margin-bottom:0.25rem">Rejouer ?</h2>
    <p style="color:var(--text-tertiary);margin:0.25rem 0 1.25rem;font-size:0.85rem">MÃªme configuration, nouvelle partie ?</p>
    <!-- Compteurs de votes -->
    <div style="display:flex;justify-content:center;gap:2rem;margin-bottom:1.5rem">
      <div style="text-align:center">
        <div id="voteYesCount" style="font-size:2rem;font-weight:800;color:#2ecc71">0</div>
        <div style="font-size:0.75rem;color:var(--text-muted)">OUI</div>
      </div>
      <div style="font-size:1.5rem;color:var(--text-muted);align-self:center">/</div>
      <div style="text-align:center">
        <div id="voteNoCount" style="font-size:2rem;font-weight:800;color:#e74c3c">0</div>
        <div style="font-size:0.75rem;color:var(--text-muted)">NON</div>
      </div>
    </div>
    <div id="voteStatus" style="font-size:0.82rem;color:var(--text-muted);margin-bottom:1.25rem"></div>
    <div id="myVoteButtons" style="display:flex;gap:1rem">
      <button class="btn btn-primary" style="flex:1" onclick="voteRematch('yes')">âœ“ OUI</button>
      <button class="btn" style="flex:1;background:rgba(231,76,60,0.15);color:#e74c3c;border:1px solid rgba(231,76,60,0.3)" onclick="voteRematch('no')">âœ• Non</button>
    </div>
    <div id="myVoteConfirm" style="display:none;font-size:0.9rem;color:var(--text-muted);margin-top:0.5rem">Vote enregistrÃ© â€” en attente des autres...</div>
  </div>
</div>

<!-- â”€â”€ POPUP HÃ”TE : Remplacer ou Quitter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="hostDecisionPopup" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:10000;align-items:center;justify-content:center;backdrop-filter:blur(8px)">
  <div style="background:var(--bg-elevated);padding:2.5rem;border-radius:20px;max-width:420px;width:90%;text-align:center;border:1px solid rgba(231,76,60,0.4)">
    <div style="font-size:2rem;margin-bottom:0.75rem">âš ï¸</div>
    <h2 style="color:var(--text-primary);margin-bottom:0.5rem">Joueur refuse</h2>
    <p id="hostDecisionMsg" style="color:var(--text-tertiary);margin:0.5rem 0 1.5rem;font-size:0.9rem"></p>
    <div style="display:flex;flex-direction:column;gap:0.75rem">
      <button class="btn btn-primary" style="width:100%" onclick="hostReplacePlayer()">ğŸ‘¤ Remplacer par un joueur</button>
      <button class="btn" style="width:100%;background:rgba(231,76,60,0.15);color:#e74c3c;border:1px solid rgba(231,76,60,0.3)" onclick="hostQuitRematch()">âœ• Annuler â€” tout le monde quitte</button>
    </div>
  </div>
</div>

<!-- â”€â”€ POPUP EXPIRATION RÃ‰SA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="resaExpiryPopup" style="display:none;position:fixed;bottom:1.5rem;left:50%;transform:translateX(-50%);z-index:9990;min-width:300px;max-width:90vw">
  <div style="background:var(--bg-elevated);border:1px solid rgba(231,152,0,0.5);border-radius:16px;padding:1.25rem 1.5rem;box-shadow:0 8px 32px rgba(0,0,0,0.5);backdrop-filter:blur(12px);text-align:center">
    <div style="font-size:1.5rem;margin-bottom:0.5rem" id="resaExpiryIcon">â°</div>
    <div style="font-weight:700;color:var(--text-primary);margin-bottom:0.25rem" id="resaExpiryTitle">RÃ©servation bientÃ´t terminÃ©e</div>
    <div style="font-size:0.85rem;color:var(--text-tertiary)" id="resaExpirySub">Il vous reste 2 minutes</div>
  </div>
</div>

<!-- â”€â”€ WINNER OVERLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="winnerOverlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.92);z-index:9998;align-items:center;justify-content:center;backdrop-filter:blur(12px)">
  <div class="winner-box">
    <div class="winner-emoji" data-bficon="winner" data-size="120" style="color:var(--bronze);margin:0 auto 1.5rem;display:flex;justify-content:center;filter:drop-shadow(0 0 30px rgba(205,127,50,0.5))"></div>
    <div class="winner-ttl" id="winnerTitle">Victoire !</div>
    <div class="winner-sub" id="winnerSub"></div>
  </div>
</div>

  </div>
</div>

<script>
let socket;
try {
  socket = io({
    reconnection: true, reconnectionDelay: 1000, reconnectionDelayMax: 10000,
    reconnectionAttempts: Infinity, timeout: 20000,
    transports: ['websocket', 'polling'],
  });
  if (window.initReconnectIndicator) initReconnectIndicator(socket);
} catch(e) {
  socket = { emit: (ev) => {}, on: () => {}, once: () => {}, connected: false };
}

let currentUser = null;
let isAdmin = false;
let canControl = false;
let lastGame = null;

function toggleMenu() {
  document.getElementById('burger').classList.toggle('open');
  document.getElementById('mobileMenu').classList.toggle('open');
  document.body.style.overflow = document.getElementById('mobileMenu').classList.contains('open') ? 'hidden' : '';
}
function logout() { fetch('/api/logout', {method:'POST'}).then(() => location.href = '/'); }

function showArea(name) {
  ['setupArea','spectatorArea','gameArea','noGameArea'].forEach(id => {
    document.getElementById(id).style.display = 'none';
  });
  if (name) document.getElementById(name).style.display = 'block';
}

function parsePlayers(players) {
  if (!players) return [];
  if (Array.isArray(players)) return players;
  try { return JSON.parse(players); } catch { return [players]; }
}

async function loadUsers() {
  try {
    const rawUsers = await fetch('/users_list').then(r => r.json());
    // users_list retourne des objets {username, nickname, ...}
    const GUEST_RE = /^Joueur\d+$/i;
    ['t1p1','t1p2','t2p1','t2p2'].forEach(id => {
      const sel = document.getElementById(id);
      // Vider sauf la premiÃ¨re option
      while (sel.options.length > 1) sel.remove(1);
      rawUsers.forEach(u => {
        const username = typeof u === 'string' ? u : u.username;
        const nickname = (typeof u === 'object' && u.nickname) ? u.nickname.trim() : '';
        if (GUEST_RE.test(username)) return; // exclure les guests physiques des selects
        const opt = document.createElement('option');
        opt.value = username;
        opt.textContent = nickname ? `${nickname} (${username})` : username;
        sel.appendChild(opt);
      });
      // Ajouter les guests comme option sÃ©parÃ©e
      const sep = document.createElement('option'); sep.disabled = true; sep.textContent = 'â”€â”€ Joueurs physiques â”€â”€'; sel.appendChild(sep);
      rawUsers.forEach(u => {
        const username = typeof u === 'string' ? u : u.username;
        if (!GUEST_RE.test(username)) return;
        const opt = document.createElement('option');
        opt.value = username; opt.textContent = username;
        sel.appendChild(opt);
      });
    });
  } catch(e) { console.error('loadUsers error:', e); }
}

async function checkActiveGame() {
  try {
    const res = await fetch('/api/has_active_game');
    const data = await res.json();
    const userIsAdmin = data.is_admin || isAdmin;
    const hasResa = data.has_reservation;
    const canSetup = userIsAdmin || hasResa;

    if (data.has_active_game) {
      const game = data.game_data;
      const t1 = parsePlayers(game.team1_players);
      const t2 = parsePlayers(game.team2_players);
      // Peut contrÃ´ler : admin OU hÃ´te de la partie OU joueur dans la partie avec rÃ©sa
      const isInGame = t1.includes(currentUser) || t2.includes(currentUser);
      canControl = userIsAdmin || game.started_by === currentUser || isInGame;
      const canScore = userIsAdmin; // seul l'admin peut scorer manuellement
      lastGame = {...game, team1_players: t1, team2_players: t2};

      if (canControl) {
        showArea('gameArea');
        document.getElementById('pageSub').textContent = 'Partie en cours â€” marquez les buts et tous voient le score instantanÃ©ment';
        updateGameUI(lastGame);
        const s1 = document.getElementById('btnScore1');
        const s2 = document.getElementById('btnScore2');
        if (s1) s1.style.display = canScore ? '' : 'none';
        if (s2) s2.style.display = canScore ? '' : 'none';
        if (!canScore) {
          const infoEl = document.querySelector('#gameArea .role-info span');
          if (infoEl) infoEl.innerHTML = '<strong style="color:var(--text-primary)">Partie en cours</strong> â€” tu peux suivre le score. Les buts sont enregistrÃ©s par le capteur ou par un responsable.';
        }
      } else {
        showArea('spectatorArea');
        document.getElementById('pageSub').textContent = 'Partie en direct â€” le score se met Ã  jour automatiquement';
        updateSpectatorUI(lastGame);
      }
    } else {
      if (canSetup) {
        showArea('setupArea');
        document.getElementById('pageSub').textContent = 'PrÃªt Ã  jouer â€” configurez votre partie ci-dessous';
        await loadUsers();
      } else {
        showArea('noGameArea');
        document.getElementById('pageSub').textContent = 'Aucune partie en cours';
      }
    }
  } catch(e) { console.error('checkActiveGame error:', e); showArea('noGameArea'); }
}

// Profils chargÃ©s en mÃ©moire
let _profilesCache = {};
async function ensureProfiles() {
  if (Object.keys(_profilesCache).length === 0) {
    _profilesCache = await ProfileUtils.fetchAllProfiles();
  }
}
function renderTeamPlayers(elId, players) {
  const el = document.getElementById(elId);
  if (!el) return;
  const parts = players.map(u => {
    const p = _profilesCache[u] || { username: u };
    const name = (p.nickname && p.nickname.trim()) ? p.nickname.trim() : u;
    return `<span title="${u}">${name}</span>`;
  });
  el.innerHTML = parts.join('<span style="opacity:.5;margin:0 4px">&</span>');
}

function updateGameUI(game) {
  const old1 = parseInt(document.getElementById('score1').textContent) || 0;
  const old2 = parseInt(document.getElementById('score2').textContent) || 0;
  document.getElementById('score1').textContent = game.team1_score;
  document.getElementById('score2').textContent = game.team2_score;
  renderTeamPlayers('team1Players', game.team1_players);
  renderTeamPlayers('team2Players', game.team2_players);
  ['score1','score2'].forEach(id => {
    const el = document.getElementById(id);
    el.classList.remove('bump'); void el.offsetWidth; el.classList.add('bump');
  });
  if (game.team1_score > old1 || game.team2_score > old2) {
    if (typeof launchConfetti === 'function') launchConfetti(2000, window.matchMedia('(max-width:768px)').matches ? 20 : 50);
  }
}

function updateSpectatorUI(game) {
  const old1 = parseInt(document.getElementById('specScore1').textContent) || 0;
  const old2 = parseInt(document.getElementById('specScore2').textContent) || 0;
  document.getElementById('specScore1').textContent = game.team1_score;
  document.getElementById('specScore2').textContent = game.team2_score;
  renderTeamPlayers('specTeam1', game.team1_players);
  renderTeamPlayers('specTeam2', game.team2_players);
  ['specScore1','specScore2'].forEach(id => {
    const el = document.getElementById(id);
    el.classList.remove('bump'); void el.offsetWidth; el.classList.add('bump');
  });
  if (game.team1_score > old1 || game.team2_score > old2) {
    if (typeof launchConfetti === 'function') launchConfetti(2000, window.matchMedia('(max-width:768px)').matches ? 20 : 50);
  }
}

function startGame() {
  const t1 = [document.getElementById('t1p1').value, document.getElementById('t1p2').value].filter(Boolean);
  const t2 = [document.getElementById('t2p1').value, document.getElementById('t2p2').value].filter(Boolean);
  if (t1.length === 0 || t2.length === 0) { showToast('Il faut au moins 1 joueur par Ã©quipe', 'err'); return; }
  const all = [...t1, ...t2];
  if (new Set(all).size !== all.length) { showToast('Un joueur ne peut pas Ãªtre dans les deux Ã©quipes', 'err'); return; }
  socket.emit('start_game', {team1: t1, team2: t2});
}

function showToast(msg, type = 'info') {
  let wrap = document.getElementById('ls-toast-wrap');
  if (!wrap) {
    wrap = document.createElement('div');
    wrap.id = 'ls-toast-wrap';
    wrap.style.cssText = 'position:fixed;bottom:1rem;left:50%;transform:translateX(-50%);z-index:9999;display:flex;flex-direction:column;gap:0.5rem;align-items:center;pointer-events:none';
    document.body.appendChild(wrap);
  }
  const t = document.createElement('div');
  const bg = type === 'warn' ? 'rgba(231,152,0,0.95)' : type === 'err' ? 'rgba(231,76,60,0.95)' : 'rgba(39,174,96,0.95)';
  t.style.cssText = `background:${bg};color:white;padding:0.6rem 1.1rem;border-radius:8px;font-size:0.875rem;font-weight:600;white-space:nowrap;box-shadow:0 4px 16px rgba(0,0,0,0.4)`;
  t.textContent = msg;
  wrap.appendChild(t);
  setTimeout(() => t.remove(), 4000);
}

function addPoint(team) {
  if (!isAdmin) { showToast('â›” Seuls les admins peuvent marquer des points depuis l\'interface', 'err'); return; }
  const btnEl = document.getElementById(team === 'team1' ? 'btnScore1' : 'btnScore2');
  if (btnEl) { btnEl.disabled = true; setTimeout(() => btnEl.disabled = false, 800); }
  socket.emit('update_score', {team});
}

function stopGame() {
  if (confirm('ArrÃªter la partie et enregistrer les scores dÃ©finitivement ?')) socket.emit('stop_game');
}

function unlockServo() { socket.emit('unlock_servo1'); setTimeout(() => socket.emit('unlock_servo2'), 100); }

let winnerOverlayTimer = null;
let myRematchVote = null;
let declinedPlayer = null;

function voteRematch(vote) {
  if (myRematchVote) return; // dÃ©jÃ  votÃ©
  myRematchVote = vote;
  socket.emit('vote_rematch', {vote});
  // Cacher les boutons, montrer confirmation
  document.getElementById('myVoteButtons').style.display = 'none';
  document.getElementById('myVoteConfirm').style.display = 'block';
  document.getElementById('myVoteConfirm').textContent = vote === 'yes' ? 'âœ“ Vote OUI enregistrÃ© â€” en attente des autres...' : 'âœ• Vote NON enregistrÃ© â€” en attente de l'hÃ´te...';
}

function hostReplacePlayer() {
  document.getElementById('hostDecisionPopup').style.display = 'none';
  // Ouvrir la recherche d'un joueur (rediriger vers lobby ou afficher un champ)
  showToast('Invitez un joueur via le lobby pour le remplacer', 'info');
}

function hostQuitRematch() {
  document.getElementById('hostDecisionPopup').style.display = 'none';
  socket.emit('host_quit_rematch');
}

function showRematchPopup() {
  myRematchVote = null;
  document.getElementById('voteYesCount').textContent = '0';
  document.getElementById('voteNoCount').textContent = '0';
  document.getElementById('voteStatus').textContent = '';
  document.getElementById('myVoteButtons').style.display = 'flex';
  document.getElementById('myVoteConfirm').style.display = 'none';
  document.getElementById('rematchPopup').style.display = 'flex';
}

function showWinner(game) {
  const t1 = parsePlayers(game.team1_players);
  const t2 = parsePlayers(game.team2_players);
  const winners = game.winner === 'team1' ? t1 : t2;
  const ws = game.winner === 'team1' ? game.team1_score : game.team2_score;
  const ls = game.winner === 'team1' ? game.team2_score : game.team1_score;
  document.getElementById('winnerTitle').textContent = `${winners.join(' & ')} gagnent !`;
  document.getElementById('winnerSub').textContent = `Score final : ${ws} â€“ ${ls}`;
  document.getElementById('winnerOverlay').style.display = 'flex';
  const isMobile = window.matchMedia('(max-width:768px)').matches;
  if (typeof launchConfetti === 'function') {
    launchConfetti(10000, isMobile ? 80 : 300);
    setTimeout(() => launchConfetti(1000, isMobile ? 30 : 80), 800);
    setTimeout(() => launchConfetti(1000, isMobile ? 30 : 80), 2000);
  }
  winnerOverlayTimer = setTimeout(() => { document.getElementById('winnerOverlay').style.display = 'none'; }, 4000);
}

// â”€â”€ Socket events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
socket.on('game_recovery', (game) => {
  const t1 = parsePlayers(game.team1_players), t2 = parsePlayers(game.team2_players);
  const parsed = {...game, team1_players: t1, team2_players: t2};
  lastGame = parsed;
  canControl = isAdmin || game.started_by === currentUser;
  if (canControl) { showArea('gameArea'); updateGameUI(parsed); }
  else { showArea('spectatorArea'); updateSpectatorUI(parsed); }
});

socket.on('game_started', (game) => {
  document.getElementById('winnerOverlay').style.display = 'none';
  document.getElementById('rematchPopup').style.display = 'none';
  hideResaExpiry();
  resaExpiryWarned2min = false; resaExpiryWarned0min = false;
  if (winnerOverlayTimer) { clearTimeout(winnerOverlayTimer); winnerOverlayTimer = null; }
  if (game && game.team1_players) {
    const t1 = parsePlayers(game.team1_players), t2 = parsePlayers(game.team2_players);
    lastGame = {...game, team1_players: t1, team2_players: t2};
  }
  checkActiveGame();
});

socket.on('score_updated', (game) => {
  const t1 = parsePlayers(game.team1_players), t2 = parsePlayers(game.team2_players);
  const parsed = {...game, team1_players: t1, team2_players: t2};
  if (canControl) updateGameUI(parsed); else updateSpectatorUI(parsed);
});

socket.on('game_ended', (game) => {
  const t1 = parsePlayers(game.team1_players), t2 = parsePlayers(game.team2_players);
  const parsed = {...game, team1_players: t1, team2_players: t2};
  lastGame = parsed;
  if (canControl) updateGameUI(parsed); else updateSpectatorUI(parsed);
  const isParticipant = t1.includes(currentUser) || t2.includes(currentUser) || canControl || isAdmin;
  if (isParticipant) showWinner(parsed);
  else { showToast('ğŸ† Partie terminÃ©e !', 'info'); setTimeout(() => showArea('noGameArea'), 3000); }
});

socket.on('game_stopped', () => { location.href = '/dashboard'; });
socket.on('game_reset', () => { checkActiveGame(); });
socket.on('rematch_prompt', () => {
  if (winnerOverlayTimer) { clearTimeout(winnerOverlayTimer); winnerOverlayTimer = null; }
  // Pas de dÃ©lai â€” afficher le vote immÃ©diatement
  document.getElementById('winnerOverlay').style.display = 'none';
  const t1 = parsePlayers(lastGame ? lastGame.team1_players : []);
  const t2 = parsePlayers(lastGame ? lastGame.team2_players : []);
  const isInGame = t1.includes(currentUser) || t2.includes(currentUser) || canControl || isAdmin;
  if (isInGame) showRematchPopup();
  else { showToast('Partie terminÃ©e â€” retour dashboard...', 'info'); setTimeout(() => location.href = '/dashboard', 2000); }
});
socket.on('rematch_vote_update', (data) => {
  document.getElementById('voteYesCount').textContent = data.yes;
  document.getElementById('voteNoCount').textContent = data.no;
  const remaining = data.total - data.yes - data.no;
  document.getElementById('voteStatus').textContent = remaining > 0 ? `En attente de ${remaining} joueur${remaining > 1 ? 's' : ''}...` : '';
  if (data.no_player) {
    showToast(`${data.no_player} a votÃ© NON`, 'err');
  }
});
socket.on('host_replace_or_quit', (data) => {
  const isHost = currentUser === data.host || isAdmin;
  if (!isHost) return;
  document.getElementById('hostDecisionMsg').textContent = `${data.declined_player} ne veut pas rejouer. Que faire ?`;
  document.getElementById('hostDecisionPopup').style.display = 'flex';
});
socket.on('rematch_cancelled', () => {
  document.getElementById('rematchPopup').style.display = 'none';
  document.getElementById('hostDecisionPopup').style.display = 'none';
  document.getElementById('winnerOverlay').style.display = 'none';
  if (winnerOverlayTimer) { clearTimeout(winnerOverlayTimer); winnerOverlayTimer = null; }
  showToast('Pas de revanche â€” retour dashboard...', 'info');
  setTimeout(() => location.href = '/dashboard', 1500);
});
socket.on('error', (data) => { showToast('Erreur : ' + (data.message || '?'), 'err'); });

// â”€â”€ Message ELO aprÃ¨s partie â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
socket.on('elo_updated', (data) => {
  if (!data || !data.changes) return;
  const me = data.changes.find(c => c.player === currentUser);
  if (!me) return;
  const delta = me.delta;
  const sign = delta >= 0 ? '+' : '';
  const color = delta >= 0 ? '#2ecc71' : '#e74c3c';

  let msg = '';
  if (me.tier_up) {
    msg = `ğŸ‰ Niveau supÃ©rieur ! Tu es maintenant ${me.new_tier} !`;
    showEloToast(msg, color, true);
  } else if (delta >= 20) {
    msg = `ğŸ”¥ Belle victoire ! ${sign}${delta} pts ELO`;
    showEloToast(msg, color, false);
  } else if (delta > 0) {
    msg = `âœ… +${delta} pts ELO`;
    showEloToast(msg, color, false);
  } else if (me.tier_down) {
    msg = `ğŸ“‰ Niveau perdu... ${sign}${delta} pts ELO`;
    showEloToast(msg, '#e74c3c', false);
  } else if (delta < 0) {
    msg = `${sign}${delta} pts ELO â€” revanche ?`;
    showEloToast(msg, '#e67e22', false);
  }
});

function showEloToast(msg, color, isBig) {
  const t = document.createElement('div');
  t.style.cssText = `position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(0.8);z-index:10000;
    background:var(--bg-elevated);border:2px solid ${color};border-radius:20px;
    padding:${isBig ? '2rem 2.5rem' : '1.25rem 2rem'};text-align:center;
    box-shadow:0 8px 40px rgba(0,0,0,0.6);backdrop-filter:blur(12px);
    font-size:${isBig ? '1.3rem' : '1rem'};font-weight:700;color:var(--text-primary);
    opacity:0;transition:all 0.3s ease;max-width:90vw`;
  t.textContent = msg;
  document.body.appendChild(t);
  requestAnimationFrame(() => {
    t.style.opacity = '1';
    t.style.transform = 'translate(-50%,-50%) scale(1)';
  });
  setTimeout(() => {
    t.style.opacity = '0';
    t.style.transform = 'translate(-50%,-50%) scale(0.9)';
    setTimeout(() => t.remove(), 400);
  }, isBig ? 4000 : 3000);
}

// â”€â”€ Surveillance expiration rÃ©sa â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let resaExpiryWarned2min = false, resaExpiryWarned0min = false, resaExpiryInterval = null;
function startResaExpiryWatch() {
  if (resaExpiryInterval) clearInterval(resaExpiryInterval);
  resaExpiryInterval = setInterval(checkResaExpiry, 30000);
  checkResaExpiry();
}
async function checkResaExpiry() {
  if (!lastGame || !lastGame.active) return;
  const t1 = parsePlayers(lastGame ? lastGame.team1_players : []);
  const t2 = parsePlayers(lastGame ? lastGame.team2_players : []);
  if (!t1.includes(currentUser) && !t2.includes(currentUser)) return;
  if (isAdmin) return; // Pas de popup pour les admins
  try {
    const res = await fetch('/api/babyfoot_status');
    const status = await res.json();
    const current = status.current;
    if (!current) {
      if (!resaExpiryWarned0min) {
        resaExpiryWarned0min = true;
        showResaExpiry('âš ï¸','RÃ©servation expirÃ©e','Votre crÃ©neau est terminÃ© â€” finissez ou arrÃªtez la partie','rgba(231,76,60,0.5)');
        setTimeout(() => hideResaExpiry(), 10000);
      }
      return;
    }
    const msLeft = new Date(current.end_time) - new Date();
    const minLeft = Math.floor(msLeft / 60000);
    if (minLeft <= 2 && minLeft > 0 && !resaExpiryWarned2min) {
      resaExpiryWarned2min = true;
      showResaExpiry('â°','RÃ©servation bientÃ´t terminÃ©e',`Il vous reste environ ${minLeft} minute${minLeft > 1 ? 's' : ''} â€” pensez Ã  conclure !`,'rgba(231,152,0,0.5)');
      setTimeout(() => hideResaExpiry(), 8000);
    } else if (minLeft > 2) { resaExpiryWarned2min = false; resaExpiryWarned0min = false; }
  } catch(e) {}
}
function showResaExpiry(icon, title, sub, borderColor) {
  const popup = document.getElementById('resaExpiryPopup');
  document.getElementById('resaExpiryIcon').textContent = icon;
  document.getElementById('resaExpiryTitle').textContent = title;
  document.getElementById('resaExpirySub').textContent = sub;
  popup.querySelector('div').style.borderColor = borderColor;
  popup.style.display = 'block';
}
function hideResaExpiry() { document.getElementById('resaExpiryPopup').style.display = 'none'; }

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  try {
    const res = await fetch('/current_user');
    if (!res.ok) { location.href = '/login'; return; }
    const user = await res.json();
    if (!user) { location.href = '/login'; return; }
    currentUser = user.username;
    isAdmin = user.is_admin;
    window._currentUsername = user.username;
    ProfileUtils.updateNav(user);
    if (isAdmin) { const sb = document.getElementById('btnUnlockServo'); if (sb) sb.style.display = 'block'; }
    await ensureProfiles();
    await checkActiveGame();
    startResaExpiryWatch();
  } catch(e) {}
}
init();
</script>

<script src="{{ url_for('static', filename='icons.js') }}"></script>
<script src="{{ url_for('static', filename='profile-utils.js') }}"></script>
<script src="/static/pwa.js" defer></script>
</body>
</html>
