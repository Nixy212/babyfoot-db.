<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Partie Live â€” Baby-Foot Club</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='responsive-mobile.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='style-extended.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='global-animations.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script src="{{ url_for('static', filename='global-animations.js') }}" defer></script>
  <style>
    .unlock-btn {
      background: linear-gradient(135deg, #f59e0b, #d97706);
      color: white; border: none; padding: 14px 32px;
      border-radius: 12px; font-size: 1rem; font-weight: 700;
      cursor: pointer; width: 100%; margin-top: 16px; transition: opacity 0.2s;
    }
    .unlock-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .unlock-btn:not(:disabled):hover { opacity: 0.85; }
    .badge-ok {
      display: inline-flex; align-items: center; gap: 6px;
      background: rgba(16,185,129,0.12); border: 1px solid rgba(16,185,129,0.3);
      color: #10b981; padding: 6px 14px; border-radius: 20px;
      font-size: 0.8rem; font-weight: 600; margin-bottom: 16px;
    }
    .badge-err {
      display: inline-flex; align-items: center; gap: 6px;
      background: rgba(239,68,68,0.12); border: 1px solid rgba(239,68,68,0.3);
      color: #ef4444; padding: 6px 14px; border-radius: 20px;
      font-size: 0.8rem; font-weight: 600; margin-bottom: 16px;
    }
    .score-display { display: flex; align-items: center; justify-content: center; gap: 40px; padding: 32px; }
    .team-score { text-align: center; }
    .team-name { font-size: 0.8rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.06em; color: var(--text-2); margin-bottom: 8px; }
    .team-players { font-size: 0.875rem; color: var(--text-2); margin-bottom: 12px; }
    .score-big { font-size: 5rem; font-weight: 700; font-family: 'Space Mono', monospace; line-height: 1; }
    .score-vs { font-size: 1.5rem; font-weight: 700; color: var(--text-3); }
    .bump { animation: bump 0.25s ease; }
    @keyframes bump { 0%{transform:scale(1)} 50%{transform:scale(1.3)} 100%{transform:scale(1)} }
  </style>
</head>
<body style="font-family: 'DM Sans', sans-serif;">
<nav class="nav nav-glass">
  <div class="nav-inner">
    <a href="/dashboard" class="nav-brand"><div class="logo-wrapper">
      <img src="{{ url_for('static', filename='images/logo.svg') }}" alt="">Baby-Foot Club
    </a>
    <div class="nav-sep"></div>
    <div class="nav-links">
      <a href="/dashboard" class="nav-link">Dashboard</a>
      <a href="/reservation" class="nav-link">RÃ©server</a>
      <a href="/live-score" class="nav-link active">Partie Live</a>
      <a href="/stats" class="nav-link">Stats</a>
      <a href="/top" class="nav-link">Top 10</a>
    </div>
        <button class="burger" id="burger" onclick="toggleMenu()" aria-label="Menu">
      <span></span><span></span><span></span>
    </button>
    <div class="nav-right">
      <span class="conn-dot off" id="cdot"></span>
      <span id="ctext" style="font-size:0.75rem;color:var(--text-3);margin-right:8px">â€¦</span>
      <div class="nav-avatar" id="navAv">?</div>
    </div>
  </div>
</nav>
<!-- Mobile Menu -->
<div class="mobile-menu" id="mobileMenu">
  <button class="mobile-menu-close" onclick="toggleMenu()">âœ•</button>
  <a href="/dashboard">ğŸ  Dashboard</a>
  <a href="/reservation">ğŸ“… RÃ©server</a>
  <a href="/live-score">ğŸ® Partie Live</a>
  <a href="/stats">ğŸ“Š Stats</a>
  <a href="/top">ğŸ† Top 10</a>
  <a href="#" onclick="fetch(\`/api/logout\`,{method:\`POST\`}).then(()=>location.href=\`/\`)">ğŸšª DÃ©connexion</a>
</div>
<script id="burger-script">
function toggleMenu() {
  document.getElementById("burger").classList.toggle("open");
  document.getElementById("mobileMenu").classList.toggle("open");
  document.body.style.overflow = document.getElementById("mobileMenu").classList.contains("open") ? "hidden" : "";
}
document.querySelectorAll(".mobile-menu a").forEach(a => a.addEventListener("click", () => {
  if (!a.getAttribute("onclick")) toggleMenu();
}));
const path = window.location.pathname;
document.querySelectorAll(".mobile-menu a").forEach(a => {
  if (a.getAttribute("href") === path) a.classList.add("active");
});
</script>

<div class="page">
  <div class="container" style="max-width:800px">
    <div class="page-header fade-up">
      <h1>Partie en direct</h1>
      <p>Score en temps rÃ©el via Arduino</p>
    </div>

    <div id="resStatus" class="fade-up" style="text-align:center;margin-bottom:8px"></div>

    <!-- Setup -->
    <div id="setup" class="card fade-up" style="animation-delay:.05s">
      <div class="card-header"><h3>Configuration</h3></div>
      <div class="card-body">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px">
          <div>
            <label class="label" style="color:var(--brn-l)">ğŸ”µ Ã‰quipe 1</label>
            <div class="drop-wrap" style="margin-bottom:8px">
              <input type="text" id="t1p1" placeholder="Joueur 1" autocomplete="off">
              <div id="d-t1p1" class="player-dd"></div>
            </div>
            <div class="drop-wrap">
              <input type="text" id="t1p2" placeholder="Joueur 2 (optionnel)" autocomplete="off">
              <div id="d-t1p2" class="player-dd"></div>
            </div>
          </div>
          <div>
            <label class="label" style="color:var(--red)">ğŸ”´ Ã‰quipe 2</label>
            <div class="drop-wrap" style="margin-bottom:8px">
              <input type="text" id="t2p1" placeholder="Joueur 1" autocomplete="off">
              <div id="d-t2p1" class="player-dd"></div>
            </div>
            <div class="drop-wrap">
              <input type="text" id="t2p2" placeholder="Joueur 2 (optionnel)" autocomplete="off">
              <div id="d-t2p2" class="player-dd"></div>
            </div>
          </div>
        </div>
        <button id="startBtn" class="btn btn-primary btn-full btn-lg" disabled>ğŸ¯ DÃ©marrer la partie</button>
        <p id="startHint" style="text-align:center;font-size:0.8rem;color:var(--text-3);margin-top:8px">â³ VÃ©rification...</p>
      </div>
    </div>

    <!-- Scoreboard -->
    <div id="board" class="card fade-up" style="display:none;animation-delay:.05s">
      <div class="card-header">
        <h3>ğŸ® Partie en cours</h3>
        <span style="font-size:0.8rem;color:var(--text-3)">Buts dÃ©tectÃ©s automatiquement par l'Arduino</span>
      </div>
      <div class="score-display">
        <div class="team-score">
          <div class="team-name">ğŸ”µ Ã‰quipe 1</div>
          <div class="team-players" id="n1"></div>
          <div class="score-big" id="s1">0</div>
        </div>
        <div class="score-vs">VS</div>
        <div class="team-score">
          <div class="team-name">ğŸ”´ Ã‰quipe 2</div>
          <div class="team-players" id="n2"></div>
          <div class="score-big" id="s2">0</div>
        </div>
      </div>
      <!-- Boutons +1 But visibles uniquement admin -->
      <div id="adminButBtns" style="display:none;padding:0 32px 8px;display:none;gap:8px;justify-content:center;flex-wrap:wrap">
        <button class="btn btn-secondary" onclick="socket.emit('update_score',{team:'team1'})">+1 But ğŸ”µ Ã‰quipe 1</button>
        <button class="btn btn-secondary" onclick="socket.emit('update_score',{team:'team2'})">+1 But ğŸ”´ Ã‰quipe 2</button>
      </div>
      <div style="padding:0 32px 24px;display:flex;gap:8px;justify-content:center;flex-wrap:wrap">
        <button id="abandonBtn" class="btn btn-danger" onclick="abandonGame()">â›” Abandonner</button>
        <a href="/dashboard" class="btn btn-ghost">â† Dashboard</a>
      </div>
    </div>
  </div>
</div>

<!-- Panneau admin toujours visible -->
<div id="adminPanel" style="display:none;margin-top:16px">
  <div class="card fade-up">
    <div class="card-header">
      <h3>ğŸ‘‘ Panneau Admin</h3>
    </div>
    <div class="card-body" style="display:flex;flex-direction:column;gap:10px">
      <button class="unlock-btn" id="unlockBtnAdmin" onclick="unlockServo()" style="margin-top:0">
        ğŸ”“ DÃ©verrouiller la balle
      </button>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn btn-danger" style="flex:1" onclick="forceReset()">â›” Forcer reset partie</button>
        <button class="btn btn-primary" style="flex:1" onclick="startGameAdmin()">ğŸ¯ DÃ©marrer sans rÃ©servation</button>
      </div>
    </div>
  </div>
</div>

<!-- Winner + bouton dÃ©verrouillage -->
<div class="winner-overlay" id="win" style="display:none">
  <div class="winner-box">
    <div class="winner-emoji">ğŸ†</div>
    <div class="winner-ttl" id="wname">Ã‰quipe 1 gagne !</div>
    <p class="winner-sub">Partie terminÃ©e â€” scores enregistrÃ©s</p>
    <div style="margin:16px 0">
      <button class="unlock-btn" id="unlockBtn" onclick="unlockServo()">
        ğŸ”“ DÃ©verrouiller la balle
      </button>
      <p style="font-size:0.75rem;color:var(--text-3);margin-top:8px">LibÃ¨re la balle via l'Arduino</p>
    </div>
    <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:8px">
      <button class="btn btn-primary btn-lg" onclick="newGame()">Nouvelle partie</button>
      <a href="/dashboard" class="btn btn-secondary btn-lg">Dashboard</a>
    </div>
  </div>
</div>

<!-- Modal dÃ©verrouillage au dÃ©but de partie -->
<div class="winner-overlay" id="startUnlock" style="display:none">
  <div class="winner-box">
    <div class="winner-emoji">âš½</div>
    <div class="winner-ttl">Partie lancÃ©e !</div>
    <p class="winner-sub">DÃ©verrouillez la balle pour commencer Ã  jouer</p>
    <div style="margin:24px 0">
      <button class="unlock-btn" onclick="unlockAndStart()">
        ğŸ”“ DÃ©verrouiller la balle
      </button>
      <p style="font-size:0.75rem;color:var(--text-3);margin-top:8px">Le servo restera ouvert pendant toute la partie</p>
    </div>
    <button class="btn btn-ghost" onclick="skipUnlock()">Passer</button>
  </div>
</div>

<div class="toast-wrap" id="tw"></div>

<script>
let allUsers    = [];
let hasAccess   = false;
let currentUser = '';
const socket    = io();

function toast(msg, type='inf') {
  const c=document.getElementById('tw'), t=document.createElement('div');
  t.className=`toast ${type}`; t.textContent=msg; c.appendChild(t);
  setTimeout(()=>t.remove(),3200);
}

async function checkAccess() {
  const resStatus = document.getElementById('resStatus');
  const startBtn  = document.getElementById('startBtn');
  const startHint = document.getElementById('startHint');

  try {
    const [userData, adminData] = await Promise.all([
      fetch('/current_user').then(r=>r.json()),
      fetch('/api/is_admin').then(r=>r.json())
    ]);

    currentUser = userData.username;
    if (currentUser) {
      document.getElementById('navAv').textContent = currentUser[0].toUpperCase();
    }

    // Compte admin â€” accÃ¨s total sans contrainte
    if (adminData.is_admin) {
      hasAccess = true;
      resStatus.innerHTML = '<span class="badge-ok">ğŸ‘‘ Compte admin â€” AccÃ¨s total</span>';
      startBtn.disabled = false;
      startHint.style.display = 'none';
      document.getElementById('adminPanel').style.display = 'block';
      return;
    }

    // VÃ©rifier rÃ©servation active
    const [resData] = await Promise.all([
      fetch('/reservations_all').then(r=>r.json())
    ]);

    const now = new Date();
    const days = ['dimanche','lundi','mardi','mercredi','jeudi','vendredi','samedi'];
    const todayName = days[now.getDay()];
    const currentMinutes = now.getHours() * 60 + now.getMinutes();

    let found = false;
    for (const [day, slots] of Object.entries(resData)) {
      if (!day.toLowerCase().includes(todayName)) continue;
      for (const [time, slot] of Object.entries(slots)) {
        const allPlayers = [...(slot.team1||[]), ...(slot.team2||[])];
        if (!allPlayers.includes(currentUser)) continue;
        const [h, m] = time.split(':').map(Number);
        const slotStart = h * 60 + m;
        const slotEnd   = slotStart + 25;
        if (currentMinutes >= slotStart && currentMinutes < slotEnd) {
          found = true;
          if (slot.team1[0]) document.getElementById('t1p1').value = slot.team1[0];
          if (slot.team1[1]) document.getElementById('t1p2').value = slot.team1[1];
          if (slot.team2[0]) document.getElementById('t2p1').value = slot.team2[0];
          if (slot.team2[1]) document.getElementById('t2p2').value = slot.team2[1];
          break;
        }
      }
      if (found) break;
    }

    hasAccess = found;
    if (found) {
      resStatus.innerHTML = '<span class="badge-ok">âœ… RÃ©servation active â€” Partie disponible</span>';
      startBtn.disabled = false;
      startHint.style.display = 'none';
    } else {
      resStatus.innerHTML = '<span class="badge-err">âŒ Aucune rÃ©servation active en ce moment</span>';
      startBtn.disabled = true;
      startHint.textContent = 'Vous devez avoir une rÃ©servation active pour jouer.';
    }
  } catch(e) {
    console.error(e);
    startHint.textContent = 'Erreur lors de la vÃ©rification.';
  }
}

function unlockServo() {
  const btn = document.getElementById('unlockBtn');
  const btnAdmin = document.getElementById('unlockBtnAdmin');
  if (btn) { btn.disabled = true; btn.textContent = 'â³ DÃ©verrouillage...'; }
  if (btnAdmin) { btnAdmin.disabled = true; btnAdmin.textContent = 'â³ DÃ©verrouillage...'; }
  socket.emit('unlock_servo');
  setTimeout(() => {
    if (btn) btn.textContent = 'âœ… Balle libÃ©rÃ©e !';
    if (btnAdmin) { btnAdmin.textContent = 'âœ… Balle libÃ©rÃ©e !'; btnAdmin.disabled = false; }
  }, 1500);
}

function unlockAndStart() {
  socket.emit('unlock_servo');
  document.getElementById('startUnlock').style.display='none';
  toast('ğŸ”“ Balle dÃ©verrouillÃ©e â€” Bonne partie !', 'ok');
}

function skipUnlock() {
  document.getElementById('startUnlock').style.display='none';
  toast('Partie dÃ©marrÃ©e sans dÃ©verrouillage', 'inf');
}

fetch('/all_users').then(r=>r.json()).then(u=>{ allUsers=u; setupDrops(); });
checkAccess();
checkActiveGame();
setInterval(checkAccess, 60000);

function setupDrops() {
  ['t1p1','t1p2','t2p1','t2p2'].forEach(id=>{
    const inp = document.getElementById(id);
    const dd  = document.getElementById(`d-${id}`);
    if(!inp||!dd) return;
    function show(v) {
      const f = allUsers.filter(u=>!v||u.toLowerCase().includes(v.toLowerCase()));
      dd.innerHTML = f.map(u=>`<div class="dd-item" onmousedown="pick('${u}','${id}')">${u}</div>`).join('')||'<div class="dd-empty">Aucun rÃ©sultat</div>';
      dd.style.display='block';
    }
    inp.addEventListener('focus',()=>show(inp.value));
    inp.addEventListener('input',()=>show(inp.value));
    inp.addEventListener('blur', ()=>setTimeout(()=>dd.style.display='none',150));
  });
}
window.pick=(u,id)=>{ document.getElementById(id).value=u; document.getElementById(`d-${id}`).style.display='none'; };

socket.on('connect',()=>{ document.getElementById('cdot').className='conn-dot on'; document.getElementById('ctext').textContent='ConnectÃ©'; });
socket.on('disconnect',()=>{ document.getElementById('cdot').className='conn-dot off'; document.getElementById('ctext').textContent='DÃ©connectÃ©'; });

socket.on('game_started', d=>{
  document.getElementById('setup').style.display='none';
  document.getElementById('board').style.display='block';
  document.getElementById('n1').textContent=d.team1_players.join(' & ');
  document.getElementById('n2').textContent=d.team2_players.join(' & ');
  document.getElementById('s1').textContent='0';
  document.getElementById('s2').textContent='0';
  // Afficher boutons +1 But pour admin
  fetch('/api/is_admin').then(r=>r.json()).then(data=>{
    if(data.is_admin) document.getElementById('adminButBtns').style.display='flex';
  });
  // Proposer de dÃ©verrouiller la balle
  document.getElementById('startUnlock').style.display='flex';
});

socket.on('score_updated', d=>{
  const bump=(el,val)=>{
    if(parseInt(el.textContent)!==val){ el.textContent=val; el.classList.add('bump'); setTimeout(()=>el.classList.remove('bump'),250); }
  };
  bump(document.getElementById('s1'),d.team1_score);
  bump(document.getElementById('s2'),d.team2_score);
});

socket.on('game_ended', d=>{
  document.getElementById('s1').textContent=d.team1_score;
  document.getElementById('s2').textContent=d.team2_score;
  document.getElementById('wname').textContent=d.winner==='team1'?'ğŸ”µ Ã‰quipe 1 gagne !':'ğŸ”´ Ã‰quipe 2 gagne !';
  const btn = document.getElementById('unlockBtn');
  btn.disabled = false;
  btn.textContent = 'ğŸ”“ DÃ©verrouiller la balle';
  // RÃ©activer aussi le bouton admin
  const btnAdmin = document.getElementById('unlockBtnAdmin');
  if (btnAdmin) { btnAdmin.disabled = false; btnAdmin.textContent = 'ğŸ”“ DÃ©verrouiller la balle'; }
  document.getElementById('win').style.display='flex';
});

socket.on('error', d=>{
  console.error('SocketIO error:', d);
  toast(d.message||'Erreur','err');
  // Si partie dÃ©jÃ  en cours, proposer le reset
  if (d.message && d.message.includes('dÃ©jÃ  en cours')) {
    setTimeout(()=>toast('Utilisez â›” Forcer reset dans le panneau admin','err'), 500);
  }
});
socket.on('game_reset', ()=>newGame());
socket.on('game_abandoned', ()=>{
  toast('Partie abandonnÃ©e', 'err');
  newGame();
});

document.getElementById('startBtn').addEventListener('click',()=>{
  if (!hasAccess) { toast('AccÃ¨s non autorisÃ©', 'err'); return; }
  const t1p1 = document.getElementById('t1p1').value.trim();
  const t1p2 = document.getElementById('t1p2').value.trim();
  const t2p1 = document.getElementById('t2p1').value.trim();
  const t2p2 = document.getElementById('t2p2').value.trim();
  // Si champs vides, mettre des valeurs par dÃ©faut pour admin
  const team1 = [t1p1||'Ã‰quipe 1', t1p2].filter(Boolean);
  const team2 = [t2p1||'Ã‰quipe 2', t2p2].filter(Boolean);
  if(!t1p1 && !t2p1){
    toast('Remplissez au moins le joueur 1 de chaque Ã©quipe','err');
    return;
  }
  if(!team1.length||!team2.length){
    toast('Chaque Ã©quipe doit avoir au moins un joueur','err');
    return;
  }
  socket.emit('start_game',{team1,team2});
  const timeout = setTimeout(()=>{
    toast('Pas de rÃ©ponse du serveur â€” vÃ©rifiez la connexion','err');
  }, 3000);
  socket.once('game_started', ()=> clearTimeout(timeout));
  socket.once('error', ()=> clearTimeout(timeout));
});

document.getElementById('resetBtn').addEventListener('click',()=>socket.emit('reset_game'));

async function checkActiveGame() {
  // VÃ©rifie si une partie est dÃ©jÃ  en cours au chargement
  try {
    const res = await fetch('/api/game_status').then(r=>r.json());
    if (res.active) {
      // Partie en cours â€” afficher le scoreboard directement
      document.getElementById('setup').style.display='none';
      document.getElementById('board').style.display='block';
      document.getElementById('n1').textContent = res.team1_players.join(' & ');
      document.getElementById('n2').textContent = res.team2_players.join(' & ');
      document.getElementById('s1').textContent = res.team1_score;
      document.getElementById('s2').textContent = res.team2_score;
      toast('Partie en cours rÃ©cupÃ©rÃ©e !', 'inf');
    }
  } catch(e) { console.error(e); }
}

async function forceReset() {
  if (!confirm('Forcer la rÃ©initialisation de la partie en cours ?')) return;
  await fetch('/api/force_reset', {method: 'POST'});
  toast('Partie rÃ©initialisÃ©e !', 'inf');
  newGame();
}

function startGameAdmin() {
  // Fait dÃ©filer vers le setup pour remplir les Ã©quipes
  document.getElementById('setup').scrollIntoView({behavior: 'smooth'});
  document.getElementById('t1p1').focus();
  toast('Remplissez les Ã©quipes et dÃ©marrez !', 'inf');
}

function abandonGame() {
  if (!confirm('Abandonner la partie en cours ? Les scores ne seront pas enregistrÃ©s.')) return;
  socket.emit('abandon_game');
}

function newGame(){
  document.getElementById('win').style.display='none';
  document.getElementById('board').style.display='none';
  document.getElementById('setup').style.display='block';
  ['t1p1','t1p2','t2p1','t2p2'].forEach(id=>document.getElementById(id).value='');
  checkAccess();
}
</script>
</body>
</html>
