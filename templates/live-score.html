<!DOCTYPE html>

<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Partie Live â€” Baby-Foot Club</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='responsive-mobile.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='style-extended.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='live-score-styles.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='global-animations.css') }}">
  <script src="{{ url_for('static', filename='global-animations.js') }}" defer></script>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js" integrity="sha384-xNG8g/tf7FNN4BbPGujPb1vy3fNrEqZRk0nRwh+VhPYWqXfgdILdDPW2MYiRMgf7" crossorigin="anonymous"></script>
  <script src="{{ url_for('static', filename='animations.js') }}" defer></script>
  <script src="{{ url_for('static', filename='confetti.js') }}" defer></script>
</head>
<body style="font-family: 'DM Sans', sans-serif;">

<nav class="nav nav-glass">
  <div class="nav-inner">
    <a href="/dashboard" class="nav-brand">
      <div class="logo-wrapper">
        <img src="{{ url_for('static', filename='images/logo.svg') }}" alt="">
        <div class="logo-pulse"></div>
      </div>
      <span class="brand-text">Baby-Foot Club</span>
    </a>
    <div class="nav-sep"></div>
    <div class="nav-links">
      <a href="/dashboard" class="nav-link"><span class="nav-link-icon">ğŸ </span><span>Dashboard</span></a>
      <a href="/reservation" class="nav-link"><span class="nav-link-icon">ğŸ“…</span><span>RÃ©server</span></a>
      <a href="/live-score" class="nav-link active"><span class="nav-link-icon">ğŸ®</span><span>Partie Live</span></a>
      <a href="/stats" class="nav-link"><span class="nav-link-icon">ğŸ“Š</span><span>Stats</span></a>
      <a href="/top" class="nav-link"><span class="nav-link-icon">ğŸ†</span><span>Top 10</span></a>
    </div>
    <button class="burger" id="burger" onclick="toggleMenu()" aria-label="Menu">
      <span></span><span></span><span></span>
    </button>
    <div class="nav-right">
      <div class="user-profile-mini">
        <div class="nav-avatar" id="navAv">?</div>
        <span class="nav-username" id="navUsername"></span>
      </div>
      <button class="btn btn-ghost" style="margin-left:1rem" onclick="logout()">ğŸšª DÃ©connexion</button>
    </div>
  </div>
</nav>

<div class="mobile-menu" id="mobileMenu">
  <button class="mobile-menu-close" onclick="toggleMenu()">âœ•</button>
  <a href="/dashboard">ğŸ  Dashboard</a>
  <a href="/reservation">ğŸ“… RÃ©server</a>
  <a href="/live-score" class="active">ğŸ® Partie Live</a>
  <a href="/stats">ğŸ“Š Stats</a>
  <a href="/top">ğŸ† Top 10</a>
  <a href="#" onclick="logout()">ğŸšª DÃ©connexion</a>
</div>

<div class="page">
  <div class="container" style="max-width:900px">
    <div class="page-header fade-up">
      <h1>ğŸ® Partie Live</h1>
      <p id="pageSub">Suivez le match en direct</p>
    </div>

<!-- ADMIN : Configuration partie -->
<div id="setupArea" style="display:none" class="fade-up">
  <div class="card">
    <div class="card-header"><h3>âš™ï¸ Configuration de la partie</h3></div>
    <div class="card-body">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin-bottom:1.5rem">
        <div>
          <h4 style="color:var(--text-primary);margin-bottom:0.75rem">ğŸ”´ Ã‰quipe 1</h4>
          <select id="t1p1" class="input" style="width:100%;margin-bottom:0.5rem">
            <option value="">Joueur 1</option>
          </select>
          <select id="t1p2" class="input" style="width:100%">
            <option value="">Joueur 2 (optionnel)</option>
          </select>
        </div>
        <div>
          <h4 style="color:var(--text-primary);margin-bottom:0.75rem">ğŸ”µ Ã‰quipe 2</h4>
          <select id="t2p1" class="input" style="width:100%;margin-bottom:0.5rem">
            <option value="">Joueur 1</option>
          </select>
          <select id="t2p2" class="input" style="width:100%">
            <option value="">Joueur 2 (optionnel)</option>
          </select>
        </div>
      </div>
      <button id="btnStart" class="btn btn-primary btn-full btn-lg" onclick="startGame()">
        ğŸš€ Lancer la partie
      </button>
      <button id="btnUnlockServo" class="btn btn-secondary btn-full" style="margin-top:1rem;display:none" onclick="unlockServo()">
        ğŸ”“ DÃ©bloquer Servo (test)
      </button>
    </div>
  </div>
</div>

<!-- SPECTATEUR : Voir le match -->
<div id="spectatorArea" style="display:none" class="fade-up">
  <div class="card">
    <div class="card-header"><h3>ğŸ‘ï¸ Match en cours</h3></div>
    <div class="card-body">
      <div style="display:grid;grid-template-columns:1fr auto 1fr;gap:2rem;align-items:center;text-align:center;padding:1rem 0">
        <div>
          <div class="score-n" id="specScore1">0</div>
          <div style="font-weight:700;margin-top:0.5rem;color:var(--text-primary)">ğŸ”´ Ã‰quipe 1</div>
          <div id="specTeam1" style="font-size:0.875rem;color:var(--text-tertiary);margin-top:0.5rem"></div>
        </div>
        <div class="score-vs">VS</div>
        <div>
          <div class="score-n" id="specScore2">0</div>
          <div style="font-weight:700;margin-top:0.5rem;color:var(--text-primary)">ğŸ”µ Ã‰quipe 2</div>
          <div id="specTeam2" style="font-size:0.875rem;color:var(--text-tertiary);margin-top:0.5rem"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ADMIN/CRÃ‰ATEUR : ContrÃ´ler le match -->
<div id="gameArea" style="display:none" class="fade-up">
  <div class="card">
    <div class="card-header">
      <h3>âš½ Partie en cours</h3>
      <div id="gameStatus" style="font-size:0.875rem;color:var(--text-tertiary)"></div>
    </div>
    <div class="card-body">
      <div style="display:grid;grid-template-columns:1fr auto 1fr;gap:2rem;align-items:center;text-align:center;padding:1rem 0">
        <div>
          <div class="score-n" id="score1">0</div>
          <div style="font-weight:700;margin-top:0.5rem;color:var(--text-primary)">ğŸ”´ Ã‰quipe 1</div>
          <div id="team1Players" style="font-size:0.875rem;color:var(--text-tertiary);margin-top:0.5rem;margin-bottom:1rem"></div>
          <button class="score-btn" onclick="addPoint('team1')">+1 But</button>
        </div>
        <div class="score-vs">VS</div>
        <div>
          <div class="score-n" id="score2">0</div>
          <div style="font-weight:700;margin-top:0.5rem;color:var(--text-primary)">ğŸ”µ Ã‰quipe 2</div>
          <div id="team2Players" style="font-size:0.875rem;color:var(--text-tertiary);margin-top:0.5rem;margin-bottom:1rem"></div>
          <button class="score-btn" onclick="addPoint('team2')">+1 But</button>
        </div>
      </div>
      <div style="margin-top:2rem;display:flex;gap:1rem;justify-content:center;flex-wrap:wrap">
        <button class="btn" style="background:rgba(231,76,60,0.15);color:#e74c3c;border:1px solid rgba(231,76,60,0.3)" onclick="stopGame()">
          ğŸ›‘ ArrÃªter la partie
        </button>
      </div>
    </div>
  </div>
</div>

<!-- AUCUN MATCH -->
<div id="noGameArea" style="display:none" class="fade-up">
  <div class="card">
    <div class="card-body" style="text-align:center;padding:3rem 1rem">
      <div style="font-size:4rem;margin-bottom:1rem;opacity:0.3">âš½</div>
      <h2 style="color:var(--text-primary);margin-bottom:0.5rem">Aucun match en cours</h2>
      <p style="color:var(--text-tertiary);margin-bottom:2rem">Il n'y a pas de partie active pour le moment</p>
      <a href="/dashboard" class="btn btn-primary">â† Retour au Dashboard</a>
    </div>
  </div>
</div>

<!-- POPUP REMATCH -->
<div id="rematchPopup" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:9999;align-items:center;justify-content:center;backdrop-filter:blur(8px)">
  <div style="background:var(--bg-elevated);padding:2.5rem;border-radius:20px;max-width:420px;width:90%;text-align:center;border:1px solid var(--border-accent)">
    <div style="font-size:3rem;margin-bottom:1rem">ğŸ”„</div>
    <h2 style="color:var(--text-primary);margin-bottom:0.5rem">Rejouer ?</h2>
    <p style="color:var(--text-tertiary);margin:1rem 0 1.5rem">MÃªmes Ã©quipes, nouvelle partie ?</p>
    <div style="display:flex;gap:1rem">
      <button class="btn btn-primary" style="flex:1" onclick="voteRematch('yes')">âœ… OUI</button>
      <button class="btn" style="flex:1;background:rgba(231,76,60,0.15);color:#e74c3c;border:1px solid rgba(231,76,60,0.3)" onclick="voteRematch('no')">âŒ NON</button>
    </div>
  </div>
</div>

<!-- WINNER OVERLAY -->
<div id="winnerOverlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.92);z-index:9998;align-items:center;justify-content:center;backdrop-filter:blur(12px)">
  <div class="winner-box">
    <div class="winner-emoji">ğŸ†</div>
    <div class="winner-ttl" id="winnerTitle">Victoire !</div>
    <div class="winner-sub" id="winnerSub"></div>
  </div>
</div>

  </div>
</div>

<script>
let socket;
try {
  console.log('ğŸ”Œ [Live-Score] Tentative connexion Socket.IO...');
  socket = io();
  socket.on('connect', () => { console.log('âœ… [Live-Score] Socket connectÃ©'); });
  socket.on('connect_error', (err) => { console.error('âŒ [Live-Score] Erreur:', err); });
} catch(e) {
  console.error('âŒ [Live-Score] Socket.IO impossible:', e);
  alert('âš ï¸ Connexion temps rÃ©el impossible. Rechargez la page.');
  socket = { 
    emit: (event) => { console.warn(`âŒ Socket factice: emit(${event}) ignorÃ©`); },
    on: () => {},
    connected: false
  };
}
let currentUser = null;
let isAdmin = false;
let canControl = false;
let lastGame = null;

function toggleMenu() {
  document.getElementById('burger').classList.toggle('open');
  document.getElementById('mobileMenu').classList.toggle('open');
  document.body.style.overflow = document.getElementById('mobileMenu').classList.contains('open') ? 'hidden' : '';
}

function logout() {
  fetch('/api/logout', {method:'POST'}).then(() => location.href = '/');
}

function showArea(name) {
  ['setupArea','spectatorArea','gameArea','noGameArea'].forEach(id => {
    document.getElementById(id).style.display = 'none';
  });
  if (name) document.getElementById(name).style.display = 'block';
}

function parsePlayers(players) {
  if (!players) return [];
  if (Array.isArray(players)) return players;
  try { return JSON.parse(players); } catch { return [players]; }
}

async function loadUsers() {
  try {
    const users = await fetch('/users_list').then(r => r.json());
    ['t1p1','t1p2','t2p1','t2p2'].forEach(id => {
      const sel = document.getElementById(id);
      users.forEach(u => {
        const opt = document.createElement('option');
        opt.value = u; opt.textContent = u;
        sel.appendChild(opt);
      });
    });
  } catch(e) { console.error('Erreur chargement users:', e); }
}

async function checkActiveGame() {
  try {
    const res = await fetch('/api/has_active_game');
    const data = await res.json();

    const userIsAdmin = data.is_admin || isAdmin;
    const userHasReservation = data.has_reservation;
    const canSetup = userIsAdmin || userHasReservation;

    if (data.has_active_game) {
      const game = data.game_data;
      const t1 = parsePlayers(game.team1_players);
      const t2 = parsePlayers(game.team2_players);
      canControl = userIsAdmin || game.started_by === currentUser;

      if (canControl) {
        showArea('gameArea');
        updateGameUI({...game, team1_players: t1, team2_players: t2});
      } else {
        showArea('spectatorArea');
        updateSpectatorUI({...game, team1_players: t1, team2_players: t2});
      }
    } else {
      if (canSetup) {
        showArea('setupArea');
        document.getElementById('pageSub').textContent = 'Configurer une nouvelle partie';
        loadUsers();
      } else {
        showArea('noGameArea');
      }
    }
  } catch(e) {
    console.error('Erreur checkActiveGame:', e);
    showArea('noGameArea');
  }
}

function updateGameUI(game) {
  document.getElementById('score1').textContent = game.team1_score;
  document.getElementById('score2').textContent = game.team2_score;
  document.getElementById('team1Players').textContent = game.team1_players.join(', ');
  document.getElementById('team2Players').textContent = game.team2_players.join(', ');

  // Effet bump sur les scores
  ['score1','score2'].forEach(id => {
    const el = document.getElementById(id);
    el.classList.remove('bump');
    void el.offsetWidth;
    el.classList.add('bump');
  });
}

function updateSpectatorUI(game) {
  document.getElementById('specScore1').textContent = game.team1_score;
  document.getElementById('specScore2').textContent = game.team2_score;
  document.getElementById('specTeam1').textContent = game.team1_players.join(', ');
  document.getElementById('specTeam2').textContent = game.team2_players.join(', ');
}

function startGame() {
  const t1 = [
    document.getElementById('t1p1').value,
    document.getElementById('t1p2').value
  ].filter(Boolean);
  const t2 = [
    document.getElementById('t2p1').value,
    document.getElementById('t2p2').value
  ].filter(Boolean);

  if (t1.length === 0 || t2.length === 0) {
    alert('Il faut au moins 1 joueur par Ã©quipe');
    return;
  }

  // VÃ©rifier doublons
  const all = [...t1, ...t2];
  if (new Set(all).size !== all.length) {
    alert('Un joueur ne peut pas Ãªtre dans les deux Ã©quipes');
    return;
  }

  socket.emit('start_game', {team1: t1, team2: t2});
}

function addPoint(team) {
  socket.emit('update_score', {team});
}

function stopGame() {
  if (confirm('ArrÃªter la partie en cours ?')) {
    socket.emit('stop_game');
  }
}

// Corriger : utilise unlock_servo1 et unlock_servo2
function unlockServo() {
  socket.emit('unlock_servo1');
  setTimeout(() => socket.emit('unlock_servo2'), 100);
}

function voteRematch(vote) {
  socket.emit('vote_rematch', {vote});
  document.getElementById('rematchPopup').style.display = 'none';
}

function showWinner(game) {
  const t1 = parsePlayers(game.team1_players);
  const t2 = parsePlayers(game.team2_players);
  const winnerPlayers = game.winner === 'team1' ? t1 : t2;
  const winnerScore = game.winner === 'team1' ? game.team1_score : game.team2_score;
  const loserScore = game.winner === 'team1' ? game.team2_score : game.team1_score;

  document.getElementById('winnerTitle').textContent = `ğŸ† ${winnerPlayers.join(' & ')} gagnent !`;
  document.getElementById('winnerSub').textContent = `Score final : ${winnerScore} - ${loserScore}`;
  document.getElementById('winnerOverlay').style.display = 'flex';
  
  // Lancer les confettis de victoire
  if (typeof launchConfetti === 'function') {
    launchConfetti(4000, 150);
  }

  setTimeout(() => {
    document.getElementById('winnerOverlay').style.display = 'none';
  }, 4000);
}

// â”€â”€ Socket events â”€â”€
socket.on('game_started', () => {
  checkActiveGame();
});

socket.on('score_updated', (game) => {
  const t1 = parsePlayers(game.team1_players);
  const t2 = parsePlayers(game.team2_players);
  const parsed = {...game, team1_players: t1, team2_players: t2};
  if (canControl) updateGameUI(parsed);
  else updateSpectatorUI(parsed);
});

socket.on('game_ended', (game) => {
  const t1 = parsePlayers(game.team1_players);
  const t2 = parsePlayers(game.team2_players);
  const parsed = {...game, team1_players: t1, team2_players: t2};
  lastGame = parsed;
  if (canControl) updateGameUI(parsed);
  else updateSpectatorUI(parsed);
  showWinner(parsed);
});

socket.on('game_stopped', () => {
  location.href = '/dashboard';
});

socket.on('game_reset', () => {
  checkActiveGame();
});

socket.on('rematch_prompt', () => {
  document.getElementById('winnerOverlay').style.display = 'none';
  const t1 = parsePlayers(lastGame ? lastGame.team1_players : []);
  const t2 = parsePlayers(lastGame ? lastGame.team2_players : []);
  const isInGame = t1.includes(currentUser) || t2.includes(currentUser) || canControl || isAdmin;
  if (isInGame) {
    document.getElementById('rematchPopup').style.display = 'flex';
  }
});

socket.on('rematch_cancelled', () => {
  setTimeout(() => location.href = '/dashboard', 500);
});

socket.on('servo1_unlock', () => {
  const btn = document.getElementById('btnUnlockServo');
  if (btn) { btn.textContent = 'ğŸ”“ Servo dÃ©verrouillÃ© (5s)'; btn.style.opacity = '0.6'; }
});
socket.on('servo1_lock', () => {
  const btn = document.getElementById('btnUnlockServo');
  if (btn) { btn.textContent = 'ğŸ”“ DÃ©bloquer Servo (test)'; btn.style.opacity = '1'; }
});
socket.on('servo2_unlock', () => {});
socket.on('servo2_lock', () => {});

socket.on('error', (data) => {
  alert('Erreur : ' + data.message);
});

// â”€â”€ Init â”€â”€
async function init() {
  try {
    const res = await fetch('/current_user');
    if (!res.ok) { location.href = '/login'; return; }
    const user = await res.json();
    if (!user) { location.href = '/login'; return; }

    currentUser = user.username;
    isAdmin = user.is_admin;

    document.getElementById('navUsername').textContent = user.username;
    document.getElementById('navAv').textContent = user.username[0].toUpperCase();

    if (isAdmin) {
      const servoBtn = document.getElementById('btnUnlockServo');
      if (servoBtn) servoBtn.style.display = 'block';
    }

    await checkActiveGame();
  } catch(e) {
    console.error('Erreur init:', e);
  }
}

init();
</script>

</body>
</html>