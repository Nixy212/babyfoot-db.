<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Partie Live â€” Baby-Foot Club</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='responsive-mobile.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='style-extended.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='global-animations.css') }}">
  <script src="{{ url_for('static', filename='global-animations.js') }}" defer></script>
</head>
<body style="font-family: 'DM Sans', sans-serif;">
<nav class="nav nav-glass">
  <div class="nav-inner">
    <a href="/dashboard" class="nav-brand">
      <div class="logo-wrapper">
        <img src="{{ url_for('static', filename='images/logo.svg') }}" alt="">
        <div class="logo-pulse"></div>
      </div>
      <span class="brand-text">Baby-Foot Club</span>
    </a>
    <div class="nav-sep"></div>
    <div class="nav-links">
      <a href="/dashboard" class="nav-link"><span class="nav-link-icon">ğŸ </span><span>Dashboard</span></a>
      <a href="/reservation" class="nav-link"><span class="nav-link-icon">ğŸ“…</span><span>RÃ©server</span></a>
      <a href="/live-score" class="nav-link active"><span class="nav-link-icon">ğŸ®</span><span>Partie Live</span></a>
      <a href="/stats" class="nav-link"><span class="nav-link-icon">ğŸ“Š</span><span>Stats</span></a>
      <a href="/top" class="nav-link"><span class="nav-link-icon">ğŸ†</span><span>Top 10</span></a>
    </div>
    <button class="burger" id="burger" onclick="toggleMenu()" aria-label="Menu">
      <span></span><span></span><span></span>
    </button>
    <div class="nav-right">
      <div class="user-profile-mini">
        <div class="nav-avatar" id="navAv">?</div>
        <span class="nav-username" id="navUsername"></span>
      </div>
    </div>
  </div>
</nav>

<div class="mobile-menu" id="mobileMenu">
  <button class="mobile-menu-close" onclick="toggleMenu()">âœ•</button>
  <a href="/dashboard">ğŸ  Dashboard</a>
  <a href="/reservation">ğŸ“… RÃ©server</a>
  <a href="/live-score">ğŸ® Partie Live</a>
  <a href="/stats">ğŸ“Š Stats</a>
  <a href="/top">ğŸ† Top 10</a>
  <a href="#" onclick="fetch(`/api/logout`,{method:`POST`}).then(()=>location.href=`/`)">ğŸšª DÃ©connexion</a>
</div>

<script>
function toggleMenu() {
  document.getElementById("burger").classList.toggle("open");
  document.getElementById("mobileMenu").classList.toggle("open");
  document.body.style.overflow = document.getElementById("mobileMenu").classList.contains("open") ? "hidden" : "";
}
</script>

<div class="page">
  <div class="container" style="max-width:1000px">
    <div class="page-header fade-up">
      <h1>ğŸ® Partie en direct</h1>
      <p>Scores en temps rÃ©el via WebSocket</p>
    </div>

    <!-- Formulaire de dÃ©marrage -->
    <div id="startForm" class="card fade-up" style="animation-delay:.05s;margin-bottom:1.5rem">
      <div class="card-header"><h3>Composer les Ã©quipes</h3></div>
      <div class="card-body">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin-bottom:1.5rem">
          <div>
            <label class="label">ğŸ”´ Ã‰quipe 1</label>
            <select id="t1p1" class="input" style="margin-bottom:0.5rem">
              <option value="">Joueur 1</option>
            </select>
            <select id="t1p2" class="input">
              <option value="">Joueur 2 (optionnel)</option>
            </select>
          </div>
          <div>
            <label class="label">ğŸ”µ Ã‰quipe 2</label>
            <select id="t2p1" class="input" style="margin-bottom:0.5rem">
              <option value="">Joueur 1</option>
            </select>
            <select id="t2p2" class="input">
              <option value="">Joueur 2 (optionnel)</option>
            </select>
          </div>
        </div>
        <button id="btnStart" class="btn btn-primary btn-full btn-lg">Lancer la partie</button>
      </div>
    </div>

    <!-- Partie en cours -->
    <div id="gameArea" style="display:none">
      <div class="card fade-up" style="margin-bottom:1.5rem">
        <div class="card-body" style="text-align:center;padding:3rem 1rem">
          <div style="display:grid;grid-template-columns:1fr auto 1fr;gap:2rem;align-items:center;max-width:600px;margin:0 auto">
            <div>
              <div style="font-size:0.875rem;color:var(--text-secondary);margin-bottom:0.5rem">ğŸ”´ Ã‰quipe 1</div>
              <div id="team1Names" style="font-weight:600;margin-bottom:1rem;color:var(--text-primary)">â€”</div>
              <div id="score1" style="font-size:4rem;font-weight:700;color:var(--bronze);font-family:'Space Mono',monospace">0</div>
              <button id="btnScore1" class="btn btn-primary" style="margin-top:1rem">+1 Point</button>
            </div>
            <div style="font-size:2rem;color:var(--text-tertiary)">vs</div>
            <div>
              <div style="font-size:0.875rem;color:var(--text-secondary);margin-bottom:0.5rem">ğŸ”µ Ã‰quipe 2</div>
              <div id="team2Names" style="font-weight:600;margin-bottom:1rem;color:var(--text-primary)">â€”</div>
              <div id="score2" style="font-size:4rem;font-weight:700;color:var(--bronze);font-family:'Space Mono',monospace">0</div>
              <button id="btnScore2" class="btn btn-primary" style="margin-top:1rem">+1 Point</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card fade-up">
        <div class="card-body" style="text-align:center">
          <button id="btnReset" class="btn btn-secondary">RÃ©initialiser la partie</button>
        </div>
      </div>
    </div>

    <!-- Partie terminÃ©e -->
    <div id="endArea" style="display:none">
      <div class="card fade-up">
        <div class="card-body" style="text-align:center;padding:3rem 1rem">
          <div style="font-size:3rem;margin-bottom:1rem">ğŸ†</div>
          <h2 id="winnerText" style="margin-bottom:1rem">â€”</h2>
          <div id="finalScores" style="font-size:1.25rem;margin-bottom:2rem;color:var(--text-secondary)">â€”</div>
          <button id="btnNewGame" class="btn btn-primary btn-lg">Nouvelle partie</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="toast-wrap" id="tw"></div>

<script>
const socket = io();
let allUsers = [];
let currentUser = null;

function toast(msg, type='inf') {
  const c=document.getElementById('tw'), t=document.createElement('div');
  t.className=`toast ${type}`; t.textContent=msg; c.appendChild(t);
  setTimeout(()=>t.remove(), 3200);
}

socket.on('error', d => toast(d.message, 'err'));

socket.on('game_started', game => {
  document.getElementById('startForm').style.display = 'none';
  document.getElementById('gameArea').style.display = 'block';
  document.getElementById('endArea').style.display = 'none';
  document.getElementById('team1Names').textContent = game.team1_players.join(' + ');
  document.getElementById('team2Names').textContent = game.team2_players.join(' + ');
  document.getElementById('score1').textContent = game.team1_score;
  document.getElementById('score2').textContent = game.team2_score;
  toast('Partie lancÃ©e !', 'ok');
});

socket.on('score_updated', game => {
  document.getElementById('score1').textContent = game.team1_score;
  document.getElementById('score2').textContent = game.team2_score;
});

socket.on('game_ended', game => {
  document.getElementById('gameArea').style.display = 'none';
  document.getElementById('endArea').style.display = 'block';
  const winner = game.winner === 'team1' ? game.team1_players : game.team2_players;
  document.getElementById('winnerText').textContent = `${winner.join(' + ')} remporte la partie !`;
  document.getElementById('finalScores').textContent = `Score final : ${game.team1_score} - ${game.team2_score}`;
  toast('Partie terminÃ©e !', 'ok');
});

socket.on('game_reset', () => {
  document.getElementById('startForm').style.display = 'block';
  document.getElementById('gameArea').style.display = 'none';
  document.getElementById('endArea').style.display = 'none';
  ['t1p1','t1p2','t2p1','t2p2'].forEach(id => document.getElementById(id).value = '');
  toast('Partie rÃ©initialisÃ©e', 'inf');
});

document.getElementById('btnStart').addEventListener('click', () => {
  const t1p1 = document.getElementById('t1p1').value;
  const t1p2 = document.getElementById('t1p2').value;
  const t2p1 = document.getElementById('t2p1').value;
  const t2p2 = document.getElementById('t2p2').value;
  const team1 = [t1p1, t1p2].filter(p => p);
  const team2 = [t2p1, t2p2].filter(p => p);
  if (team1.length === 0 || team2.length === 0) {
    toast('Chaque Ã©quipe doit avoir au moins un joueur', 'err');
    return;
  }
  socket.emit('start_game', {team1, team2});
});

document.getElementById('btnScore1').addEventListener('click', () => {
  socket.emit('update_score', {team: 'team1'});
});

document.getElementById('btnScore2').addEventListener('click', () => {
  socket.emit('update_score', {team: 'team2'});
});

document.getElementById('btnReset').addEventListener('click', () => {
  if (confirm('RÃ©initialiser la partie en cours ?')) {
    socket.emit('reset_game');
  }
});

document.getElementById('btnNewGame').addEventListener('click', () => {
  socket.emit('reset_game');
});

async function init() {
  const [ud, users] = await Promise.all([
    fetch('/current_user').then(r=>r.json()),
    fetch('/users_list').then(r=>r.json())
  ]);
  
  currentUser = ud;
  allUsers = users;
  
  if (currentUser.username) {
    document.getElementById('navAv').textContent = currentUser.username[0].toUpperCase();
    document.getElementById('navUsername').textContent = currentUser.username;
  }
  
  ['t1p1','t1p2','t2p1','t2p2'].forEach(id => {
    const sel = document.getElementById(id);
    allUsers.forEach(u => {
      const opt = document.createElement('option');
      opt.value = u;
      opt.textContent = u;
      sel.appendChild(opt);
    });
  });
}

init();
</script>
</body>
</html>
