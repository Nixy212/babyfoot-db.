<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Partie Live â€” Baby-Foot Club</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='responsive-mobile.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='style-extended.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='global-animations.css') }}">
  <script src="{{ url_for('static', filename='global-animations.js') }}" defer></script>
  <style>
    .popup-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }
    .popup-overlay.show {
      display: flex;
    }
    .popup-content {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      max-width: 400px;
      width: 90%;
      text-align: center;
    }
    .popup-content h2 {
      margin-top: 0;
    }
    .popup-buttons {
      display: flex;
      gap: 1rem;
      margin-top: 1.5rem;
    }
    .popup-buttons button {
      flex: 1;
    }
    .btn-danger {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }
    .btn-success {
      background: #27ae60;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }
    #admin-controls {
      margin-top: 1rem;
      padding: 1rem;
      background: #fff3cd;
      border-radius: 8px;
      display: none;
    }
    #servo-unlock-btn {
      margin-top: 1rem;
      background: #f39c12;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      display: none;
    }
  </style>
</head>
<body style="font-family: 'DM Sans', sans-serif;">
<nav class="nav nav-glass">
  <div class="nav-inner">
    <a href="/dashboard" class="nav-brand">
      <div class="logo-wrapper">
        <img src="{{ url_for('static', filename='images/logo.svg') }}" alt="">
        <div class="logo-pulse"></div>
      </div>
      <span class="brand-text">Baby-Foot Club</span>
    </a>
    <div class="nav-sep"></div>
    <div class="nav-links">
      <a href="/dashboard" class="nav-link"><span class="nav-link-icon">ğŸ </span><span>Dashboard</span></a>
      <a href="/reservation" class="nav-link"><span class="nav-link-icon">ğŸ“…</span><span>RÃ©server</span></a>
      <a href="/live-score" class="nav-link active"><span class="nav-link-icon">ğŸ®</span><span>Partie Live</span></a>
      <a href="/stats" class="nav-link"><span class="nav-link-icon">ğŸ“Š</span><span>Stats</span></a>
      <a href="/top" class="nav-link"><span class="nav-link-icon">ğŸ†</span><span>Top 10</span></a>
    </div>
    <button class="burger" id="burger" onclick="toggleMenu()" aria-label="Menu">
      <span></span><span></span><span></span>
    </button>
    <div class="nav-right">
      <div class="user-profile-mini">
        <div class="nav-avatar" id="navAv">?</div>
        <span class="nav-username" id="navUsername"></span>
      </div>
    </div>
  </div>
</nav>

<div class="mobile-menu" id="mobileMenu">
  <button class="mobile-menu-close" onclick="toggleMenu()">âœ•</button>
  <a href="/dashboard">ğŸ  Dashboard</a>
  <a href="/reservation">ğŸ“… RÃ©server</a>
  <a href="/live-score">ğŸ® Partie Live</a>
  <a href="/stats">ğŸ“Š Stats</a>
  <a href="/top">ğŸ† Top 10</a>
  <a href="#" onclick="fetch('/api/logout',{method:'POST'}).then(()=>location.href='/')">ğŸšª DÃ©connexion</a>
</div>

<script>
function toggleMenu() {
  document.getElementById("burger").classList.toggle("open");
  document.getElementById("mobileMenu").classList.toggle("open");
  document.body.style.overflow = document.getElementById("mobileMenu").classList.contains("open") ? "hidden" : "";
}
</script>

<div class="page">
  <div class="container" style="max-width:1000px">
    <div class="page-header fade-up">
      <h1>ğŸ® Partie en direct</h1>
      <p>Scores en temps rÃ©el via WebSocket</p>
    </div>

    <div id="startForm" class="card fade-up" style="animation-delay:.05s;margin-bottom:1.5rem">
      <div class="card-header"><h3>Composer les Ã©quipes</h3></div>
      <div class="card-body">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin-bottom:1.5rem">
          <div>
            <label class="label">ğŸ”´ Ã‰quipe 1</label>
            <select id="t1p1" class="input" style="margin-bottom:0.5rem">
              <option value="">Joueur 1</option>
            </select>
            <select id="t1p2" class="input">
              <option value="">Joueur 2 (optionnel)</option>
            </select>
          </div>
          <div>
            <label class="label">ğŸ”µ Ã‰quipe 2</label>
            <select id="t2p1" class="input" style="margin-bottom:0.5rem">
              <option value="">Joueur 1</option>
            </select>
            <select id="t2p2" class="input">
              <option value="">Joueur 2 (optionnel)</option>
            </select>
          </div>
        </div>
        <button id="btnStart" class="btn btn-primary btn-full btn-lg">Lancer la partie</button>
        
        <button id="servo-unlock-btn" onclick="unlockServo()">ğŸ”“ DÃ©bloquer Servo</button>
      </div>
    </div>

    <div id="gameArea" style="display:none">
      <div class="card fade-up" style="margin-bottom:1.5rem">
        <div class="card-header"><h3>Partie en cours</h3></div>
        <div class="card-body">
          <div style="display:grid;grid-template-columns:1fr auto 1fr;gap:2rem;align-items:center;text-align:center">
            <div>
              <div style="font-size:4rem;font-weight:700;color:#e74c3c" id="score1">0</div>
              <div style="font-weight:600;margin-top:0.5rem">ğŸ”´ Ã‰quipe 1</div>
              <div id="team1Players" style="font-size:0.9rem;color:#666;margin-top:0.5rem"></div>
              <button class="btn btn-primary" style="margin-top:1rem" onclick="addPoint('team1')">+1 Point</button>
            </div>
            <div style="font-size:2rem;color:#95a5a6">VS</div>
            <div>
              <div style="font-size:4rem;font-weight:700;color:#3498db" id="score2">0</div>
              <div style="font-weight:600;margin-top:0.5rem">ğŸ”µ Ã‰quipe 2</div>
              <div id="team2Players" style="font-size:0.9rem;color:#666;margin-top:0.5rem"></div>
              <button class="btn btn-primary" style="margin-top:1rem" onclick="addPoint('team2')">+1 Point</button>
            </div>
          </div>

          <div id="admin-controls">
            <button class="btn-danger btn-full" onclick="stopGame()">ğŸ›‘ ARRÃŠTER LA PARTIE (ADMIN)</button>
          </div>
        </div>
      </div>
    </div>

    <div id="winnerArea" style="display:none">
      <div class="card fade-up">
        <div class="card-header"><h3>ğŸ† Partie terminÃ©e !</h3></div>
        <div class="card-body" style="text-align:center">
          <div style="font-size:3rem;margin:2rem 0" id="winnerText"></div>
          <div style="font-size:2rem;color:#666;margin-bottom:2rem" id="finalScore"></div>
          <button class="btn btn-primary btn-lg" onclick="location.href='/dashboard'">Retour au Dashboard</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="rematchPopup" class="popup-overlay">
  <div class="popup-content">
    <h2>ğŸ”„ Rejouer ?</h2>
    <p>Voulez-vous refaire une partie avec les mÃªmes Ã©quipes ?</p>
    <div class="popup-buttons">
      <button class="btn-success" onclick="voteRematch('yes')">âœ… OUI</button>
      <button class="btn-danger" onclick="voteRematch('no')">âŒ NON</button>
    </div>
  </div>
</div>

<script>
const socket = io();
let currentGame = null;
let currentUsername = null;
let isAdmin = false;
let canUnlockServo = false;

async function loadCurrentUser() {
  try {
    const res = await fetch('/current_user');
    if (res.ok) {
      const user = await res.json();
      currentUsername = user.username;
      isAdmin = user.is_admin;
      canUnlockServo = user.is_admin || user.has_reservation;
      
      document.getElementById('navUsername').textContent = user.username;
      document.getElementById('navAv').textContent = user.username[0].toUpperCase();
      
      if (canUnlockServo) {
        document.getElementById('servo-unlock-btn').style.display = 'block';
      }
      
      if (isAdmin) {
        document.getElementById('admin-controls').style.display = 'block';
      }
    }
  } catch (e) {
    console.error('Erreur chargement user:', e);
  }
}

async function loadUsers() {
  try {
    const res = await fetch('/users_list');
    const users = await res.json();
    
    const selects = [
      document.getElementById('t1p1'),
      document.getElementById('t1p2'),
      document.getElementById('t2p1'),
      document.getElementById('t2p2')
    ];
    
    selects.forEach(select => {
      users.forEach(u => {
        const opt = document.createElement('option');
        opt.value = u;
        opt.textContent = u;
        select.appendChild(opt);
      });
    });
  } catch (e) {
    console.error('Erreur chargement users:', e);
  }
}

async function checkActiveGame() {
  try {
    const res = await fetch('/api/has_active_game');
    const data = await res.json();
    
    if (data.has_active_game && data.game_data) {
      console.log('ğŸ“¥ Partie rÃ©cupÃ©rÃ©e');
      currentGame = data.game_data;
      showGame();
      updateScores();
    }
  } catch (e) {
    console.error('Erreur rÃ©cupÃ©ration partie:', e);
  }
}

function startGame() {
  const team1 = [
    document.getElementById('t1p1').value,
    document.getElementById('t1p2').value
  ].filter(p => p);
  
  const team2 = [
    document.getElementById('t2p1').value,
    document.getElementById('t2p2').value
  ].filter(p => p);
  
  if (team1.length === 0 || team2.length === 0) {
    alert('Chaque Ã©quipe doit avoir au moins un joueur');
    return;
  }
  
  socket.emit('start_game', { team1, team2 });
}

function addPoint(team) {
  socket.emit('update_score', { team });
}

function showGame() {
  document.getElementById('startForm').style.display = 'none';
  document.getElementById('gameArea').style.display = 'block';
  document.getElementById('winnerArea').style.display = 'none';
  
  if (currentGame) {
    document.getElementById('team1Players').textContent = currentGame.team1_players.join(', ');
    document.getElementById('team2Players').textContent = currentGame.team2_players.join(', ');
  }
}

function updateScores() {
  if (!currentGame) return;
  document.getElementById('score1').textContent = currentGame.team1_score;
  document.getElementById('score2').textContent = currentGame.team2_score;
}

function showWinner() {
  document.getElementById('startForm').style.display = 'none';
  document.getElementById('gameArea').style.display = 'none';
  document.getElementById('winnerArea').style.display = 'block';
  
  const winner = currentGame.winner === 'team1' ? 'Ã‰quipe 1' : 'Ã‰quipe 2';
  document.getElementById('winnerText').textContent = `${winner} a gagnÃ© !`;
  document.getElementById('finalScore').textContent = `${currentGame.team1_score} - ${currentGame.team2_score}`;
}

function unlockServo() {
  socket.emit('unlock_servo');
  alert('âœ… Servo dÃ©verrouillÃ© !');
}

function stopGame() {
  if (confirm('âš ï¸ ÃŠtes-vous sÃ»r de vouloir arrÃªter cette partie ?')) {
    socket.emit('stop_game');
  }
}

function voteRematch(vote) {
  socket.emit('vote_rematch', { vote });
  document.getElementById('rematchPopup').classList.remove('show');
}

socket.on('game_started', (game) => {
  console.log('ğŸ® Partie dÃ©marrÃ©e');
  currentGame = game;
  showGame();
  updateScores();
});

socket.on('game_recovery', (game) => {
  console.log('ğŸ“¥ Partie rÃ©cupÃ©rÃ©e via Socket');
  currentGame = game;
  showGame();
  updateScores();
});

socket.on('score_updated', (game) => {
  console.log('ğŸ“Š Score mis Ã  jour');
  currentGame = game;
  updateScores();
});

socket.on('game_ended', (game) => {
  console.log('ğŸ Partie terminÃ©e');
  currentGame = game;
  updateScores();
  showWinner();
});

socket.on('game_stopped', () => {
  location.href = '/dashboard';
});

socket.on('rematch_prompt', () => {
  document.getElementById('rematchPopup').classList.add('show');
});

socket.on('rematch_cancelled', () => {
  location.href = '/dashboard';
});

socket.on('error', (data) => {
  console.error('Erreur:', data.message);
});

document.getElementById('btnStart').addEventListener('click', startGame);

loadCurrentUser();
loadUsers();
checkActiveGame();
</script>
</body>
</html>
