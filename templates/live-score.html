<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Partie Live â€” Baby-Foot Club</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='responsive-mobile.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>
<nav class="nav nav-glass">
  <div class="nav-inner">
    <a href="/dashboard" class="nav-brand">
      <div class="logo-wrapper">
        <img src="{{ url_for('static', filename='images/logo.svg') }}" alt="">
      </div>
      <span class="brand-text">Baby-Foot Club</span>
    </a>
    <div class="nav-sep"></div>
    <div class="nav-links">
      <a href="/dashboard" class="nav-link"><span>ğŸ </span><span>Dashboard</span></a>
      <a href="/reservation" class="nav-link"><span>ğŸ“…</span><span>RÃ©server</span></a>
      <a href="/live-score" class="nav-link active"><span>ğŸ®</span><span>Partie Live</span></a>
      <a href="/stats" class="nav-link"><span>ğŸ“Š</span><span>Stats</span></a>
      <a href="/top" class="nav-link"><span>ğŸ†</span><span>Top 10</span></a>
    </div>
    <button class="burger" id="burger" onclick="toggleMenu()">
      <span></span><span></span><span></span>
    </button>
    <div class="nav-right">
      <div class="user-profile-mini">
        <div class="nav-avatar" id="navAv">?</div>
        <span class="nav-username" id="navUsername"></span>
      </div>
      <button class="btn btn-ghost" onclick="logout()">ğŸšª</button>
    </div>
  </div>
</nav>

<div class="mobile-menu" id="mobileMenu">
  <button class="mobile-menu-close" onclick="toggleMenu()">âœ•</button>
  <a href="/dashboard">ğŸ  Dashboard</a>
  <a href="/reservation">ğŸ“… RÃ©server</a>
  <a href="/live-score">ğŸ® Partie Live</a>
  <a href="/stats">ğŸ“Š Stats</a>
  <a href="/top">ğŸ† Top 10</a>
  <a href="#" onclick="logout()">ğŸšª DÃ©connexion</a>
</div>

<div class="page">
  <div class="container" style="max-width:900px">
    <div class="page-header">
      <h1>ğŸ® Partie Live</h1>
      <p id="pageSub">Suivez le match en direct</p>
    </div>

    <!-- ADMIN/CRÃ‰ATEUR: Configuration partie -->
    <div id="setupArea" style="display:none">
      <div class="card">
        <div class="card-header"><h3>Configuration</h3></div>
        <div class="card-body">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin-bottom:1.5rem">
            <div>
              <h4>ğŸ”´ Ã‰quipe 1</h4>
              <select id="t1p1" class="input"><option value="">Joueur 1</option></select>
              <select id="t1p2" class="input"><option value="">Joueur 2 (optionnel)</option></select>
            </div>
            <div>
              <h4>ğŸ”µ Ã‰quipe 2</h4>
              <select id="t2p1" class="input"><option value="">Joueur 1</option></select>
              <select id="t2p2" class="input"><option value="">Joueur 2 (optionnel)</option></select>
            </div>
          </div>
          <button id="btnStart" class="btn btn-primary btn-full btn-lg">Lancer la partie</button>
          <button class="btn btn-secondary btn-full" style="margin-top:1rem" onclick="unlockServo()">ğŸ”“ DÃ©bloquer Servo</button>
        </div>
      </div>
    </div>

    <!-- SPECTATEUR: Voir le match -->
    <div id="spectatorArea" style="display:none">
      <div class="card">
        <div class="card-header"><h3>ğŸ‘ï¸ Match en cours</h3></div>
        <div class="card-body">
          <div style="display:grid;grid-template-columns:1fr auto 1fr;gap:2rem;align-items:center;text-align:center">
            <div>
              <div style="font-size:4rem;font-weight:700;color:var(--bronze)" id="specScore1">0</div>
              <div style="font-weight:600;margin-top:0.5rem;color:var(--text-primary)">ğŸ”´ Ã‰quipe 1</div>
              <div id="specTeam1" style="font-size:0.9rem;color:var(--text-tertiary);margin-top:0.5rem"></div>
            </div>
            <div style="font-size:2rem;color:var(--text-muted)">VS</div>
            <div>
              <div style="font-size:4rem;font-weight:700;color:var(--gold)" id="specScore2">0</div>
              <div style="font-weight:600;margin-top:0.5rem;color:var(--text-primary)">ğŸ”µ Ã‰quipe 2</div>
              <div id="specTeam2" style="font-size:0.9rem;color:var(--text-tertiary);margin-top:0.5rem"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ADMIN: ContrÃ´ler le match -->
    <div id="gameArea" style="display:none">
      <div class="card">
        <div class="card-header"><h3>Partie en cours</h3></div>
        <div class="card-body">
          <div style="display:grid;grid-template-columns:1fr auto 1fr;gap:2rem;align-items:center;text-align:center">
            <div>
              <div style="font-size:4rem;font-weight:700;color:var(--bronze)" id="score1">0</div>
              <div style="font-weight:600;margin-top:0.5rem">ğŸ”´ Ã‰quipe 1</div>
              <div id="team1Players" style="font-size:0.9rem;color:var(--text-tertiary);margin-top:0.5rem"></div>
              <button class="btn btn-primary" style="margin-top:1rem" onclick="addPoint('team1')">+1</button>
            </div>
            <div style="font-size:2rem;color:var(--text-muted)">VS</div>
            <div>
              <div style="font-size:4rem;font-weight:700;color:var(--gold)" id="score2">0</div>
              <div style="font-weight:600;margin-top:0.5rem">ğŸ”µ Ã‰quipe 2</div>
              <div id="team2Players" style="font-size:0.9rem;color:var(--text-tertiary);margin-top:0.5rem"></div>
              <button class="btn btn-primary" style="margin-top:1rem" onclick="addPoint('team2')">+1</button>
            </div>
          </div>
          <button class="btn" style="margin-top:2rem;background:#e74c3c;color:white" onclick="stopGame()">ğŸ›‘ ArrÃªter</button>
        </div>
      </div>
    </div>

    <!-- AUCUN MATCH -->
    <div id="noGameArea" style="display:none">
      <div class="card">
        <div class="card-body" style="text-align:center;padding:3rem 1rem">
          <div style="font-size:4rem;margin-bottom:1rem;opacity:0.3">âš½</div>
          <h2 style="color:var(--text-primary);margin-bottom:0.5rem">Aucun match en cours</h2>
          <p style="color:var(--text-tertiary);margin-bottom:2rem">Il n'y a pas de partie active</p>
          <a href="/dashboard" class="btn btn-primary">Retour</a>
        </div>
      </div>
    </div>

    <!-- POPUP REMATCH -->
    <div id="rematchPopup" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:9999;align-items:center;justify-content:center">
      <div style="background:var(--bg-elevated);padding:2rem;border-radius:12px;max-width:400px;text-align:center">
        <h2 style="color:var(--text-primary)">ğŸ”„ Rejouer ?</h2>
        <p style="color:var(--text-tertiary);margin:1rem 0">MÃªme Ã©quipes, nouvelle partie ?</p>
        <div style="display:flex;gap:1rem">
          <button class="btn btn-primary" style="flex:1" onclick="voteRematch('yes')">âœ… OUI</button>
          <button class="btn" style="flex:1;background:#e74c3c;color:white" onclick="voteRematch('no')">âŒ NON</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const socket = io();
let currentUser = null;
let isAdmin = false;
let canControl = false;

function toggleMenu() {
  document.getElementById("burger").classList.toggle("open");
  document.getElementById("mobileMenu").classList.toggle("open");
}

function logout() {
  fetch('/api/logout', {method: 'POST'}).then(() => location.href = '/');
}

async function loadUser() {
  const res = await fetch('/current_user');
  if (res.ok) {
    const user = await res.json();
    currentUser = user.username;
    isAdmin = user.is_admin;
    document.getElementById('navUsername').textContent = user.username;
    document.getElementById('navAv').textContent = user.username[0].toUpperCase();
    checkActiveGame();
  }
}

async function loadUsers() {
  const res = await fetch('/users_list');
  const users = await res.json();
  ['t1p1','t1p2','t2p1','t2p2'].forEach(id => {
    const sel = document.getElementById(id);
    users.forEach(u => {
      const opt = document.createElement('option');
      opt.value = u; opt.textContent = u;
      sel.appendChild(opt);
    });
  });
}

async function checkActiveGame() {
  const res = await fetch('/api/has_active_game');
  const data = await res.json();
  
  if (data.has_active_game) {
    const game = data.game_data;
    canControl = isAdmin || game.started_by === currentUser;
    
    if (canControl) {
      document.getElementById('setupArea').style.display = 'none';
      document.getElementById('gameArea').style.display = 'block';
      document.getElementById('spectatorArea').style.display = 'none';
      document.getElementById('noGameArea').style.display = 'none';
      updateGameUI(game);
    } else {
      document.getElementById('setupArea').style.display = 'none';
      document.getElementById('gameArea').style.display = 'none';
      document.getElementById('spectatorArea').style.display = 'block';
      document.getElementById('noGameArea').style.display = 'none';
      updateSpectatorUI(game);
    }
  } else {
    if (isAdmin) {
      document.getElementById('setupArea').style.display = 'block';
      document.getElementById('gameArea').style.display = 'none';
      document.getElementById('spectatorArea').style.display = 'none';
      document.getElementById('noGameArea').style.display = 'none';
      document.getElementById('pageSub').textContent = 'Configurer une nouvelle partie';
    } else {
      document.getElementById('setupArea').style.display = 'none';
      document.getElementById('gameArea').style.display = 'none';
      document.getElementById('spectatorArea').style.display = 'none';
      document.getElementById('noGameArea').style.display = 'block';
    }
  }
}

function updateGameUI(game) {
  document.getElementById('score1').textContent = game.team1_score;
  document.getElementById('score2').textContent = game.team2_score;
  document.getElementById('team1Players').textContent = game.team1_players.join(', ');
  document.getElementById('team2Players').textContent = game.team2_players.join(', ');
}

function updateSpectatorUI(game) {
  document.getElementById('specScore1').textContent = game.team1_score;
  document.getElementById('specScore2').textContent = game.team2_score;
  document.getElementById('specTeam1').textContent = game.team1_players.join(', ');
  document.getElementById('specTeam2').textContent = game.team2_players.join(', ');
}

function startGame() {
  const t1 = [document.getElementById('t1p1').value, document.getElementById('t1p2').value].filter(Boolean);
  const t2 = [document.getElementById('t2p1').value, document.getElementById('t2p2').value].filter(Boolean);
  if (t1.length === 0 || t2.length === 0) {
    alert('Il faut au moins 1 joueur par Ã©quipe');
    return;
  }
  socket.emit('start_game', {team1: t1, team2: t2});
}

function addPoint(team) {
  socket.emit('update_score', {team});
}

function stopGame() {
  if (confirm('ArrÃªter la partie ?')) {
    socket.emit('stop_game');
  }
}

function unlockServo() {
  socket.emit('unlock_servo');
}

function voteRematch(vote) {
  socket.emit('vote_rematch', {vote});
  document.getElementById('rematchPopup').style.display = 'none';
}

socket.on('game_started', (game) => {
  checkActiveGame();
});

socket.on('score_updated', (game) => {
  if (canControl) {
    updateGameUI(game);
  } else {
    updateSpectatorUI(game);
  }
});

socket.on('game_ended', (game) => {
  if (canControl) {
    updateGameUI(game);
  } else {
    updateSpectatorUI(game);
  }
});

socket.on('game_stopped', () => {
  location.href = '/dashboard';
});

socket.on('rematch_prompt', () => {
  if (canControl) {
    document.getElementById('rematchPopup').style.display = 'flex';
  }
});

socket.on('rematch_cancelled', () => {
  location.href = '/dashboard';
});

loadUser();
loadUsers();
</script>
</body>
</html>
